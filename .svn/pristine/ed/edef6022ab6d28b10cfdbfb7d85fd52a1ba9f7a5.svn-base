<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tk.oms.analysis.dao.SaleTargetDao">
	<sql id="user_where_hy">
	        and tui.user_type = 1
        <if test="ywjl_user_id != null and ywjl_user_id != ''">
			and tui.market_supervision_user_id = #{ywjl_user_id,jdbcType=INTEGER}
		</if>
		<if test="md_id != null and md_id != ''">
			and tui.store_id = #{md_id,jdbcType=INTEGER}
		</if>
		<if test="user_id != null and user_id != ''">
			and (tui.referee_user_id = #{user_id,jdbcType=INTEGER} or (tui.market_supervision_user_id = #{user_id,jdbcType=INTEGER} and tui.referee_user_id is null))
		</if>
		<if test="login_name != null and login_name != ''">
            and instr(tui.login_name, #{login_name,jdbcType=VARCHAR}) > 0
        </if>
        <if test="user_manage_name != null and user_manage_name != ''">
            and instr(tui.user_manage_name, #{user_manage_name,jdbcType=VARCHAR}) > 0
        </if>
        <if test="user_state != null and user_state != ''">
        	and tui.user_state in
        	<foreach collection="user_state" item="item" open="(" separator="," close=")">
        		#{item}
        	</foreach>
        </if>
        <if test="public_user_type != null and public_user_type == 9">
			 and exists(select 1 
                       from tbl_sys_user_info tsui1
                      where tsui1.user_type = 4
          				  and tsui1.organization_id in (
						  	select id from tbl_sys_organization_info where connect_by_isleaf=1
						  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
			              )
			          and tsui1.id = tui.market_supervision_user_id)
		</if>
    </sql>
	<!--查询业务员销售指标列表 -->
	<select id="queryYwySaleTargetList" parameterType="java.util.Map" resultType="java.util.Map">
		select * from (
		select b.*, rownum rn from (
				select 
					id,
					user_id,
					(select user_realname from tbl_sys_user_info where id=user_id)as ywy_user_realname,
					(select state from tbl_sys_user_info where id=user_id)as state,  
					(select sum(annual_target) from tbl_sale_targets_ywy where user_id=tsty.user_id) as total_annual_target,
					user_type, 
					year,
					case when (tsty.user_type=3 or tsty.user_type=6) then
                     		(select to_char(wm_concat(store_name)) from tbl_store_info where id in(select store_id from tbl_store_user_rel where user_id=tsty.user_id)) 
                      	 when tsty.user_type=4 then
                     		(select to_char(wm_concat(store_name)) from tbl_store_info where manager_user_id=tsty.user_id)
                         when tsty.user_type=5 then
                     		(select to_char(wm_concat(store_name)) from tbl_store_info where shopkeeper_user_id=tsty.user_id)
                     	 end as store_name,
                  	case when (tsty.user_type=3 or tsty.user_type=6) then
                     		(select to_char(wm_concat(user_realname)) from tbl_sys_user_info where id in (select manager_user_id from tbl_store_info where id in(select store_id from tbl_store_user_rel where user_id=tsty.user_id))) 
                     	 when tsty.user_type=4 then
                    		(select user_realname from tbl_sys_user_info where id=tsty.user_id)
                   		 when tsty.user_type=5 then
                  			(select to_char(wm_concat(user_realname)) from tbl_sys_user_info where id in (select manager_user_id from tbl_store_info where  SHOPKEEPER_USER_ID=tsty.user_id))
                     end as manager_user_realname, 
					annual_target,
					create_user_id,
					(select user_realname from tbl_sys_user_info where id=create_user_id)as create_user_realname,
					to_char(create_date, 'yyyy-mm-dd hh24:mi:ss') create_date,
					approval_user_id,
					(select user_realname from tbl_sys_user_info where id=approval_user_id)as approval_user_realname,
					to_char(approval_date, 'yyyy-mm-dd hh24:mi:ss') approval_date,
					approval_state,
					rejected_reason
				from tbl_sale_targets_ywy tsty
			<where>
				<if test="public_user_type != null and public_user_type == 3">
					and tsty.user_id=#{public_user_id,jdbcType=INTEGER}
				</if>
				<if test="public_user_type != null and public_user_type == 4">
					and (exists(select 1 from tbl_store_info where manager_user_id=#{public_user_id,jdbcType=INTEGER} and shopkeeper_user_id=tsty.user_id)	
		 					or exists(select 1 from tbl_store_info tsi, tbl_store_user_rel tsur where tsi.id=tsur.store_id
		 									and tsi.manager_user_id=#{public_user_id,jdbcType=INTEGER} and tsur.type=3 and tsur.user_id=tsty.user_id)
		 					or exists(select 1 from tbl_store_info tsi, tbl_store_user_rel tsur where tsi.id=tsur.store_id
		 									and tsi.manager_user_id=#{public_user_id,jdbcType=INTEGER} and tsur.type=6 and tsur.user_id=tsty.user_id))
				</if>
				<if test="public_user_type != null and public_user_type == 5">
					and tsty.user_id=#{public_user_id,jdbcType=INTEGER}
				</if>
				<if test="public_user_type != null and public_user_type == 6">
					and tsty.user_id=#{public_user_id,jdbcType=INTEGER}
				</if>
				<if test="public_user_type != null and public_user_type == 9">
					 and (exists(select 1 
                         from tbl_sys_user_info tsui1
                        where tsui1.user_type = 4
            				  and tsui1.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					          and tsui1.id = tsty.user_id)
					    or exists(select 1 from tbl_store_info tsi 
					    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
									select id from tbl_sys_organization_info where connect_by_isleaf=1
									start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
								)
								and b.user_type = 4
								and tsi.manager_user_id = b.id)
								and tsi.id = tsty.user_id)
						or exists(select 1 from tbl_store_info tsi 
					    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
									select id from tbl_sys_organization_info where connect_by_isleaf=1
									start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
								)
								and b.user_type = 4
								and tsi.manager_user_id = b.id)
								and tsi.shopkeeper_user_id = tsty.user_id)
						or exists (select 1 from tbl_store_user_rel tsur
						 	where exists (select 1 from tbl_store_info tsi 
									    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
													select id from tbl_sys_organization_info where connect_by_isleaf=1
													start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id )
												and b.user_type = 4
												and tsi.manager_user_id = b.id)
				                                and tsi.id =tsur.store_id)
				           and type in (3,6)
				           and tsur.user_id = tsty.user_id))
				</if>
				<if test="year !=null and year !=''">
					and tsty.year = #{year,jdbcType=INTEGER}
				</if>
				<if test="user_id !=null and user_id !=''">
					and tsty.user_id = #{user_id,jdbcType=INTEGER}
				</if>
				<if test="state !=null and state !=''">
					and exists(select 1 from tbl_sys_user_info where id=tsty.user_id and state in
						<foreach item="item" collection="state" open="(" separator="," close=")">
							#{item}
						</foreach>
					)
				</if>
				<if test="approval_state !=null and approval_state !=''">
					and approval_state in
						<foreach item="item" collection="approval_state" open="(" separator="," close=")">
							#{item}
						</foreach>
				</if>
				<if test="list !=null and list !=''">
					and id in
						<foreach item="item" collection="list" open="(" separator="," close=")">
							#{item}
						</foreach>
				</if>
			</where>
				order by approval_state,create_date desc
		) b where
		rownum &lt;= #{end_rownum})
		where rn &gt; #{start_rownum}
	</select>
	
	<!-- 查询业务员销售指标总数-->
    <select id="queryYwySaleTargetCount" parameterType="java.util.Map" resultType="int" >
		select count(1)
				from tbl_sale_targets_ywy tsty
			<where>
				<if test="public_user_type != null and public_user_type == 3">
					and tsty.user_id=#{public_user_id,jdbcType=INTEGER}
				</if>
				<if test="public_user_type != null and public_user_type == 4">
					and (exists(select 1 from tbl_store_info where manager_user_id=#{public_user_id,jdbcType=INTEGER} and shopkeeper_user_id=tsty.user_id)	
		 					or exists(select 1 from tbl_store_info tsi, tbl_store_user_rel tsur where tsi.id=tsur.store_id
		 									and tsi.manager_user_id=#{public_user_id,jdbcType=INTEGER} and tsur.type=3 and tsur.user_id=tsty.user_id)
		 					or exists(select 1 from tbl_store_info tsi, tbl_store_user_rel tsur where tsi.id=tsur.store_id
		 									and tsi.manager_user_id=#{public_user_id,jdbcType=INTEGER} and tsur.type=6 and tsur.user_id=tsty.user_id))
				</if>
				<if test="public_user_type != null and public_user_type == 5">
					and tsty.user_id=#{public_user_id,jdbcType=INTEGER}
				</if>
				<if test="public_user_type != null and public_user_type == 6">
					and tsty.user_id=#{public_user_id,jdbcType=INTEGER}
				</if>
				<if test="public_user_type != null and public_user_type == 9">
					 and (exists(select 1 
                         from tbl_sys_user_info tsui1
                        where tsui1.user_type = 4
            				  and tsui1.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					          and tsui1.id = tsty.user_id)
					    or exists(select 1 from tbl_store_info tsi 
					    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
									select id from tbl_sys_organization_info where connect_by_isleaf=1
									start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
								)
								and b.user_type = 4
								and tsi.manager_user_id = b.id)
								and tsi.id = tsty.user_id)
						or exists(select 1 from tbl_store_info tsi 
					    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
									select id from tbl_sys_organization_info where connect_by_isleaf=1
									start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
								)
								and b.user_type = 4
								and tsi.manager_user_id = b.id)
								and tsi.shopkeeper_user_id = tsty.user_id)
						or exists (select 1 from tbl_store_user_rel tsur
						 	where exists (select 1 from tbl_store_info tsi 
									    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
													select id from tbl_sys_organization_info where connect_by_isleaf=1
													start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id )
												and b.user_type = 4
												and tsi.manager_user_id = b.id)
				                                and tsi.id =tsur.store_id)
				           and type in (3,6)
				           and tsur.user_id = tsty.user_id))
				</if>
				<if test="user_id !=null and user_id !=''">
					and tsty.user_id = #{user_id,jdbcType=INTEGER}
				</if>
				<if test="year !=null and year !=''">
					and tsty.year = #{year,jdbcType=INTEGER}
				</if>
				<if test="state !=null and state !=''">
					and exists(select 1 from tbl_sys_user_info where id=tsty.user_id and state in
						<foreach item="item" collection="state" open="(" separator="," close=")">
							#{item}
						</foreach>
					)
				</if>
				<if test="approval_state !=null and approval_state !=''">
					and approval_state in
						<foreach item="item" collection="approval_state" open="(" separator="," close=")">
							#{item}
						</foreach>
				</if>
				<if test="list !=null and list !=''">
					and id in
						<foreach item="item" collection="list" open="(" separator="," close=")">
							#{item}
						</foreach>
				</if>
				
			</where>
    </select>
    
    <!-- 查询总销售指标 -->
	<select id="queryTotalAnnualTarget" parameterType="java.util.Map" resultType="java.util.Map">
	        select nvl(sum(annual_target),0) as total_annual_target from tbl_sale_targets_ywy tsty
	        <where>
				<if test="public_user_type != null and public_user_type == 3">
					and tsty.user_id=#{public_user_id,jdbcType=INTEGER}
				</if>
				<if test="public_user_type != null and public_user_type == 4">
					and (exists(select 1 from tbl_store_info where manager_user_id=#{public_user_id,jdbcType=INTEGER} and shopkeeper_user_id=tsty.user_id)	
		 					or exists(select 1 from tbl_store_info tsi, tbl_store_user_rel tsur where tsi.id=tsur.store_id
		 									and tsi.manager_user_id=#{public_user_id,jdbcType=INTEGER} and tsur.type=3 and tsur.user_id=tsty.user_id)
		 					or exists(select 1 from tbl_store_info tsi, tbl_store_user_rel tsur where tsi.id=tsur.store_id
		 									and tsi.manager_user_id=#{public_user_id,jdbcType=INTEGER} and tsur.type=6 and tsur.user_id=tsty.user_id))
				</if>
				<if test="public_user_type != null and public_user_type == 5">
					and tsty.user_id=#{public_user_id,jdbcType=INTEGER}
				</if>
				<if test="public_user_type != null and public_user_type == 6">
					and tsty.user_id=#{public_user_id,jdbcType=INTEGER}
				</if>
				<if test="public_user_type != null and public_user_type == 9">
					 and (exists(select 1 
                         from tbl_sys_user_info tsui1
                        where tsui1.user_type = 4
            				  and tsui1.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					          and tsui1.id = tsty.user_id)
					    or exists(select 1 from tbl_store_info tsi 
					    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
									select id from tbl_sys_organization_info where connect_by_isleaf=1
									start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
								)
								and b.user_type = 4
								and tsi.manager_user_id = b.id)
								and tsi.id = tsty.user_id)
						or exists(select 1 from tbl_store_info tsi 
					    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
									select id from tbl_sys_organization_info where connect_by_isleaf=1
									start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
								)
								and b.user_type = 4
								and tsi.manager_user_id = b.id)
								and tsi.shopkeeper_user_id = tsty.user_id)
						or exists (select 1 from tbl_store_user_rel tsur
						 	where exists (select 1 from tbl_store_info tsi 
									    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
													select id from tbl_sys_organization_info where connect_by_isleaf=1
													start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id )
												and b.user_type = 4
												and tsi.manager_user_id = b.id)
				                                and tsi.id =tsur.store_id)
				           and type in (3,6)
				           and tsur.user_id = tsty.user_id))
				</if>
				<if test="user_id !=null and user_id !=''">
					and tsty.user_id = #{user_id,jdbcType=INTEGER}
				</if>
				<if test="year !=null and year !=''">
					and tsty.year = #{year,jdbcType=INTEGER}
				</if>
				<if test="state !=null and state !=''">
					and exists(select 1 from tbl_sys_user_info where id=tsty.user_id and state in
						<foreach item="item" collection="state" open="(" separator="," close=")">
							#{item}
						</foreach>
					)
				</if>
				<if test="approval_state !=null and approval_state !=''">
					and approval_state in
						<foreach item="item" collection="approval_state" open="(" separator="," close=")">
							#{item}
						</foreach>
				</if>
				<if test="list !=null and list !=''">
					and id in
						<foreach item="item" collection="list" open="(" separator="," close=")">
							#{item}
						</foreach>
				</if>
				
			</where>
	</select>
	
	<!-- 查询会员销售总指标-->
	<select id="queryHyTotalAnnualTarget" parameterType="java.util.Map" resultType="java.util.Map">
	        select nvl(sum(annual_target),0) as total_annual_target from tbl_sale_targets_hy tsth
	        <where>
			    <if test="ywjl_user_id !=null and ywjl_user_id !=''">
					and exists (select 1 from tbl_user_info where id = tsth.user_id and market_supervision_user_id = #{ywjl_user_id,jdbcType=INTEGER})
				</if>
				<if test="store_id !=null and store_id !=''">
					and exists (select 1 from tbl_user_info where id = tsth.user_id and store_id = #{store_id,jdbcType=INTEGER})
				</if>
				<if test="user_id !=null and user_id !=''">
					and tsth.sys_user_id=#{user_id,jdbcType=INTEGER}
				</if>
				<if test="login_name !=null and login_name !=''">
					and exists (select 1 from tbl_user_info where id = tsth.user_id and login_name like concat(concat('%', #{login_name,jdbcType=VARCHAR}),'%'))
				</if>
				<if test="user_manage_name !=null and user_manage_name !=''">
					and exists (select 1 from tbl_user_info where id = tsth.user_id and login_name like concat(concat('%', #{user_manage_name,jdbcType=VARCHAR}),'%'))
				</if>
				<if test="user_state !=null and user_state !=''">
					and exists(select 1 from tbl_user_info where id=tsth.user_id and 
								user_state in
									<foreach item="item" collection="user_state" open="(" separator="," close=")">
										#{item}
									</foreach>)
				</if>
				<if test="approval_state !=null and approval_state !=''">
					and approval_state in
						<foreach item="item" collection="approval_state" open="(" separator="," close=")">
							#{item}
						</foreach>
				</if>
				<if test="year !=null and year !=''">
					and tsth.year=#{year,jdbcType=INTEGER}
				</if>
				<if test="public_user_type != null and public_user_type == 3">
		            and exists(select 1 from tbl_user_info 
		            			where referee_user_id = #{public_user_id,jdbcType=INTEGER}
		            			and id=tsth.user_id)
		        </if>
		        <if test="public_user_type != null and public_user_type == 4">
		        	and exists(select 1 from tbl_user_info 
		            			where market_supervision_user_id = #{public_user_id,jdbcType=INTEGER}
		            			and id=tsth.user_id)
		        </if>
		        <if test="public_user_type != null and public_user_type == 5">
		        	and exists(select 1 from tbl_user_info tui
		        					where id=tsth.user_id 
		        						and exists(select 1 from tbl_store_info tsi 
		        									where tsi.id=tui.store_id 
		        										and tsi.shopkeeper_user_id = #{public_user_id,jdbcType=INTEGER})
		        				)
		        </if>
		        <if test="public_user_type != null and public_user_type == 6">
		        	and exists(select 1 from tbl_user_info tui where id=tsth.user_id
		        					and exists(select 1 from tbl_store_user_rel tsur where tui.store_id=tsur.store_id
		        					and tsur.user_id = #{public_user_id,jdbcType=INTEGER}))
		        </if>
		        <if test="public_user_type != null and public_user_type == 9">
		        	and exists(select 1 from tbl_user_info tui where id=tsth.user_id
	        				and (exists(select 1 
	                         from tbl_sys_user_info tsui1
	                        where tsui1.user_type = 4
	            				  and tsui1.organization_id in (
									  	select id from tbl_sys_organization_info where connect_by_isleaf=1
									  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
						              )
						          and tsui1.id = tui.market_supervision_user_id)
						    or exists(select 1 from tbl_store_info tsi 
						    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
										select id from tbl_sys_organization_info where connect_by_isleaf=1
										start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
									)
									and b.user_type = 4
									and tsi.manager_user_id = b.id)
									and tsi.id = tui.market_supervision_user_id)
							or exists(select 1 from tbl_store_info tsi 
						    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
										select id from tbl_sys_organization_info where connect_by_isleaf=1
										start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
									)
									and b.user_type = 4
									and tsi.manager_user_id = b.id)
									and tsi.shopkeeper_user_id = tui.market_supervision_user_id)
							or exists (select 1 from tbl_store_user_rel tsur
							 	where exists (select 1 from tbl_store_info tsi 
										    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
														select id from tbl_sys_organization_info where connect_by_isleaf=1
														start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id )
													and b.user_type = 4
													and tsi.manager_user_id = b.id)
					                                and tsi.id =tsur.store_id)
					           and type in (3,6)
					           and tsur.user_id = tui.market_supervision_user_id)))
		        </if>
			</where>
	</select>
	
	<!--查询会员销售指标列表 -->
	<select id="queryHySaleTargetList" parameterType="java.util.Map" resultType="java.util.Map">
		select * from (
			select b.*,
				 (select user_realname from tbl_sys_user_info where id=(select market_supervision_user_id from tbl_user_info where id=b.user_id)) as market_supervision_user_realna,
	             (select store_name from tbl_store_info where id=(select store_id from tbl_user_info where id=b.user_id)) as store_name,
	             (select user_realname from tbl_sys_user_info where id=b.sys_user_id) as user_realname,
	             (select user_type from tbl_sys_user_info where id=b.sys_user_id) as user_type,
				 (select login_name from tbl_user_info where id=b.user_id) as login_name,
				 (select user_manage_name from tbl_user_info where id=b.user_id) as user_manage_name,
				 (select user_state from tbl_user_info where id=b.user_id) as user_state,
				 (select user_realname from tbl_sys_user_info where id=b.create_user_id) create_user_name,
				 (select user_realname from tbl_sys_user_info where id=b.approval_user_id) approval_user_name,
				 rownum rn from (
					select 
						id,
						user_id,
						sys_user_id,
						year,
						annual_target,
						create_user_id,
						to_char(create_date, 'yyyy-mm-dd hh24:mi:ss') create_date,
						approval_user_id, 
						to_char(approval_date, 'yyyy-mm-dd hh24:mi:ss') approval_date, 
						approval_state, 
						rejected_reason
					from tbl_sale_targets_hy tsth
					<where>
					    <if test="ywjl_user_id !=null and ywjl_user_id !=''">
							and exists (select 1 from tbl_user_info where id = tsth.user_id and market_supervision_user_id = #{ywjl_user_id,jdbcType=INTEGER})
						</if>
						<if test="store_id !=null and store_id !=''">
							and exists (select 1 from tbl_user_info where id = tsth.user_id and store_id = #{store_id,jdbcType=INTEGER})
						</if>
						<if test="user_id !=null and user_id !=''">
							and tsth.sys_user_id=#{user_id,jdbcType=INTEGER}
						</if>
						<if test="login_name !=null and login_name !=''">
							and exists (select 1 from tbl_user_info where id = tsth.user_id and login_name like concat(concat('%', #{login_name,jdbcType=VARCHAR}),'%'))
						</if>
						<if test="user_manage_name !=null and user_manage_name !=''">
							and exists (select 1 from tbl_user_info where id = tsth.user_id and login_name like concat(concat('%', #{user_manage_name,jdbcType=VARCHAR}),'%'))
						</if>
						<if test="user_state !=null and user_state !=''">
							and exists(select 1 from tbl_user_info where id=tsth.user_id and 
										user_state in
											<foreach item="item" collection="user_state" open="(" separator="," close=")">
												#{item}
											</foreach>)
						</if>
						<if test="approval_state !=null and approval_state !=''">
							and approval_state in
								<foreach item="item" collection="approval_state" open="(" separator="," close=")">
									#{item}
								</foreach>
						</if>
						<if test="year !=null and year !=''">
							and tsth.year=#{year,jdbcType=INTEGER}
						</if>
				        <if test="public_user_type != null and public_user_type == 3">
				            and exists(select 1 from tbl_user_info 
				            			where referee_user_id = #{public_user_id,jdbcType=INTEGER}
				            			and id=tsth.user_id)
				        </if>
				        <if test="public_user_type != null and public_user_type == 4">
				        	and exists(select 1 from tbl_user_info 
				            			where market_supervision_user_id = #{public_user_id,jdbcType=INTEGER}
				            			and id=tsth.user_id)
				        </if>
				        <if test="public_user_type != null and public_user_type == 5">
				        	and exists(select 1 from tbl_user_info tui
				        					where id=tsth.user_id 
				        						and exists(select 1 from tbl_store_info tsi 
				        									where tsi.id=tui.store_id 
				        										and tsi.shopkeeper_user_id = #{public_user_id,jdbcType=INTEGER})
				        				)
				        </if>
				        <if test="public_user_type != null and public_user_type == 6">
				        	and exists(select 1 from tbl_user_info tui where id=tsth.user_id
				        					and exists(select 1 from tbl_store_user_rel tsur where tui.store_id=tsur.store_id
				        					and tsur.user_id = #{public_user_id,jdbcType=INTEGER}))
				        </if>
				        <if test="public_user_type != null and public_user_type == 9">
				        	and exists(select 1 from tbl_user_info tui where id=tsth.user_id
	        				and (exists(select 1 
	                         from tbl_sys_user_info tsui1
	                        where tsui1.user_type = 4
	            				  and tsui1.organization_id in (
									  	select id from tbl_sys_organization_info where connect_by_isleaf=1
									  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
						              )
						          and tsui1.id = tui.market_supervision_user_id)
						    or exists(select 1 from tbl_store_info tsi 
						    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
										select id from tbl_sys_organization_info where connect_by_isleaf=1
										start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
									)
									and b.user_type = 4
									and tsi.manager_user_id = b.id)
									and tsi.id = tui.market_supervision_user_id)
							or exists(select 1 from tbl_store_info tsi 
						    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
										select id from tbl_sys_organization_info where connect_by_isleaf=1
										start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
									)
									and b.user_type = 4
									and tsi.manager_user_id = b.id)
									and tsi.shopkeeper_user_id = tui.market_supervision_user_id)
							or exists (select 1 from tbl_store_user_rel tsur
							 	where exists (select 1 from tbl_store_info tsi 
										    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
														select id from tbl_sys_organization_info where connect_by_isleaf=1
														start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id )
													and b.user_type = 4
													and tsi.manager_user_id = b.id)
					                                and tsi.id =tsur.store_id)
					           and type in (3,6)
					           and tsur.user_id = tui.market_supervision_user_id)))
				        </if>
					</where>
					order by tsth.create_date desc
			) b where
			rownum &lt;= #{end_rownum})
		where rn &gt; #{start_rownum}
	</select>
	
	<!-- 查询会员销售指标总数-->
    <select id="queryHySaleTargetCount" parameterType="java.util.Map" resultType="int" >
		select count(1)
			from tbl_sale_targets_hy tsth
		<where>
		    <if test="ywjl_user_id !=null and ywjl_user_id !=''">
				and exists (select 1 from tbl_user_info where id = tsth.user_id and market_supervision_user_id = #{ywjl_user_id,jdbcType=INTEGER})
			</if>
			<if test="store_id !=null and store_id !=''">
				and exists (select 1 from tbl_user_info where id = tsth.user_id and store_id = #{store_id,jdbcType=INTEGER})
			</if>
			<if test="user_id !=null and user_id !=''">
				and tsth.sys_user_id=#{user_id,jdbcType=INTEGER}
			</if>
			<if test="login_name !=null and login_name !=''">
				and exists (select 1 from tbl_user_info where id = tsth.user_id and login_name like concat(concat('%', #{login_name,jdbcType=VARCHAR}),'%'))
			</if>
			<if test="user_manage_name !=null and user_manage_name !=''">
				and exists (select 1 from tbl_user_info where id = tsth.user_id and login_name like concat(concat('%', #{user_manage_name,jdbcType=VARCHAR}),'%'))
			</if>
			<if test="user_state !=null and user_state !=''">
				and exists(select 1 from tbl_user_info where id=tsth.user_id and 
							user_state in
								<foreach item="item" collection="user_state" open="(" separator="," close=")">
									#{item}
								</foreach>)
			</if>
			<if test="approval_state !=null and approval_state !=''">
				and approval_state in
					<foreach item="item" collection="approval_state" open="(" separator="," close=")">
						#{item}
					</foreach>
			</if>
			<if test="year !=null and year !=''">
				and tsth.year=#{year,jdbcType=INTEGER}
			</if>
			<if test="public_user_type != null and public_user_type == 3">
	            and exists(select 1 from tbl_user_info 
	            			where referee_user_id = #{public_user_id,jdbcType=INTEGER}
	            			and id=tsth.user_id)
	        </if>
	        <if test="public_user_type != null and public_user_type == 4">
	        	and exists(select 1 from tbl_user_info 
	            			where market_supervision_user_id = #{public_user_id,jdbcType=INTEGER}
	            			and id=tsth.user_id)
	        </if>
	        <if test="public_user_type != null and public_user_type == 5">
	        	and exists(select 1 from tbl_user_info tui
	        					where id=tsth.user_id 
	        						and exists(select 1 from tbl_store_info tsi 
	        									where tsi.id=tui.store_id 
	        										and tsi.shopkeeper_user_id = #{public_user_id,jdbcType=INTEGER})
	        				)
	        </if>
	        <if test="public_user_type != null and public_user_type == 6">
	        	and exists(select 1 from tbl_user_info tui where id=tsth.user_id
	        					and exists(select 1 from tbl_store_user_rel tsur where tui.store_id=tsur.store_id
	        					and tsur.user_id = #{public_user_id,jdbcType=INTEGER}))
	        </if>
	        <if test="public_user_type != null and public_user_type == 9">
	        	and exists(select 1 from tbl_user_info tui where id=tsth.user_id
	        				and (exists(select 1 
	                         from tbl_sys_user_info tsui1
	                        where tsui1.user_type = 4
	            				  and tsui1.organization_id in (
									  	select id from tbl_sys_organization_info where connect_by_isleaf=1
									  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
						              )
						          and tsui1.id = tui.market_supervision_user_id)
						    or exists(select 1 from tbl_store_info tsi 
						    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
										select id from tbl_sys_organization_info where connect_by_isleaf=1
										start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
									)
									and b.user_type = 4
									and tsi.manager_user_id = b.id)
									and tsi.id = tui.market_supervision_user_id)
							or exists(select 1 from tbl_store_info tsi 
						    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
										select id from tbl_sys_organization_info where connect_by_isleaf=1
										start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
									)
									and b.user_type = 4
									and tsi.manager_user_id = b.id)
									and tsi.shopkeeper_user_id = tui.market_supervision_user_id)
							or exists (select 1 from tbl_store_user_rel tsur
							 	where exists (select 1 from tbl_store_info tsi 
										    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
														select id from tbl_sys_organization_info where connect_by_isleaf=1
														start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id )
													and b.user_type = 4
													and tsi.manager_user_id = b.id)
					                                and tsi.id =tsur.store_id)
					           and type in (3,6)
					           and tsur.user_id = tui.market_supervision_user_id)))
	        </if>
		</where>
    </select>
    
    <!--查询业务员列表 -->
	<select id="queryUserTypeList" parameterType="java.util.Map" resultType="java.util.Map">
		select * from (
			select b.*,
				 rownum rn from (
				 	select tsui.*,
				 		 case when (tsui.user_type=3 or tsui.user_type=6) then
                             	(select to_char(wm_concat(store_name)) from tbl_store_info where id in(select store_id from tbl_store_user_rel where user_id=tsui.id)) 
                              when tsui.user_type=4 then
                             	(select to_char(wm_concat(store_name)) from tbl_store_info where manager_user_id=tsui.id)
                              when tsui.user_type=5 then
                             	(select to_char(wm_concat(store_name)) from tbl_store_info where shopkeeper_user_id=tsui.id)
                             end as store_name,
                          case when (tsui.user_type=3 or tsui.user_type=6) then
                             	(select to_char(wm_concat(user_realname)) from tbl_sys_user_info where id in (select manager_user_id from tbl_store_info where id in(select store_id from tbl_store_user_rel where user_id=tsui.id))) 
                             when tsui.user_type=4 then
                            	(select user_realname from tbl_sys_user_info where id=tsui.id)
                           when tsui.user_type=5 then
                          		(select to_char(wm_concat(user_realname)) from tbl_sys_user_info where id in (select manager_user_id from tbl_store_info where  SHOPKEEPER_USER_ID=tsui.id))
                             end as manager_user_realname,
				 		nvl((select annual_target from tbl_sale_targets_ywy where user_id=tsui.id and year=extract(year from sysdate)-1),0) last_year_target
				 	 from tbl_sys_user_info tsui 
				 		where user_type in(3,4,5,6) and state='2'
				 		<if test="user_name !=null and user_name !=''">
						  	and tsui.user_name like concat(concat('%', #{user_name,jdbcType=VARCHAR}),'%')
					  	</if>
					    <if test="user_realname !=null and user_realname !=''">
						    and tsui.user_realname like concat(concat('%', #{user_realname,jdbcType=VARCHAR}),'%')
					    </if>
					    <if test="user_type !=null and user_type !=''">
						    and tsui.user_type=#{user_type,jdbcType=INTEGER}
					    </if>
					    <if test="phone !=null and phone !=''">
						    and tsui.phone =#{phone,jdbcType=VARCHAR}
					    </if>
					    <if test="ywy_id !=null and ywy_id !=''">
						    and tsui.id not in 
						    <foreach item="item" collection="ywy_id" open="(" separator="," close=")">
								#{item}
							</foreach>
					    </if>
				 		<if test="public_user_type != null and public_user_type == 3">
							and id=#{public_user_id,jdbcType=INTEGER}
						</if>
						<if test="public_user_type != null and public_user_type == 4">
							and (exists(select 1 from tbl_store_info where manager_user_id=#{public_user_id,jdbcType=INTEGER} and shopkeeper_user_id=tsui.id)	
				 					or exists(select 1 from tbl_store_info tsi, tbl_store_user_rel tsur where tsi.id=tsur.store_id
				 									and tsi.manager_user_id=#{public_user_id,jdbcType=INTEGER} and tsur.type=3 and tsur.user_id=tsui.id)
				 					or exists(select 1 from tbl_store_info tsi, tbl_store_user_rel tsur where tsi.id=tsur.store_id
				 									and tsi.manager_user_id=#{public_user_id,jdbcType=INTEGER} and tsur.type=6 and tsur.user_id=tsui.id)
				 		 			or tsui.id=#{public_user_id,jdbcType=INTEGER})
						</if>
						<if test="public_user_type != null and public_user_type == 5">
							and id=#{public_user_id,jdbcType=INTEGER}
						</if>
						<if test="public_user_type != null and public_user_type == 6">
							and id=#{public_user_id,jdbcType=INTEGER}
						</if>
						<if test="public_user_type != null and public_user_type == 9">
							 and (exists(select 1 
		                         from tbl_sys_user_info tsui1
		                        where tsui1.user_type = 4
		            				  and tsui1.organization_id in (
										  	select id from tbl_sys_organization_info where connect_by_isleaf=1
										  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
							              )
							          and tsui1.id = tsui.id)
							    or exists(select 1 from tbl_store_info tsi 
							    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
											select id from tbl_sys_organization_info where connect_by_isleaf=1
											start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
										)
										and b.user_type = 4
										and tsi.manager_user_id = b.id)
										and tsi.id = tsui.id)
								or exists(select 1 from tbl_store_info tsi 
							    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
											select id from tbl_sys_organization_info where connect_by_isleaf=1
											start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
										)
										and b.user_type = 4
										and tsi.manager_user_id = b.id)
										and tsi.shopkeeper_user_id = tsui.id)	
			 					or exists (select 1 from tbl_store_user_rel tsur
								 	where exists (select 1 from tbl_store_info tsi 
											    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
															select id from tbl_sys_organization_info where connect_by_isleaf=1
															start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id )
														and b.user_type = 4
														and tsi.manager_user_id = b.id)
						                                and tsi.id =tsur.store_id)
						           and type in (3,6)
						           and tsur.user_id = tsui.id))
						</if>
						and not exists(select 1 from tbl_sale_targets_ywy where user_id=tsui.id and year=#{year,jdbcType=INTEGER})
						order by user_type
			) b where rownum &lt;= #{end_rownum})
		where rn &gt; #{start_rownum}
	</select>
	
	<!--查询业务员列表总数 -->
	<select id="queryUserTypeCount" parameterType="java.util.Map" resultType="int">
		select count(1) from tbl_sys_user_info tsui 
	 		where user_type in(3,4,5,6) and state='2'
	 		<if test="user_name !=null and user_name !=''">
			  	and tsui.user_name like concat(concat('%', #{user_name,jdbcType=VARCHAR}),'%')
		  	</if>
		    <if test="user_realname !=null and user_realname !=''">
			    and tsui.user_realname like concat(concat('%', #{user_realname,jdbcType=VARCHAR}),'%')
		    </if>
		    <if test="user_type !=null and user_type !=''">
			    and tsui.user_type=#{user_type,jdbcType=INTEGER}
		    </if>
		    <if test="phone !=null and phone !=''">
			    and tsui.phone =#{phone,jdbcType=VARCHAR}
		    </if>
		    <if test="ywy_id !=null and ywy_id !=''">
			    and tsui.id not in 
			    <foreach item="item" collection="ywy_id" open="(" separator="," close=")">
					#{item}
				</foreach>
		    </if>
	 		<if test="public_user_type != null and public_user_type == 3">
				and id=#{public_user_id,jdbcType=INTEGER}
			</if>
			<if test="public_user_type != null and public_user_type == 4">
				and (exists(select 1 from tbl_store_info where manager_user_id=#{public_user_id,jdbcType=INTEGER} and shopkeeper_user_id=tsui.id)	
	 					or exists(select 1 from tbl_store_info tsi, tbl_store_user_rel tsur where tsi.id=tsur.store_id
	 									and tsi.manager_user_id=#{public_user_id,jdbcType=INTEGER} and tsur.type=3 and tsur.user_id=tsui.id)
	 					or exists(select 1 from tbl_store_info tsi, tbl_store_user_rel tsur where tsi.id=tsur.store_id
	 									and tsi.manager_user_id=#{public_user_id,jdbcType=INTEGER} and tsur.type=6 and tsur.user_id=tsui.id)
	 					or tsui.id=#{public_user_id,jdbcType=INTEGER})
			</if>
			<if test="public_user_type != null and public_user_type == 5">
				and id=#{public_user_id,jdbcType=INTEGER}
			</if>
			<if test="public_user_type != null and public_user_type == 6">
				and id=#{public_user_id,jdbcType=INTEGER}
			</if>
			<if test="public_user_type != null and public_user_type == 9">
				 and (exists(select 1 
                         from tbl_sys_user_info tsui1
                        where tsui1.user_type = 4
            				  and tsui1.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					          and tsui1.id = tsui.id)
					    or exists(select 1 from tbl_store_info tsi 
					    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
									select id from tbl_sys_organization_info where connect_by_isleaf=1
									start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
								)
								and b.user_type = 4
								and tsi.manager_user_id = b.id)
								and tsi.id = tsui.id)
						or exists(select 1 from tbl_store_info tsi 
					    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
									select id from tbl_sys_organization_info where connect_by_isleaf=1
									start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
								)
								and b.user_type = 4
								and tsi.manager_user_id = b.id)
								and tsi.shopkeeper_user_id = tsui.id)		
	 					or exists (select 1 from tbl_store_user_rel tsur
						 	where exists (select 1 from tbl_store_info tsi 
									    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
													select id from tbl_sys_organization_info where connect_by_isleaf=1
													start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id )
												and b.user_type = 4
												and tsi.manager_user_id = b.id)
				                                and tsi.id =tsur.store_id)
				           and type in (3,6)
				           and tsur.user_id = tsui.id))
			</if>
			and not exists(select 1 from tbl_sale_targets_ywy where user_id=tsui.id and year=#{year,jdbcType=INTEGER})
	</select>
	<!-- 新增业务员销售指标主表信息 -->
	<insert id="insertSaleTargetYwy" parameterType="java.util.Map">
		<selectKey keyProperty="id" resultType="int" order="BEFORE">
            select SEQ_SALE_TARGETS_YWY.NEXTVAL from dual
        </selectKey>
		INSERT INTO TBL_SALE_TARGETS_YWY(
			ID,
			USER_ID,
			USER_TYPE,
			YEAR,
			ANNUAL_TARGET,
			CREATE_USER_ID,
			CREATE_DATE,
			APPROVAL_STATE
		) values(
			#{id,jdbcType=INTEGER},
			#{ID,jdbcType=INTEGER},
			#{USER_TYPE,jdbcType=INTEGER},
			#{YEAR,jdbcType=INTEGER},
			#{ANNUAL_TARGET,jdbcType=INTEGER},
			#{CREATE_USER_ID,jdbcType=INTEGER},
			sysdate,
			1
		)
	</insert>
	<!-- 新增业务员销售指标详表信息 -->
	<insert id="insertSaleTargetYwyDetail" parameterType="java.util.Map">
		INSERT INTO TBL_SALE_TARGETS_YWY_DETAIL(
			ID,
			SALE_TARGET_YWY_ID,
			MONTH_TYPE,
			MONTH_VALUE,
			APPROVAL_STATE
		) SELECT SEQ_SALE_TARGETS_YWY_DETAIL.NEXTVAL,
              	 SALE_TARGET_YWY_ID,
                 MONTH_TYPE,
                 MONTH_VALUE,
                 APPROVAL_STATE
          FROM (
		        <foreach collection="list" item="item" index="index" separator="UNION">
		            SELECT  #{item.sale_target_ywy_id,jdbcType=INTEGER} AS SALE_TARGET_YWY_ID,
		            		#{item.month_type,jdbcType=INTEGER} AS MONTH_TYPE,
		            		#{item.month_value,jdbcType=INTEGER} AS MONTH_VALUE,
		            		#{item.approval_state,jdbcType=INTEGER} AS APPROVAL_STATE
		            FROM DUAL
		        </foreach>
        	   )
	</insert>
	<!--业务员销售指标详情(支持单个和批量查看)-->
	<select id="queryYwySaleTargetDetail" parameterType="java.util.Map" resultType="java.util.Map">
		select 
			id,
			(select state from tbl_sys_user_info where id=user_id) as state,
			user_id, 
			(select user_realname from tbl_sys_user_info where id=user_id)as ywy_user_realname,
			nvl((select annual_target from tbl_sale_targets_ywy where user_id=tsty.user_id and year=extract(year from sysdate)-1),0) last_year_target,
			year, 
			case when (tsty.user_type=3 or tsty.user_type=6) then
             		(select to_char(wm_concat(store_name)) from tbl_store_info where id in(select store_id from tbl_store_user_rel where user_id=tsty.user_id)) 
              	 when tsty.user_type=4 then
             		(select to_char(wm_concat(store_name)) from tbl_store_info where manager_user_id=tsty.user_id)
                 when tsty.user_type=5 then
             		(select to_char(wm_concat(store_name)) from tbl_store_info where shopkeeper_user_id=tsty.user_id)
             	 end as store_name,
          	case when (tsty.user_type=3 or tsty.user_type=6) then
             		(select to_char(wm_concat(user_realname)) from tbl_sys_user_info where id in (select manager_user_id from tbl_store_info where id in(select store_id from tbl_store_user_rel where user_id=tsty.user_id))) 
             	 when tsty.user_type=4 then
            		(select user_realname from tbl_sys_user_info where id=tsty.user_id)
           		 when tsty.user_type=5 then
          			(select to_char(wm_concat(user_realname)) from tbl_sys_user_info where id in (select manager_user_id from tbl_store_info where  SHOPKEEPER_USER_ID=tsty.user_id))
             end as manager_user_realname, 
			annual_target,
			create_user_id,
			(select user_realname from tbl_sys_user_info where id=create_user_id)as create_user_realname,
			to_char(create_date, 'yyyy-mm-dd hh24:mi:ss') create_date,
			approval_user_id,
			to_char(approval_date, 'yyyy-mm-dd hh24:mi:ss') approval_date,
			approval_state,
			rejected_reason
		from tbl_sale_targets_ywy tsty
		<where>
			<if test="sale_target_id !=null and sale_target_id !=''">
				and tsty.id in
				<foreach item="item" collection="sale_target_id" open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
		</where>
	</select>
	<!--业务员销售指标详情(获取每月设置的月度指标)-->
	<select id="queryYwySaleTargetDetailList" parameterType="java.util.Map" resultType="java.util.Map">
		select id,
			sale_target_ywy_id,
			month_type,
			month_value,
			approval_state as detail_approval_state 
		from tbl_sale_targets_ywy_detail 
			where sale_target_ywy_id=#{sale_target_id,jdbcType=INTEGER}
		order by month_type
	</select>
	<!--查询销售人员指标信息-->
	<select id="querySaleTargetsYwyInfo" parameterType="java.util.Map" resultType="java.util.Map">
		select id,(select max(approval_state) from tbl_sale_targets_ywy_detail 
				where sale_target_ywy_id=#{sale_target_id,jdbcType=INTEGER}) as max_approval_state 
		 from tbl_sale_targets_ywy where id=#{sale_target_id,jdbcType=INTEGER}
	</select>
	<!--查询会员销售指标信息-->
	<select id="querySaleTargetsHyInfo" parameterType="java.util.Map" resultType="java.util.Map">
		select id,(select max(approval_state) from tbl_sale_targets_hy_detail 
				where SALE_TARGET_HY_ID=#{sale_target_hy_id,jdbcType=INTEGER}) as max_approval_state 
		from tbl_sale_targets_hy where id=#{sale_target_hy_id,jdbcType=INTEGER}
	</select>
	<!--编辑业务员销售指标主表信息-->
    <update id="updateSaleTargetYwy" parameterType="java.util.Map">
        UPDATE
            TBL_SALE_TARGETS_YWY
        <set>
            <if test="ANNUAL_TARGET != null and ANNUAL_TARGET != ''">
                ANNUAL_TARGET = #{ANNUAL_TARGET,jdbcType=INTEGER},
            </if>
            <if test="YEAR != null and YEAR != ''">
                YEAR = #{YEAR,jdbcType=INTEGER},
            </if>
            APPROVAL_USER_ID='',
        	APPROVAL_DATE='',
        	APPROVAL_STATE=1,
        	REJECTED_REASON=''
        </set>
        where
            ID = #{ID,jdbcType=INTEGER}
    </update>
    <!-- 删除业务员销售指标详表信息-->
    <delete id="deleteSaleTargetYwyDetail" parameterType="java.util.Map">
        delete from tbl_sale_targets_ywy_detail
        where sale_target_ywy_id = #{sale_target_id,jdbcType=INTEGER}
    </delete>
	<!--查询已设置用户指标的列表数据-->
	<select id="queryUserTypeOption" parameterType="java.util.Map" resultMap="userTypeOption">
		select user_id,(select user_realname from tbl_sys_user_info where id=user_id) as ywy_user_realname
        from tbl_sale_targets_ywy tsty
        <where>
	        <if test="public_user_type != null and public_user_type == 3">
				and user_id=#{public_user_id,jdbcType=INTEGER}
			</if>
			<if test="public_user_type != null and public_user_type == 4">
				and (exists(select 1 from tbl_store_info where manager_user_id=#{public_user_id,jdbcType=INTEGER} and shopkeeper_user_id=tsty.user_id)	
	 					or exists(select 1 from tbl_store_info tsi, tbl_store_user_rel tsur where tsi.id=tsur.store_id
	 									and tsi.manager_user_id=#{public_user_id,jdbcType=INTEGER} and tsur.type=3 and tsur.user_id=tsty.user_id)
	 					or exists(select 1 from tbl_store_info tsi, tbl_store_user_rel tsur where tsi.id=tsur.store_id
	 									and tsi.manager_user_id=#{public_user_id,jdbcType=INTEGER} and tsur.type=6 and tsur.user_id=tsty.user_id)
	 					or tsty.user_id=#{public_user_id,jdbcType=INTEGER})
			</if>
			<if test="public_user_type != null and public_user_type == 5">
				and user_id=#{public_user_id,jdbcType=INTEGER}
			</if>
			<if test="public_user_type != null and public_user_type == 6">
				and user_id=#{public_user_id,jdbcType=INTEGER}
			</if>
			<if test="public_user_type != null and public_user_type == 9">
				 and (exists(select 1 
                         from tbl_sys_user_info tsui1
                        where tsui1.user_type = 4
            				  and tsui1.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					          and tsui1.id = tsty.user_id)
					    or exists(select 1 from tbl_store_info tsi 
					    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
									select id from tbl_sys_organization_info where connect_by_isleaf=1
									start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
								)
								and b.user_type = 4
								and tsi.manager_user_id = b.id)
								and tsi.id = tsty.user_id)
						or exists(select 1 from tbl_store_info tsi 
					    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
									select id from tbl_sys_organization_info where connect_by_isleaf=1
									start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id 
								)
								and b.user_type = 4
								and tsi.manager_user_id = b.id)
								and tsi.shopkeeper_user_id = tsty.user_id)
						or exists (select 1 from tbl_store_user_rel tsur
						 	where exists (select 1 from tbl_store_info tsi 
									    	where exists (select 1 from tbl_sys_user_info b where organization_id in (
													select id from tbl_sys_organization_info where connect_by_isleaf=1
													start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id )
												and b.user_type = 4
												and tsi.manager_user_id = b.id)
				                                and tsi.id =tsur.store_id)
				           and type in (3,6)
				           and tsur.user_id = tsty.user_id))
			</if>
        </where>
        group by user_id
	</select>
	<!-- 查询用户IP访问记录 -->
    <resultMap id="userTypeOption" type="java.util.Map">
        <result column="user_id" property="id"/>
        <result column="ywy_user_realname" property="option"/>
    </resultMap>
    <!--查询当前指标完成人在当前年份设置的销售指标-->
	<select id="queryUserSalesTarget" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT ANNUAL_TARGET,
	       NVL (
	          (SELECT SUM (ANNUAL_TARGET)
	             FROM TBL_SALE_TARGETS_HY
	            WHERE SYS_USER_ID = #{user_id,jdbcType=INTEGER} 
	            AND YEAR = #{year,jdbcType=INTEGER}), 0) HAVE_ASSIGN_TARGET,
	       nvl((select annual_target from tbl_sale_targets_ywy where user_id=#{user_id,jdbcType=INTEGER}  and year=#{year,jdbcType=INTEGER}-1),0) last_year_target
	  FROM TBL_SALE_TARGETS_YWY
	 WHERE  USER_ID = #{user_id,jdbcType=INTEGER}
	 and year=#{year,jdbcType=INTEGER}
	</select>
	<!--查询会员库列表 -->
	<select id="queryMemberLibraryList" parameterType="java.util.Map" resultType="java.util.Map">
		select * from (
		select b.*, rownum rn from (
				select id,
					user_name,
                    user_state,
                    login_name,
                    user_manage_name,
                    to_char(create_date, 'yyyy-mm-dd hh24:mi:ss') as create_date,
                    user_manage_mobilephone,
                    (select name from tbl_dic_region where id=user_company_address_province)||
                    (select name from tbl_dic_region where id=user_company_address_city)||
                    (select name from tbl_dic_region where id=user_company_address_county)||
                    user_company_address_deails as user_address,
                    market_supervision_user_id as ywjl_user_id,
                    nvl((select annual_target from tbl_sale_targets_hy where user_id=tui.id and year=extract(year from sysdate)-1),0) last_year_target
                from tbl_user_info tui
				<where>
					user_type=1
					and user_state in(1,2)
				    and not exists(select 1 from tbl_sale_targets_hy where user_id=tui.id and year=#{year,jdbcType=INTEGER}  and sys_user_id=#{sys_user_id,jdbcType=INTEGER})
				    <if test="public_user_type != null and public_user_type == 3">
			            and tui.referee_user_id = #{public_user_id,jdbcType=INTEGER}
			        </if>
			        <if test="public_user_type != null and public_user_type == 4">
			            and tui.market_supervision_user_id = #{public_user_id,jdbcType=INTEGER}
			        </if>
			        <if test="public_user_type != null and public_user_type == 5">
			            and EXISTS(SELECT 1 FROM TBL_STORE_INFO TSI WHERE TSI.ID = tui.STORE_ID AND TSI.SHOPKEEPER_USER_ID = #{public_user_id,jdbcType=INTEGER})
			        </if>
			        <if test="public_user_type != null and public_user_type == 6">
			            and EXISTS(SELECT 1 FROM TBL_STORE_USER_REL TSUI WHERE TSUI.STORE_ID = tui.STORE_ID AND TSUI.USER_ID = #{public_user_id,jdbcType=INTEGER})
			        </if>
			        <if test="public_user_type != null and public_user_type == 9">
			            and EXISTS(SELECT 1 
			                         FROM TBL_SYS_USER_INFO TSUI
			                        WHERE TSUI.USER_TYPE = 4
			            				  AND TSUI.ORGANIZATION_ID IN (
											  	SELECT ID FROM TBL_SYS_ORGANIZATION_INFO WHERE CONNECT_BY_ISLEAF=1
											  	START WITH PARENT_ID = #{public_user_organization_id,jdbcType=INTEGER} CONNECT BY PRIOR ID = PARENT_ID
								              )
								          AND TSUI.id = tui.market_supervision_user_id)
			        </if>
				    <if test="login_name!=null and login_name!=''">
						and login_name=#{login_name,jdbcType=VARCHAR}
					</if>
					<if test="user_manage_name!=null and user_manage_name!=''">
						and user_manage_name = #{user_manage_name,jdbcType=VARCHAR}
					</if>
					<if test="user_manage_mobilephone!=null and user_manage_mobilephone!=''">
						and user_manage_mobilephone = #{user_manage_mobilephone, jdbcType=VARCHAR}
					</if>
					<if test="state !=null and state !=''">
						and user_state in
							<foreach item="item" collection="state" open="(" separator="," close=")">
								#{item}
							</foreach>
					</if>
					<if test="user_id !=null and user_id !=''">
						and id not in
							<foreach item="item" collection="user_id" open="(" separator="," close=")">
								#{item}
							</foreach>
					</if>
				</where>
		) b where
		rownum &lt;= #{end_rownum})
		where rn &gt; #{start_rownum}
	</select>
	<!-- 查询会员库列表 总数-->
    <select id="queryMemberLibraryCount" parameterType="java.util.Map" resultType="int" >
		select count(1)
                from tbl_user_info tui
			<where>
				user_type=1
				and user_state in(1,2)
			    and not exists(select 1 from tbl_sale_targets_hy where user_id=tui.id and year=#{year,jdbcType=INTEGER} and sys_user_id=#{sys_user_id,jdbcType=INTEGER})
			    <if test="public_user_type != null and public_user_type == 3">
		            and tui.referee_user_id = #{public_user_id,jdbcType=INTEGER}
		        </if>
		        <if test="public_user_type != null and public_user_type == 4">
		            and tui.market_supervision_user_id = #{public_user_id,jdbcType=INTEGER}
		        </if>
		        <if test="public_user_type != null and public_user_type == 5">
		            and EXISTS(SELECT 1 FROM TBL_STORE_INFO TSI WHERE TSI.ID = tui.STORE_ID AND TSI.SHOPKEEPER_USER_ID = #{public_user_id,jdbcType=INTEGER})
		        </if>
		        <if test="public_user_type != null and public_user_type == 6">
		            and EXISTS(SELECT 1 FROM TBL_STORE_USER_REL TSUI WHERE TSUI.STORE_ID = tui.STORE_ID AND TSUI.USER_ID = #{public_user_id,jdbcType=INTEGER})
		        </if>
		        <if test="public_user_type != null and public_user_type == 9">
		            and EXISTS(SELECT 1 
		                         FROM TBL_SYS_USER_INFO TSUI
		                        WHERE TSUI.USER_TYPE = 4
		            				  AND TSUI.ORGANIZATION_ID IN (
										  	SELECT ID FROM TBL_SYS_ORGANIZATION_INFO WHERE CONNECT_BY_ISLEAF=1
										  	START WITH PARENT_ID = #{public_user_organization_id,jdbcType=INTEGER} CONNECT BY PRIOR ID = PARENT_ID
							              )
							          AND TSUI.id = tui.market_supervision_user_id)
		        </if>
			    <if test="login_name!=null and login_name!=''">
					and login_name=#{login_name,jdbcType=VARCHAR}
				</if>
				<if test="user_manage_name!=null and user_manage_name!=''">
					and user_manage_name = #{user_manage_name,jdbcType=VARCHAR}
				</if>
				<if test="user_manage_mobilephone!=null and user_manage_mobilephone!=''">
					and user_manage_mobilephone = #{user_manage_mobilephone, jdbcType=VARCHAR}
				</if>
				<if test="state !=null and state !=''">
					and user_state in
						<foreach item="item" collection="state" open="(" separator="," close=")">
							#{item}
						</foreach>
				</if>
				<if test="user_id !=null and user_id !=''">
					and id not in
						<foreach item="item" collection="user_id" open="(" separator="," close=")">
							#{item}
						</foreach>
				</if>
			</where>
    </select>
    <!-- 新增会员销售指标主表信息 -->
	<insert id="insertSaleTargetHy" parameterType="java.util.Map">
		<selectKey keyProperty="id" resultType="int" order="BEFORE">
            select SEQ_SALE_TARGETS_HY.NEXTVAL from dual
        </selectKey>
		INSERT INTO TBL_SALE_TARGETS_HY(
			ID,
			USER_ID,
			SYS_USER_ID,
			YEAR,
			ANNUAL_TARGET,
			CREATE_USER_ID,
			CREATE_DATE,
			APPROVAL_STATE
		) values(
			#{id,jdbcType=INTEGER},
			#{USER_NAME,jdbcType=INTEGER},
			#{SYS_USER_ID,jdbcType=INTEGER},
			#{YEAR,jdbcType=INTEGER},
			#{ANNUAL_TARGET,jdbcType=INTEGER},
			#{CREATE_USER_ID,jdbcType=INTEGER},
			sysdate,
			1
		)
	</insert>
	<!-- 新增会员销售指标详表信息 -->
	<insert id="insertSaleTargetHyDetail" parameterType="java.util.Map">
		INSERT INTO TBL_SALE_TARGETS_HY_DETAIL(
			ID,
			SALE_TARGET_HY_ID,
			MONTH_TYPE,
			MONTH_VALUE,
			APPROVAL_STATE
		) SELECT SEQ_SALE_TARGETS_HY_DETAIL.NEXTVAL,
              	 SALE_TARGET_HY_ID,
                 MONTH_TYPE,
                 MONTH_VALUE,
                 APPROVAL_STATE
          FROM (
		        <foreach collection="list" item="item" index="index" separator="UNION">
		            SELECT  #{item.sale_target_hy_id,jdbcType=INTEGER} AS SALE_TARGET_HY_ID,
		            		#{item.month_type,jdbcType=INTEGER} AS MONTH_TYPE,
		            		#{item.month_value,jdbcType=INTEGER} AS MONTH_VALUE,
		            		#{item.approval_state,jdbcType=INTEGER} AS APPROVAL_STATE
		            FROM DUAL
		        </foreach>
        	   )
	</insert>
	<!--编辑会员销售指标主表信息-->
    <update id="updateSaleTargetHy" parameterType="java.util.Map">
        UPDATE
            TBL_SALE_TARGETS_HY
        <set>
        	<if test="SYS_USER_ID != null and SYS_USER_ID != ''">
                SYS_USER_ID = #{SYS_USER_ID,jdbcType=INTEGER},
            </if>
            <if test="ANNUAL_TARGET != null and ANNUAL_TARGET != ''">
                ANNUAL_TARGET = #{ANNUAL_TARGET,jdbcType=INTEGER},
            </if>
            <if test="YEAR != null and YEAR != ''">
                YEAR = #{YEAR,jdbcType=INTEGER},
            </if>
            APPROVAL_USER_ID='',
        	APPROVAL_DATE='',
        	APPROVAL_STATE=1,
        	REJECTED_REASON=''
        </set>
        where
            ID = #{ID,jdbcType=INTEGER}
    </update>
    <!-- 删除业务员销售指标详表信息-->
    <delete id="deleteSaleTargetHyDetail" parameterType="java.util.Map">
        delete from tbl_sale_targets_hy_detail
        where sale_target_hy_id = #{sale_target_hy_id,jdbcType=INTEGER}
    </delete>
    <!--会员销售指标详情(支持单个和批量查看)-->
	<select id="queryHySaleTargetDetail" parameterType="java.util.Map" resultType="java.util.Map">
		select 
			id,
			user_id,
			(select login_name from tbl_user_info where id=user_id)as login_name, 
			(select user_manage_name from tbl_user_info where id=user_id)as user_manage_name, 
			sys_user_id,
			(select user_type from tbl_sys_user_info where id=sys_user_id) as user_type,
			(select user_realname from tbl_sys_user_info where id=sys_user_id)as user_realname,
			(select to_char(create_date, 'yyyy-mm-dd hh24:mi:ss') from tbl_user_info where id=user_id) as user_create_date,
			nvl((select annual_target from tbl_sale_targets_hy where user_id=tsth.user_id and year=extract(year from sysdate)-1),0) last_year_target,
			year, 
			annual_target,
			create_user_id,
			(select user_realname from tbl_sys_user_info where id=create_user_id)as create_user_realname,
			to_char(create_date, 'yyyy-mm-dd hh24:mi:ss') create_date,
			approval_user_id,
			to_char(approval_date, 'yyyy-mm-dd hh24:mi:ss') approval_date,
			approval_state,
			rejected_reason,
			nvl((select annual_target from TBL_SALE_TARGETS_YWY tsay where tsay.user_id=tsth.sys_user_id and tsay.year=tsth.year),0) as ywy_annual_target,
			NVL((SELECT SUM (ANNUAL_TARGET) FROM TBL_SALE_TARGETS_HY WHERE SYS_USER_ID = tsth.SYS_USER_ID AND YEAR = tsth.year),0) HAVE_ASSIGN_TARGET
		from tbl_sale_targets_hy tsth
		<where>
			<if test="sale_target_hy_id !=null and sale_target_hy_id !=''">
				and tsth.id in
				<foreach item="item" collection="sale_target_hy_id" open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
		</where>
	</select>
	<!--会员销售指标详情(获取每月设置的月度指标)-->
	<select id="queryHySaleTargetDetailList" parameterType="java.util.Map" resultType="java.util.Map">
		select id,
			sale_target_hy_id,
			month_type,
			month_value,
			approval_state as detail_approval_state  from tbl_sale_targets_hy_detail 
			where sale_target_hy_id=#{sale_target_hy_id,jdbcType=INTEGER}
		order by month_type
	</select>
	<!--审批业务员销售指标-->
    <update id="approvalYwySaleTarget" parameterType="java.util.Map">
        update
            tbl_sale_targets_ywy
        <set>
        	approval_user_id=#{public_user_id,jdbcType=INTEGER},
        	approval_date=sysdate,
            <if test="approval_state != null and approval_state != ''">
                approval_state = #{approval_state,jdbcType=INTEGER},
            </if>
            <if test="rejected_reason != null and rejected_reason != ''">
                rejected_reason = #{rejected_reason,jdbcType=VARCHAR}
            </if>
        </set>
        where id in
        <foreach item="item" collection="sale_target_id" open="(" separator="," close=")">
			#{item}
		</foreach>
    </update>
    <!--审批业务员销售指标详情-->
    <update id="approvalYwySaleTargetDetail" parameterType="java.util.Map">
        update
            tbl_sale_targets_ywy_detail
        set approval_state=2
        where sale_target_ywy_id in
        <foreach item="item" collection="sale_target_id" open="(" separator="," close=")">
			#{item}
		</foreach>
		and month_type &lt;=#{month_type,jdbcType=INTEGER}
    </update>
    <!--审批会员销售指标详情-->
    <update id="approvalHySaleTargetDetail" parameterType="java.util.Map">
        update
            tbl_sale_targets_hy_detail
        set approval_state=2
        where sale_target_hy_id in
        <foreach item="item" collection="sale_target_hy_id" open="(" separator="," close=")">
			#{item}
		</foreach>
		and month_type &lt;=#{month_type,jdbcType=INTEGER}
    </update>
    <!--审批会员销售指标-->
    <update id="approvalHySaleTarget" parameterType="java.util.Map">
        update
            tbl_sale_targets_hy
        <set>
        	approval_user_id=#{public_user_id,jdbcType=INTEGER},
        	approval_date=sysdate,
            <if test="approval_state != null and approval_state != ''">
                approval_state = #{approval_state,jdbcType=INTEGER},
            </if>
            <if test="rejected_reason != null and rejected_reason != ''">
                rejected_reason = #{rejected_reason,jdbcType=VARCHAR}
            </if>
        </set>
        where id in
        <foreach item="item" collection="sale_target_hy_id" open="(" separator="," close=")">
			#{item}
		</foreach>
    </update>
      <!--查询销售人员关联的业务经理和门店-->
	<select id="queryUserYwjlAndStoreData" parameterType="java.util.Map" resultType="java.util.Map">
		select tsty.id,
			nvl(case when (tsty.user_type=3 or tsty.user_type=6) then
                   		(select to_char(wm_concat(id)) from tbl_store_info where id in(select store_id from tbl_store_user_rel where user_id=tsty.user_id)) 
                     when tsty.user_type=4 then
                   		(select to_char(wm_concat(id)) from tbl_store_info where manager_user_id=tsty.user_id)
                    when tsty.user_type=5 then
                   		(select to_char(wm_concat(id)) from tbl_store_info where shopkeeper_user_id=tsty.user_id)
                   	 end,0) as store_id,
                	nvl(case when (tsty.user_type=3 or tsty.user_type=6) then
                   		(select to_char(wm_concat(id)) from tbl_sys_user_info where id in (select manager_user_id from tbl_store_info where id in(select store_id from tbl_store_user_rel where user_id=tsty.user_id))) 
                   	 when tsty.user_type=4 then
                  		(select to_char(id) from tbl_sys_user_info where id=tsty.user_id)
                 	 when tsty.user_type=5 then
                		(select to_char(wm_concat(id)) from tbl_sys_user_info where id in (select manager_user_id from tbl_store_info where  SHOPKEEPER_USER_ID=tsty.user_id))
                   end,0) as manager_user_id
		from tbl_sale_targets_ywy tsty
	<where>
		<if test="public_user_type != null and public_user_type == 3">
			and tsty.user_id=#{public_user_id,jdbcType=INTEGER}
		</if>
		<if test="public_user_type != null and public_user_type == 4">
			and (exists(select 1 from tbl_store_info where manager_user_id=#{public_user_id,jdbcType=INTEGER} and shopkeeper_user_id=tsty.user_id)	
 					or exists(select 1 from tbl_store_info tsi, tbl_store_user_rel tsur where tsi.id=tsur.store_id
 									and tsi.manager_user_id=#{public_user_id,jdbcType=INTEGER} and tsur.type=3 and tsur.user_id=tsty.user_id)
 					or exists(select 1 from tbl_store_info tsi, tbl_store_user_rel tsur where tsi.id=tsur.store_id
 									and tsi.manager_user_id=#{public_user_id,jdbcType=INTEGER} and tsur.type=6 and tsur.user_id=tsty.user_id)
 					or tsty.user_id=#{public_user_id,jdbcType=INTEGER})
		</if>
		<if test="public_user_type != null and public_user_type == 5">
			and tsty.user_id=#{public_user_id,jdbcType=INTEGER}
		</if>
		<if test="public_user_type != null and public_user_type == 6">
			and tsty.user_id=#{public_user_id,jdbcType=INTEGER}
		</if>
		<if test="public_user_type != null and public_user_type == 9">
			 and exists(select 1 
                       from tbl_sys_user_info tsui1
                      where tsui1.user_type = 4
          				  and tsui1.organization_id in (
						  	select id from tbl_sys_organization_info where connect_by_isleaf=1
						  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
			              )
			          and tsui1.id = tsty.user_id)
		</if>
	</where>
	</select>
    <!-- 销售指标完成情况统计分页查询 (按人员)-->
   <select id="querySaleTargetTotalYwyListForPage" parameterType="java.util.Map" resultType="java.util.Map">
        select a.*,(select user_realname from tbl_sys_user_info where id = a.user_id)||decode(a.user_type,3,'(业务员)',4,'(业务经理)',5,'(店长)',6,'(营业员)') user_realname,
               nvl((select annual_target from tbl_sale_targets_ywy where user_id = a.user_id
               and ywjl_user_id = a.ywjl_user_id
       		   and year = #{year,jdbcType=INTEGER}
       		   and approval_state = 2
               and user_type = a.user_type),0) annual_target,
       		   nvl((select sum(month_value) from tbl_sale_targets_ywy_detail where 
			   sale_target_ywy_id = (select id from tbl_sale_targets_ywy 
			   where user_id = a.user_id
			   and ywjl_user_id = a.ywjl_user_id
			   and year = #{year,jdbcType=INTEGER}
			   and approval_state = 2
               and user_type = a.user_type)
			   and month_type in
			   <foreach collection="month_types" item="item" open="(" separator="," close=")" >
			   		#{item}
			   </foreach>
			   ),0) sum_mouth_value
		from (select t.*,rownum rn
		  from (
			  select a.* 
			   from(
			       select t.id ywjl_user_id,t.user_name as ywjl_user_name,t.user_realname as ywjl_user_realname, '0' as md_id,to_char(wm_concat(t1.store_name)) store_name, t.id as user_id,t.user_name,4 user_type
				      from tbl_sys_user_info t
				           left join tbl_store_info t1
				        on t.id = t1.manager_user_id
				    where t.user_type =4
				    <if test="ywjl_user_id != null and ywjl_user_id != ''">
						and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  </if>
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="user_id != null and user_id != ''">
						and t.id = #{user_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
				    group by t.id,t.user_name,t.user_realname
				    union all
				   select t.id ywjl_user_id,t.user_name as ywjl_user_name,t.user_realname as ywjl_user_realname, to_char(wm_concat(t1.id)) as md_id,to_char(wm_concat(t1.store_name)) store_name, t1.shopkeeper_user_id as user_id,(select user_name from tbl_sys_user_info where id=t1.shopkeeper_user_id) user_name,5 user_type
				      from tbl_sys_user_info t,
				           tbl_store_info t1
				    where t.user_type =4
				      and t.id = t1.manager_user_id
				      <if test="ywjl_user_id != null and ywjl_user_id != ''">
						and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  </if>
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="user_id != null and user_id != ''">
						and t1.shopkeeper_user_id = #{user_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t.id,t.user_name,t.user_realname,t1.shopkeeper_user_id
				    union all
				    select t.id ywjl_user_id,t.user_name as ywjl_user_name,t.user_realname as ywjl_user_realname, to_char(wm_concat(t1.id)) as md_id,to_char(wm_concat(t1.store_name)) store_name, t2.user_id,(select user_name from tbl_sys_user_info where id=t2.user_id) user_name,6 user_type
				      from tbl_sys_user_info t,
				            tbl_store_info t1,
				            tbl_store_user_rel t2
				    where t.user_type =4
				      and t.id = t1.manager_user_id
				      and t1.id = t2.store_id
				      and t2.type = 6
				      <if test="ywjl_user_id != null and ywjl_user_id != ''">
						and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  </if>
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="user_id != null and user_id != ''">
						and t2.user_id = #{user_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t.id,t.user_name,t.user_realname,t2.user_id
				      union all
				    select t.id ywjl_user_id,t.user_name as ywjl_user_name,t.user_realname as ywjl_user_realname, to_char(wm_concat(t1.id)) as md_id,to_char(wm_concat(t1.store_name)) store_name, t2.user_id,(select user_name from tbl_sys_user_info where id=t2.user_id) user_name,3 user_type
				      from tbl_sys_user_info t,
				            tbl_store_info t1,
				            tbl_store_user_rel t2
				    where t.user_type =4
				      and t.id = t1.manager_user_id
				      and t1.id = t2.store_id
				      and t2.type = 3
				      <if test="ywjl_user_id != null and ywjl_user_id != ''">
						and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  </if>
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="user_id != null and user_id != ''">
						and t2.user_id = #{user_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t.id,t.user_name,t.user_realname,t2.user_id) a
			      order by a.ywjl_user_id,a.user_id) t
				where rownum &lt;= #{end_rownum,jdbcType=INTEGER}) a
        where rn &gt; #{start_rownum,jdbcType=INTEGER}
   </select>
   <!-- 销售指标完成情况统计总数 (按人员)-->
   <select id="querySaleTargetTotalYwyCount" parameterType="java.util.Map" resultType="int">
	   select count(1)
		   from(
		       select t.id ywjl_user_id,t.user_name as ywjl_user_name,t.user_realname as ywjl_user_realname, '0' as md_id,to_char(wm_concat(t1.store_name)) store_name, t.id as user_id,t.user_name,4 user_type
			      from tbl_sys_user_info t
			           left join tbl_store_info t1
			        on t.id = t1.manager_user_id
			    where t.user_type =4
			    <if test="ywjl_user_id != null and ywjl_user_id != ''">
					and t.id = #{ywjl_user_id,jdbcType=INTEGER}
				  </if>
				  <if test="md_id != null and md_id != ''">
					and t1.id = #{md_id,jdbcType=INTEGER}
				  </if>
				  <if test="user_id != null and user_id != ''">
					and t.id = #{user_id,jdbcType=INTEGER}
				  </if>
				  <if test="public_user_type != null and public_user_type == 9">
				 	and t.organization_id in (
							  	select id from tbl_sys_organization_info where connect_by_isleaf=1
							  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
				              )
				  </if>
			    group by t.id,t.user_name,t.user_realname
			    union all
			   select t.id ywjl_user_id,t.user_name as ywjl_user_name,t.user_realname as ywjl_user_realname, to_char(wm_concat(t1.id)) as md_id,to_char(wm_concat(t1.store_name)) store_name, t1.shopkeeper_user_id as user_id,(select user_name from tbl_sys_user_info where id=t1.shopkeeper_user_id) user_name,5 user_type
			      from tbl_sys_user_info t,
			           tbl_store_info t1
			    where t.user_type =4
			      and t.id = t1.manager_user_id
			      <if test="ywjl_user_id != null and ywjl_user_id != ''">
					and t.id = #{ywjl_user_id,jdbcType=INTEGER}
				  </if>
				  <if test="md_id != null and md_id != ''">
					and t1.id = #{md_id,jdbcType=INTEGER}
				  </if>
				  <if test="user_id != null and user_id != ''">
					and t1.shopkeeper_user_id = #{user_id,jdbcType=INTEGER}
				  </if>
				  <if test="public_user_type != null and public_user_type == 9">
				 	and t.organization_id in (
							  	select id from tbl_sys_organization_info where connect_by_isleaf=1
							  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
				              )
				  </if>
	                 group by t.id,t.user_name,t.user_realname,t1.shopkeeper_user_id
			    union all
			    select t.id ywjl_user_id,t.user_name as ywjl_user_name,t.user_realname as ywjl_user_realname, to_char(wm_concat(t1.id)) as md_id,to_char(wm_concat(t1.store_name)) store_name, t2.user_id,(select user_name from tbl_sys_user_info where id=t2.user_id) user_name,6 user_type
			      from tbl_sys_user_info t,
			            tbl_store_info t1,
			            tbl_store_user_rel t2
			    where t.user_type =4
			      and t.id = t1.manager_user_id
			      and t1.id = t2.store_id
			      and t2.type = 6
			      <if test="ywjl_user_id != null and ywjl_user_id != ''">
					and t.id = #{ywjl_user_id,jdbcType=INTEGER}
				  </if>
				  <if test="md_id != null and md_id != ''">
					and t1.id = #{md_id,jdbcType=INTEGER}
				  </if>
				  <if test="user_id != null and user_id != ''">
					and t2.user_id = #{user_id,jdbcType=INTEGER}
				  </if>
				  <if test="public_user_type != null and public_user_type == 9">
				 	and t.organization_id in (
							  	select id from tbl_sys_organization_info where connect_by_isleaf=1
							  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
				              )
				  </if>
	                 group by t.id,t.user_name,t.user_realname,t2.user_id
			      union all
			    select t.id ywjl_user_id,t.user_name as ywjl_user_name,t.user_realname as ywjl_user_realname, to_char(wm_concat(t1.id)) as md_id,to_char(wm_concat(t1.store_name)) store_name, t2.user_id,(select user_name from tbl_sys_user_info where id=t2.user_id) user_name,3 user_type
			      from tbl_sys_user_info t,
			            tbl_store_info t1,
			            tbl_store_user_rel t2
			    where t.user_type =4
			      and t.id = t1.manager_user_id
			      and t1.id = t2.store_id
			      and t2.type = 3
			      <if test="ywjl_user_id != null and ywjl_user_id != ''">
					and t.id = #{ywjl_user_id,jdbcType=INTEGER}
				  </if>
				  <if test="md_id != null and md_id != ''">
					and t1.id = #{md_id,jdbcType=INTEGER}
				  </if>
				  <if test="user_id != null and user_id != ''">
					and t2.user_id = #{user_id,jdbcType=INTEGER}
				  </if>
				  <if test="public_user_type != null and public_user_type == 9">
				 	and t.organization_id in (
							  	select id from tbl_sys_organization_info where connect_by_isleaf=1
							  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
				              )
				  </if>
	                 group by t.id,t.user_name,t.user_realname,t2.user_id) a
   	</select>
   <!-- 完成量(按人员) -->
   <select id="queryYwyPerformMoney" parameterType="java.util.Map" resultType="java.util.Map">
   		select user_name,nvl(sum(allPayMoney-preOrderFirstMoney),0) perform_money from (
	        select b.ywjl_user_name as user_name,nvl(sum(PAYMENT_MONEY),0) allPayMoney,0 preOrderFirstMoney from tbl_order_info b where b.payment_state = 2 
	        --时间过滤
	        and to_date(to_char(b.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
	        and to_date(to_char(b.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
	        and b.ywy_user_name is null
	        <if test="user_id != null and user_id != ''">
				and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywjl_user_name) 
			</if>
	        group by b.ywjl_user_name
	        union all
	        --尾款订单的定金金额     
	        select b.ywjl_user_name as user_name,0 allPayMoney,nvl(sum(a.PRODUCT_TOTAL_MONEY*(g.EARNEST_MONEY/g.PRODUCT_MONEY)),0) preOrderFirstMoney from TBL_ORDER_PRODUCT a ,TBL_ORDER_INFO b,TBL_PRE_ORDER_RELATE f,TBL_PRE_ORDER_INFO g
	        where a.order_number = f.order_number and f.PRE_ORDER_NUMBER = g.ORDER_NUMBER
	        and a.order_number = b.order_number and b.PAYMENT_STATE = 2
	        --判断时间筛选
	        and to_date(to_char(b.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
	        and to_date(to_char(b.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
	        and b.ywy_user_name is null
	        <if test="user_id != null and user_id != ''">
				and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywjl_user_name) 
			</if>
	        group by b.ywjl_user_name)
            group by user_name
   		union all
   		
   		select user_name,nvl(sum(allPayMoney-preOrderFirstMoney),0) perform_money from (
	        select b.ywy_user_name as user_name,nvl(sum(PAYMENT_MONEY),0) allPayMoney,0 preOrderFirstMoney from tbl_order_info b where b.payment_state = 2 
	        --时间过滤
	        and to_date(to_char(b.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
	        and to_date(to_char(b.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
	        and b.ywy_user_name is not null
	        <if test="user_id != null and user_id != ''">
				and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywy_user_name) 
			</if>
	        group by b.ywy_user_name
	        union all
	        --尾款订单的定金金额     
	        select b.ywy_user_name as user_name,0 allPayMoney,nvl(sum(a.PRODUCT_TOTAL_MONEY*(g.EARNEST_MONEY/g.PRODUCT_MONEY)),0) preOrderFirstMoney from TBL_ORDER_PRODUCT a ,TBL_ORDER_INFO b,TBL_PRE_ORDER_RELATE f,TBL_PRE_ORDER_INFO g
	        where a.order_number = f.order_number and f.PRE_ORDER_NUMBER = g.ORDER_NUMBER
	        and a.order_number = b.order_number and b.PAYMENT_STATE = 2
	        --判断时间筛选
	        and to_date(to_char(b.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
	        and to_date(to_char(b.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
	        and b.ywy_user_name is not null
	        <if test="user_id != null and user_id != ''">
				and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywy_user_name) 
			</if>
	        group by b.ywy_user_name)
            group by user_name
   </select>
   <!-- 退款单数据(按人员) -->
   <select id="queryYwyRefundList" parameterType="java.util.Map" resultType="java.util.Map">
   		select t1.ywjl_user_name as user_name,nvl(sum(a.RETURN_TOTAL_MONEY),0) REFUND_ORDER_PRODUCT_MONEY
            from tbl_order_return_info a,(select toi.ywjl_user_name,toi.order_number
										    from tbl_order_info toi
										    where toi.ywy_user_name is null
	                                            and toi.payment_state = 2
	                                            and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
                                            	and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
											  <if test="user_id != null and user_id != ''">
												and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywjl_user_name)
											  </if>
										    group by toi.ywjl_user_name,toi.order_number) t1
			where a.state = 2
			and a.order_number = t1.order_number
            group by t1.ywjl_user_name
            union all
   		select t1.ywy_user_name as user_name,nvl(sum(a.RETURN_TOTAL_MONEY),0) REFUND_ORDER_PRODUCT_MONEY
            from tbl_order_return_info a,(select toi.ywy_user_name,toi.order_number
									      from tbl_order_info toi
									    where toi.payment_state = 2
                                          and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
                                          and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
                                          and toi.ywy_user_name is not null
										  <if test="user_id != null and user_id != ''">
											and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywy_user_name) 
										</if>
							                 group by toi.ywy_user_name,toi.order_number) t1
			where a.state = 2
			and a.order_number = t1.order_number
            group by t1.ywy_user_name
   </select>
   <!-- 退货单数据(按人员) -->
   <select id="queryYwyReturnList" parameterType="java.util.Map" resultType="java.util.Map">
		    select t1.ywjl_user_name as user_name,nvl(sum(return_money),0) returns_order_product_money
		        from ${jdbc_user}.tbl_new_return_confirm a,${jdbc_user}.tbl_new_return_order b,tbl_product_sku c,
		        				(select toi.ywjl_user_name,toi.order_number
										    from tbl_order_info toi
										    where toi.ywy_user_name is null
	                                            and toi.payment_state = 2
	                                            and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
                                            	and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
											  <if test="user_id != null and user_id != ''">
												and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywjl_user_name)
											  </if>
										    group by toi.ywjl_user_name,toi.order_number) t1
				where a.product_sku = c.id and a.return_number = b.return_number and b.state = '8' and a.return_flag = 1
				and exists (select 1 from ${jdbc_user}.tbl_new_return_detail_code where return_number = a.return_number and order_number_platform=t1.order_number)
				group by t1.ywjl_user_name
	            union all
   			select t1.ywy_user_name as user_name,nvl(sum(return_money),0) returns_order_product_money
		        from ${jdbc_user}.tbl_new_return_confirm a,${jdbc_user}.tbl_new_return_order b,tbl_product_sku c,
		        	(select toi.ywy_user_name,toi.order_number
									      from tbl_order_info toi
									    where toi.payment_state = 2
                                          and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
                                          and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
                                          and toi.ywy_user_name is not null
										  <if test="user_id != null and user_id != ''">
											and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywy_user_name) 
										</if>
							                 group by toi.ywy_user_name,toi.order_number) t1
				where a.product_sku = c.id and a.return_number = b.return_number and b.state = '8' and a.return_flag = 1
				and exists (select 1 from ${jdbc_user}.tbl_new_return_detail_code where return_number = a.return_number and order_number_platform=t1.order_number)
				group by t1.ywy_user_name
   </select>
   <!-- 今天销额销量(按人员) -->
   <select id="queryYwyTodayMoneyAndCount" parameterType="java.util.Map" resultType="java.util.Map">
   		select user_name,nvl(sum(allPayMoney-preOrderFirstMoney),0) today_money,nvl(sum(ALL_ORDER_PRODUCT_COUNT),0) today_count from (
	        select b.ywjl_user_name as user_name,nvl(sum(PAYMENT_MONEY),0) allPayMoney,0 preOrderFirstMoney,sum(PRODUCT_COUNT) ALL_ORDER_PRODUCT_COUNT from tbl_order_info b where b.payment_state = 2 
	        --时间过滤
	        and to_date(to_char(b.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
	        and b.ywy_user_name is null
	        <if test="user_id != null and user_id != ''">
				and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywjl_user_name) 
			</if>
	        group by b.ywjl_user_name
	        union all
	        --尾款订单的定金金额     
	        select b.ywjl_user_name as user_name,0 allPayMoney,nvl(sum(a.PRODUCT_TOTAL_MONEY*(g.EARNEST_MONEY/g.PRODUCT_MONEY)),0) preOrderFirstMoney,0 ALL_ORDER_PRODUCT_COUNT from TBL_ORDER_PRODUCT a ,TBL_ORDER_INFO b,TBL_PRE_ORDER_RELATE f,TBL_PRE_ORDER_INFO g
	        where a.order_number = f.order_number and f.PRE_ORDER_NUMBER = g.ORDER_NUMBER
	        and a.order_number = b.order_number and b.PAYMENT_STATE = 2
	        --判断时间筛选
	        and to_date(to_char(b.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
	        and b.ywy_user_name is null
	        <if test="user_id != null and user_id != ''">
				and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywjl_user_name) 
			</if>
	        group by b.ywjl_user_name)
            group by user_name
            
            union all
            
            select user_name,nvl(sum(allPayMoney-preOrderFirstMoney),0) today_money,nvl(sum(ALL_ORDER_PRODUCT_COUNT),0) today_count from (
	        select b.ywy_user_name as user_name,nvl(sum(PAYMENT_MONEY),0) allPayMoney,0 preOrderFirstMoney,sum(PRODUCT_COUNT) ALL_ORDER_PRODUCT_COUNT from tbl_order_info b where b.payment_state = 2 
	        --时间过滤
	        and to_date(to_char(b.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
	        and b.ywy_user_name is not null
	        <if test="user_id != null and user_id != ''">
				and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywy_user_name) 
			</if>
	        group by b.ywy_user_name
	        union all
	        --尾款订单的定金金额     
	        select b.ywy_user_name as user_name,0 allPayMoney,nvl(sum(a.PRODUCT_TOTAL_MONEY*(g.EARNEST_MONEY/g.PRODUCT_MONEY)),0) preOrderFirstMoney,0 ALL_ORDER_PRODUCT_COUNT from TBL_ORDER_PRODUCT a ,TBL_ORDER_INFO b,TBL_PRE_ORDER_RELATE f,TBL_PRE_ORDER_INFO g
	        where a.order_number = f.order_number and f.PRE_ORDER_NUMBER = g.ORDER_NUMBER
	        and a.order_number = b.order_number and b.PAYMENT_STATE = 2
	        --判断时间筛选
	        and to_date(to_char(b.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
	        and b.ywy_user_name is not null
	        <if test="user_id != null and user_id != ''">
				and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywy_user_name) 
			</if>
	        group by b.ywy_user_name)
            group by user_name
   </select> 
   <!-- 今天退款数据(按人员) -->
   <select id="queryYwyTodayRefundList" parameterType="java.util.Map" resultType="java.util.Map">
   		select t1.ywjl_user_name as user_name,nvl(sum(a.RETURN_TOTAL_MONEY),0) REFUND_ORDER_PRODUCT_MONEY,nvl(sum(a.PRODUCT_COUNT),0) REFUND_ORDER_PRODUCT_COUNT 
            from tbl_order_return_info a,(select toi.ywjl_user_name,toi.order_number
										    from tbl_order_info toi
										    where toi.ywy_user_name is null
	                                            and toi.payment_state = 2
	                                            and to_date(to_char(toi.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
											  <if test="user_id != null and user_id != ''">
												and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywjl_user_name)
											  </if>
										    group by toi.ywjl_user_name,toi.order_number) t1
			where a.state = 2
			and a.order_number = t1.order_number
            group by t1.ywjl_user_name
            union all
   		select t1.ywy_user_name as user_name,nvl(sum(a.RETURN_TOTAL_MONEY),0) REFUND_ORDER_PRODUCT_MONEY,nvl(sum(a.PRODUCT_COUNT),0) REFUND_ORDER_PRODUCT_COUNT 
            from tbl_order_return_info a,(select toi.ywy_user_name,toi.order_number
									      from tbl_order_info toi
									    where toi.payment_state = 2
                                          and to_date(to_char(toi.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
                                          and toi.ywy_user_name is not null
										  <if test="user_id != null and user_id != ''">
											and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywy_user_name) 
										</if>
							                 group by toi.ywy_user_name,toi.order_number) t1
			where a.state = 2
			and a.order_number = t1.order_number
            group by t1.ywy_user_name
   </select>
   <!-- 今天退货数据(按人员) -->
   <select id="queryYwyTodayReturnList" parameterType="java.util.Map" resultType="java.util.Map">
   		select t1.ywjl_user_name as user_name,nvl(sum(RETURN_MONEY),0) RETURNS_ORDER_PRODUCT_MONEY,nvl(sum(RETURN_NUM),0) RETURNS_ORDER_PRODUCT_COUNT
		        from ${jdbc_user}.tbl_new_return_confirm a,${jdbc_user}.tbl_new_return_order b,tbl_product_sku c,
		        				(select toi.ywjl_user_name,toi.order_number
										    from tbl_order_info toi
										    where toi.ywy_user_name is null
	                                            and toi.payment_state = 2
	                                            and to_date(to_char(toi.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
											  <if test="user_id != null and user_id != ''">
												and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywjl_user_name)
											  </if>
										    group by toi.ywjl_user_name,toi.order_number) t1
				where a.product_sku = c.ID and a.RETURN_NUMBER = b.RETURN_NUMBER and b.state = '8' and a.RETURN_FLAG = 1
				and exists (select 1 from ${jdbc_user}.tbl_new_return_detail_code where return_number = a.return_number and order_number_platform=t1.order_number)
				group by t1.ywjl_user_name
	            union all
   			select t1.ywy_user_name as user_name,nvl(sum(RETURN_MONEY),0) RETURNS_ORDER_PRODUCT_MONEY,nvl(sum(RETURN_NUM),0) RETURNS_ORDER_PRODUCT_COUNT
		        from ${jdbc_user}.tbl_new_return_confirm a,${jdbc_user}.tbl_new_return_order b,tbl_product_sku c,
		        	(select toi.ywy_user_name,toi.order_number
									      from tbl_order_info toi
									    where toi.payment_state = 2
                                          and to_date(to_char(toi.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
                                          and toi.ywy_user_name is not null
										  <if test="user_id != null and user_id != ''">
											and exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywy_user_name) 
										</if>
							                 group by toi.ywy_user_name,toi.order_number) t1
				where a.product_sku = c.ID and a.RETURN_NUMBER = b.RETURN_NUMBER and b.state = '8' and a.RETURN_FLAG = 1
				and exists (select 1 from ${jdbc_user}.tbl_new_return_detail_code where return_number = a.return_number and order_number_platform=t1.order_number)
				group by t1.ywy_user_name
   </select>
   
	<!-- 销售指标完成情况统计汇总 (按人员) -->
	<select id="querySaleTargetTotalYwySummary" parameterType="java.util.Map" resultType="java.util.Map">
		select nvl(sum(sum_mouth_value), 0) sum_mouth_value
			from(
			select nvl((select sum(month_value) from tbl_sale_targets_ywy_detail where 
				   sale_target_ywy_id = (select id from tbl_sale_targets_ywy 
				   where user_id = t.user_id
				   and year = #{year,jdbcType=INTEGER}
				   and approval_state = 2
	               and user_type = t.user_type)
				   and month_type in
				   <foreach collection="month_types" item="item" open="(" separator="," close=")" >
				   		#{item}
				   </foreach>
				   ),0) sum_mouth_value
			 from (select a.* 
			   from(
			       select t.id ywjl_user_id,t.user_name as ywjl_user_name,t.user_realname as ywjl_user_realname, '0' as md_id,to_char(wm_concat(t1.store_name)) store_name, t.id as user_id,t.user_name,4 user_type
				      from tbl_sys_user_info t
				           left join tbl_store_info t1
				        on t.id = t1.manager_user_id
				    where t.user_type =4
				    <if test="ywjl_user_id != null and ywjl_user_id != ''">
						and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  </if>
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="user_id != null and user_id != ''">
						and t.id = #{user_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
				    group by t.id,t.user_name,t.user_realname
				    union all
				   select t.id ywjl_user_id,t.user_name as ywjl_user_name,t.user_realname as ywjl_user_realname, to_char(wm_concat(t1.id)) as md_id,to_char(wm_concat(t1.store_name)) store_name, t1.shopkeeper_user_id as user_id,(select user_name from tbl_sys_user_info where id=t1.shopkeeper_user_id) user_name,5 user_type
				      from tbl_sys_user_info t,
				           tbl_store_info t1
				    where t.user_type =4
				      and t.id = t1.manager_user_id
				      <if test="ywjl_user_id != null and ywjl_user_id != ''">
						and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  </if>
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="user_id != null and user_id != ''">
						and t1.shopkeeper_user_id = #{user_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t.id,t.user_name,t.user_realname,t1.shopkeeper_user_id
				    union all
				    select t.id ywjl_user_id,t.user_name as ywjl_user_name,t.user_realname as ywjl_user_realname, to_char(wm_concat(t1.id)) as md_id,to_char(wm_concat(t1.store_name)) store_name, t2.user_id,(select user_name from tbl_sys_user_info where id=t2.user_id) user_name,6 user_type
				      from tbl_sys_user_info t,
				            tbl_store_info t1,
				            tbl_store_user_rel t2
				    where t.user_type =4
				      and t.id = t1.manager_user_id
				      and t1.id = t2.store_id
				      and t2.type = 6
				      <if test="ywjl_user_id != null and ywjl_user_id != ''">
						and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  </if>
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="user_id != null and user_id != ''">
						and t2.user_id = #{user_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t.id,t.user_name,t.user_realname,t2.user_id
				      union all
				    select t.id ywjl_user_id,t.user_name as ywjl_user_name,t.user_realname as ywjl_user_realname, to_char(wm_concat(t1.id)) as md_id,to_char(wm_concat(t1.store_name)) store_name, t2.user_id,(select user_name from tbl_sys_user_info where id=t2.user_id) user_name,3 user_type
				      from tbl_sys_user_info t,
				            tbl_store_info t1,
				            tbl_store_user_rel t2
				    where t.user_type =4
				      and t.id = t1.manager_user_id
				      and t1.id = t2.store_id
				      and t2.type = 3
				      <if test="ywjl_user_id != null and ywjl_user_id != ''">
						and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  </if>
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="user_id != null and user_id != ''">
						and t2.user_id = #{user_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t.id,t.user_name,t.user_realname,t2.user_id) a
			      order by a.ywjl_user_id,a.user_id) t)
	</select>
	<!-- 完成量汇总(按人员) -->
	<select id="queryPerformMoneyYwySummary" parameterType="java.util.Map" resultType="java.util.Map">
		select nvl(sum(allPayMoney-preOrderFirstMoney),0) perform_money from (
	        select nvl(sum(PAYMENT_MONEY),0) allPayMoney,0 preOrderFirstMoney from tbl_order_info b where b.payment_state = 2 
	        --时间过滤
	        and to_date(to_char(b.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
	        and to_date(to_char(b.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
	        <if test="(ywjl_user_id != null and ywjl_user_id != '') and (user_id == null or user_id == '')">
				and (b.ywy_user_name in (
				   select (select user_name from tbl_sys_user_info where id=t1.shopkeeper_user_id) user_name
				      from tbl_sys_user_info t,
				           tbl_store_info t1
				    where t.user_type =4
				      and t.id = t1.manager_user_id
						and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t1.shopkeeper_user_id
				    union all
				    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
				      from tbl_sys_user_info t,
				            tbl_store_info t1,
				            tbl_store_user_rel t2
				    where t.user_type =4
				      and t.id = t1.manager_user_id
				      and t1.id = t2.store_id
				      and t2.type = 6
					  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t2.user_id
				      union all
				    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
				      from tbl_sys_user_info t,
				            tbl_store_info t1,
				            tbl_store_user_rel t2
				    where t.user_type =4
				      and t.id = t1.manager_user_id
				      and t1.id = t2.store_id
				      and t2.type = 3
					  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t2.user_id) 
                      or (exists (select 1 from tbl_sys_user_info where id = #{ywjl_user_id,jdbcType=INTEGER} and user_name = b.ywjl_user_name) and b.ywy_user_name is null)
                      )
					</if>
					<if test="user_id != null and user_id != ''">
                      and (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywy_user_name)
						 or (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywjl_user_name) and b.ywy_user_name is null))
                     </if>
                     <if test="public_user_type != null and public_user_type == 9">
						 and exists(select 1 
			                       from tbl_sys_user_info tsui1
			                      where tsui1.user_type = 4
			          				  and tsui1.organization_id in (
									  	select id from tbl_sys_organization_info where connect_by_isleaf=1
									  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
						              )
						          and tsui1.user_name = b.ywjl_user_name)
					</if>
	        union all
	        --尾款订单的定金金额
	        select 0 allPayMoney,nvl(sum(a.PRODUCT_TOTAL_MONEY*(g.EARNEST_MONEY/g.PRODUCT_MONEY)),0) preOrderFirstMoney from TBL_ORDER_PRODUCT a ,TBL_ORDER_INFO b,TBL_PRE_ORDER_RELATE f,TBL_PRE_ORDER_INFO g
	        where a.order_number = f.order_number and f.PRE_ORDER_NUMBER = g.ORDER_NUMBER
	        and a.order_number = b.order_number and b.PAYMENT_STATE = 2
	        --判断时间筛选
	        and to_date(to_char(b.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
	        and to_date(to_char(b.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
	        <if test="(ywjl_user_id != null and ywjl_user_id != '') and (user_id == null or user_id == '')">
				and (b.ywy_user_name in (
				   select (select user_name from tbl_sys_user_info where id=t1.shopkeeper_user_id) user_name
				      from tbl_sys_user_info t,
				           tbl_store_info t1
				    where t.user_type =4
				      and t.id = t1.manager_user_id
						and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t1.shopkeeper_user_id
				    union all
				    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
				      from tbl_sys_user_info t,
				            tbl_store_info t1,
				            tbl_store_user_rel t2
				    where t.user_type =4
				      and t.id = t1.manager_user_id
				      and t1.id = t2.store_id
				      and t2.type = 6
					  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t2.user_id
				      union all
				    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
				      from tbl_sys_user_info t,
				            tbl_store_info t1,
				            tbl_store_user_rel t2
				    where t.user_type =4
				      and t.id = t1.manager_user_id
				      and t1.id = t2.store_id
				      and t2.type = 3
					  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t2.user_id) 
                      or (exists (select 1 from tbl_sys_user_info where id = #{ywjl_user_id,jdbcType=INTEGER} and user_name = b.ywjl_user_name) and b.ywy_user_name is null)
                      )
					</if>
					<if test="user_id != null and user_id != ''">
                      and (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywy_user_name)
						 or (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywjl_user_name) and b.ywy_user_name is null))
                     </if>
                     <if test="public_user_type != null and public_user_type == 9">
						 and exists(select 1 
			                       from tbl_sys_user_info tsui1
			                      where tsui1.user_type = 4
			          				  and tsui1.organization_id in (
									  	select id from tbl_sys_organization_info where connect_by_isleaf=1
									  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
						              )
						          and tsui1.user_name = b.ywjl_user_name)
					</if>)
	</select>
	<!-- 退款数据汇总(按人员) -->
	<select id="queryRefundYwySummary" parameterType="java.util.Map" resultType="java.util.Map">
		select nvl(sum(a.return_total_money),0) refund_order_product_money
            from tbl_order_return_info a,(select order_number from tbl_order_info toi
            								where toi.payment_state = 2
	                                          and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
	                                          and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
	                                          <if test="(ywjl_user_id != null and ywjl_user_id != '') and (user_id == null or user_id == '')">
												and (toi.ywy_user_name in (
												   select (select user_name from tbl_sys_user_info where id=t1.shopkeeper_user_id) user_name
												      from tbl_sys_user_info t,
												           tbl_store_info t1
												    where t.user_type =4
												      and t.id = t1.manager_user_id
														and t.id = #{ywjl_user_id,jdbcType=INTEGER}
													  <if test="md_id != null and md_id != ''">
														and t1.id = #{md_id,jdbcType=INTEGER}
													  </if>
													  <if test="public_user_type != null and public_user_type == 9">
													 	and t.organization_id in (
																  	select id from tbl_sys_organization_info where connect_by_isleaf=1
																  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
													              )
													  </if>
									                  group by t1.shopkeeper_user_id
												    union all
												    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
												      from tbl_sys_user_info t,
												            tbl_store_info t1,
												            tbl_store_user_rel t2
												    where t.user_type =4
												      and t.id = t1.manager_user_id
												      and t1.id = t2.store_id
												      and t2.type = 6
													  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
													  <if test="md_id != null and md_id != ''">
														and t1.id = #{md_id,jdbcType=INTEGER}
													  </if>
													  <if test="public_user_type != null and public_user_type == 9">
													 	and t.organization_id in (
																  	select id from tbl_sys_organization_info where connect_by_isleaf=1
																  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
													              )
													  </if>
									                  group by t2.user_id
												      union all
												    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
												      from tbl_sys_user_info t,
												            tbl_store_info t1,
												            tbl_store_user_rel t2
												    where t.user_type =4
												      and t.id = t1.manager_user_id
												      and t1.id = t2.store_id
												      and t2.type = 3
													  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
													  <if test="md_id != null and md_id != ''">
														and t1.id = #{md_id,jdbcType=INTEGER}
													  </if>
													  <if test="public_user_type != null and public_user_type == 9">
													 	and t.organization_id in (
																  	select id from tbl_sys_organization_info where connect_by_isleaf=1
																  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
													              )
													  </if>
									                  group by t2.user_id) 
								                      or (exists (select 1 from tbl_sys_user_info where id = #{ywjl_user_id,jdbcType=INTEGER} and user_name = toi.ywjl_user_name) and toi.ywy_user_name is null)
								                      )
													</if>
													<if test="user_id != null and user_id != ''">
								                      and (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywy_user_name)
														 or (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywjl_user_name) and toi.ywy_user_name is null))
								                     </if>
								                     <if test="public_user_type != null and public_user_type == 9">
														 and exists(select 1 
											                       from tbl_sys_user_info tsui1
											                      where tsui1.user_type = 4
											          				  and tsui1.organization_id in (
																	  	select id from tbl_sys_organization_info where connect_by_isleaf=1
																	  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
														              )
														          and tsui1.user_name = toi.ywjl_user_name)
													 </if>) t1
			where a.state = 2
			  and a.order_number = t1.order_number
	</select>
	<!-- 退货数据汇总(按人员) -->
	<select id="queryReturnYwySummary" parameterType="java.util.Map" resultType="java.util.Map">
	       select nvl(sum(return_money),0) returns_order_product_money
	        from ${jdbc_user}.tbl_new_return_confirm a,${jdbc_user}.tbl_new_return_order b,tbl_product_sku c,
	        	(select order_number from tbl_order_info toi
   								where toi.payment_state = 2
                                  and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
                                  and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
                                  <if test="(ywjl_user_id != null and ywjl_user_id != '') and (user_id == null or user_id == '')">
									and (toi.ywy_user_name in (
									   select (select user_name from tbl_sys_user_info where id=t1.shopkeeper_user_id) user_name
									      from tbl_sys_user_info t,
									           tbl_store_info t1
									    where t.user_type =4
									      and t.id = t1.manager_user_id
											and t.id = #{ywjl_user_id,jdbcType=INTEGER}
										  <if test="md_id != null and md_id != ''">
											and t1.id = #{md_id,jdbcType=INTEGER}
										  </if>
										  <if test="public_user_type != null and public_user_type == 9">
										 	and t.organization_id in (
													  	select id from tbl_sys_organization_info where connect_by_isleaf=1
													  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
										              )
										  </if>
						                  group by t1.shopkeeper_user_id
									    union all
									    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
									      from tbl_sys_user_info t,
									            tbl_store_info t1,
									            tbl_store_user_rel t2
									    where t.user_type =4
									      and t.id = t1.manager_user_id
									      and t1.id = t2.store_id
									      and t2.type = 6
										  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
										  <if test="md_id != null and md_id != ''">
											and t1.id = #{md_id,jdbcType=INTEGER}
										  </if>
										  <if test="public_user_type != null and public_user_type == 9">
										 	and t.organization_id in (
													  	select id from tbl_sys_organization_info where connect_by_isleaf=1
													  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
										              )
										  </if>
						                  group by t2.user_id
									      union all
									    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
									      from tbl_sys_user_info t,
									            tbl_store_info t1,
									            tbl_store_user_rel t2
									    where t.user_type =4
									      and t.id = t1.manager_user_id
									      and t1.id = t2.store_id
									      and t2.type = 3
										  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
										  <if test="md_id != null and md_id != ''">
											and t1.id = #{md_id,jdbcType=INTEGER}
										  </if>
										  <if test="public_user_type != null and public_user_type == 9">
										 	and t.organization_id in (
													  	select id from tbl_sys_organization_info where connect_by_isleaf=1
													  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
										              )
										  </if>
						                  group by t2.user_id) 
					                      or (exists (select 1 from tbl_sys_user_info where id = #{ywjl_user_id,jdbcType=INTEGER} and user_name = toi.ywjl_user_name) and toi.ywy_user_name is null)
					                      )
										</if>
										<if test="user_id != null and user_id != ''">
					                      and (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywy_user_name)
											 or (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywjl_user_name) and toi.ywy_user_name is null))
					                     </if>
					                     <if test="public_user_type != null and public_user_type == 9">
											 and exists(select 1 
								                       from tbl_sys_user_info tsui1
								                      where tsui1.user_type = 4
								          				  and tsui1.organization_id in (
														  	select id from tbl_sys_organization_info where connect_by_isleaf=1
														  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
											              )
											          and tsui1.user_name = toi.ywjl_user_name)
										 </if>) t1
			where a.product_sku = c.id and a.return_number = b.return_number and b.state = '8' and a.return_flag = 1
			and exists (select 1 from ${jdbc_user}.tbl_new_return_detail_code where return_number = a.return_number and order_number_platform=t1.order_number)
	</select>
	<!-- 今天销额和销量汇总(按人员) -->
	<select id="queryTodayMoneyAndCountYwySummary" parameterType="java.util.Map" resultType="java.util.Map">
   		select nvl(sum(allPayMoney-preOrderFirstMoney),0) today_money,nvl(sum(ALL_ORDER_PRODUCT_COUNT),0) today_count from (
	        select nvl(sum(PAYMENT_MONEY),0) allPayMoney,0 preOrderFirstMoney,nvl(sum(PRODUCT_COUNT),0) ALL_ORDER_PRODUCT_COUNT from tbl_order_info b where b.payment_state = 2 
	        --时间过滤
	        and to_date(to_char(b.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
	        <if test="(ywjl_user_id != null and ywjl_user_id != '') and (user_id == null or user_id == '')">
				and (b.ywy_user_name in (
				   select (select user_name from tbl_sys_user_info where id=t1.shopkeeper_user_id) user_name
				      from tbl_sys_user_info t,
				           tbl_store_info t1
				    where t.user_type =4
				      and t.id = t1.manager_user_id
						and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t1.shopkeeper_user_id
				    union all
				    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
				      from tbl_sys_user_info t,
				            tbl_store_info t1,
				            tbl_store_user_rel t2
				    where t.user_type =4
				      and t.id = t1.manager_user_id
				      and t1.id = t2.store_id
				      and t2.type = 6
					  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t2.user_id
				      union all
				    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
				      from tbl_sys_user_info t,
				            tbl_store_info t1,
				            tbl_store_user_rel t2
				    where t.user_type =4
				      and t.id = t1.manager_user_id
				      and t1.id = t2.store_id
				      and t2.type = 3
					  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t2.user_id) 
                      or (exists (select 1 from tbl_sys_user_info where id = #{ywjl_user_id,jdbcType=INTEGER} and user_name = b.ywjl_user_name) and b.ywy_user_name is null)
                      )
					</if>
					<if test="user_id != null and user_id != ''">
                      and (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywy_user_name)
						 or (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywjl_user_name) and b.ywy_user_name is null))
                     </if>
                     <if test="public_user_type != null and public_user_type == 9">
						 and exists(select 1 
			                       from tbl_sys_user_info tsui1
			                      where tsui1.user_type = 4
			          				  and tsui1.organization_id in (
									  	select id from tbl_sys_organization_info where connect_by_isleaf=1
									  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
						              )
						          and tsui1.user_name = b.ywjl_user_name)
					 </if>
	        union all
	        --尾款订单的定金金额
	        select 0 allPayMoney,nvl(sum(a.PRODUCT_TOTAL_MONEY*(g.EARNEST_MONEY/g.PRODUCT_MONEY)),0) preOrderFirstMoney,0 ALL_ORDER_PRODUCT_COUNT from TBL_ORDER_PRODUCT a ,TBL_ORDER_INFO b,TBL_PRE_ORDER_RELATE f,TBL_PRE_ORDER_INFO g
	        where a.order_number = f.order_number and f.PRE_ORDER_NUMBER = g.ORDER_NUMBER
	        and a.order_number = b.order_number and b.PAYMENT_STATE = 2
	        --判断时间筛选
	        and to_date(to_char(b.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
	        <if test="(ywjl_user_id != null and ywjl_user_id != '') and (user_id == null or user_id == '')">
				and (b.ywy_user_name in (
				   select (select user_name from tbl_sys_user_info where id=t1.shopkeeper_user_id) user_name
				      from tbl_sys_user_info t,
				           tbl_store_info t1
				    where t.user_type =4
				      and t.id = t1.manager_user_id
						and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t1.shopkeeper_user_id
				    union all
				    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
				      from tbl_sys_user_info t,
				            tbl_store_info t1,
				            tbl_store_user_rel t2
				    where t.user_type =4
				      and t.id = t1.manager_user_id
				      and t1.id = t2.store_id
				      and t2.type = 6
					  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t2.user_id
				      union all
				    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
				      from tbl_sys_user_info t,
				            tbl_store_info t1,
				            tbl_store_user_rel t2
				    where t.user_type =4
				      and t.id = t1.manager_user_id
				      and t1.id = t2.store_id
				      and t2.type = 3
					  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
					  <if test="md_id != null and md_id != ''">
						and t1.id = #{md_id,jdbcType=INTEGER}
					  </if>
					  <if test="public_user_type != null and public_user_type == 9">
					 	and t.organization_id in (
								  	select id from tbl_sys_organization_info where connect_by_isleaf=1
								  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
					              )
					  </if>
	                  group by t2.user_id) 
                      or (exists (select 1 from tbl_sys_user_info where id = #{ywjl_user_id,jdbcType=INTEGER} and user_name = b.ywjl_user_name) and b.ywy_user_name is null)
                      )
					</if>
					<if test="user_id != null and user_id != ''">
                      and (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywy_user_name)
						 or (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = b.ywjl_user_name) and b.ywy_user_name is null))
                     </if>
                     <if test="public_user_type != null and public_user_type == 9">
						 and exists(select 1 
			                       from tbl_sys_user_info tsui1
			                      where tsui1.user_type = 4
			          				  and tsui1.organization_id in (
									  	select id from tbl_sys_organization_info where connect_by_isleaf=1
									  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
						              )
						          and tsui1.user_name = b.ywjl_user_name)
					 </if>)
   </select>
   <!-- 今天退款数据汇总(按人员) -->
   <select id="queryTodayRefundYwySummary" parameterType="java.util.Map" resultType="java.util.Map">
   		select nvl(sum(a.return_total_money),0) refund_order_product_money,nvl(sum(a.product_count),0) refund_order_product_count 
            from tbl_order_return_info a,(select order_number from tbl_order_info toi
   								where toi.payment_state = 2
                                  and to_date(to_char(toi.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
                                  <if test="(ywjl_user_id != null and ywjl_user_id != '') and (user_id == null or user_id == '')">
									and (toi.ywy_user_name in (
									   select (select user_name from tbl_sys_user_info where id=t1.shopkeeper_user_id) user_name
									      from tbl_sys_user_info t,
									           tbl_store_info t1
									    where t.user_type =4
									      and t.id = t1.manager_user_id
											and t.id = #{ywjl_user_id,jdbcType=INTEGER}
										  <if test="md_id != null and md_id != ''">
											and t1.id = #{md_id,jdbcType=INTEGER}
										  </if>
										  <if test="public_user_type != null and public_user_type == 9">
										 	and t.organization_id in (
													  	select id from tbl_sys_organization_info where connect_by_isleaf=1
													  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
										              )
										  </if>
						                  group by t1.shopkeeper_user_id
									    union all
									    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
									      from tbl_sys_user_info t,
									            tbl_store_info t1,
									            tbl_store_user_rel t2
									    where t.user_type =4
									      and t.id = t1.manager_user_id
									      and t1.id = t2.store_id
									      and t2.type = 6
										  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
										  <if test="md_id != null and md_id != ''">
											and t1.id = #{md_id,jdbcType=INTEGER}
										  </if>
										  <if test="public_user_type != null and public_user_type == 9">
										 	and t.organization_id in (
													  	select id from tbl_sys_organization_info where connect_by_isleaf=1
													  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
										              )
										  </if>
						                  group by t2.user_id
									      union all
									    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
									      from tbl_sys_user_info t,
									            tbl_store_info t1,
									            tbl_store_user_rel t2
									    where t.user_type =4
									      and t.id = t1.manager_user_id
									      and t1.id = t2.store_id
									      and t2.type = 3
										  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
										  <if test="md_id != null and md_id != ''">
											and t1.id = #{md_id,jdbcType=INTEGER}
										  </if>
										  <if test="public_user_type != null and public_user_type == 9">
										 	and t.organization_id in (
													  	select id from tbl_sys_organization_info where connect_by_isleaf=1
													  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
										              )
										  </if>
						                  group by t2.user_id) 
					                      or (exists (select 1 from tbl_sys_user_info where id = #{ywjl_user_id,jdbcType=INTEGER} and user_name = toi.ywjl_user_name) and toi.ywy_user_name is null)
					                      )
										</if>
										<if test="user_id != null and user_id != ''">
					                      and (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywy_user_name)
											 or (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywjl_user_name) and toi.ywy_user_name is null))
					                     </if>
					                     <if test="public_user_type != null and public_user_type == 9">
											 and exists(select 1 
								                       from tbl_sys_user_info tsui1
								                      where tsui1.user_type = 4
								          				  and tsui1.organization_id in (
														  	select id from tbl_sys_organization_info where connect_by_isleaf=1
														  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
											              )
											          and tsui1.user_name = toi.ywjl_user_name)
										 </if>) t1
			where a.state = 2
			  and a.order_number = t1.order_number
   </select>
   <!-- 今天退货数据汇总(按人员) -->
   <select id="queryTodayReturnYwySummary" parameterType="java.util.Map" resultType="java.util.Map">
		     select nvl(sum(RETURN_MONEY),0) RETURNS_ORDER_PRODUCT_MONEY ,nvl(sum(RETURN_NUM),0) RETURNS_ORDER_PRODUCT_COUNT
		        from ${jdbc_user}.tbl_new_return_confirm a,${jdbc_user}.tbl_new_return_order b,tbl_product_sku c,
		        (select order_number from tbl_order_info toi
   								where toi.payment_state = 2
                                  and to_date(to_char(toi.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
                                  <if test="(ywjl_user_id != null and ywjl_user_id != '') and (user_id == null or user_id == '')">
									and (toi.ywy_user_name in (
									   select (select user_name from tbl_sys_user_info where id=t1.shopkeeper_user_id) user_name
									      from tbl_sys_user_info t,
									           tbl_store_info t1
									    where t.user_type =4
									      and t.id = t1.manager_user_id
											and t.id = #{ywjl_user_id,jdbcType=INTEGER}
										  <if test="md_id != null and md_id != ''">
											and t1.id = #{md_id,jdbcType=INTEGER}
										  </if>
										  <if test="public_user_type != null and public_user_type == 9">
										 	and t.organization_id in (
													  	select id from tbl_sys_organization_info where connect_by_isleaf=1
													  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
										              )
										  </if>
						                  group by t1.shopkeeper_user_id
									    union all
									    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
									      from tbl_sys_user_info t,
									            tbl_store_info t1,
									            tbl_store_user_rel t2
									    where t.user_type =4
									      and t.id = t1.manager_user_id
									      and t1.id = t2.store_id
									      and t2.type = 6
										  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
										  <if test="md_id != null and md_id != ''">
											and t1.id = #{md_id,jdbcType=INTEGER}
										  </if>
										  <if test="public_user_type != null and public_user_type == 9">
										 	and t.organization_id in (
													  	select id from tbl_sys_organization_info where connect_by_isleaf=1
													  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
										              )
										  </if>
						                  group by t2.user_id
									      union all
									    select (select user_name from tbl_sys_user_info where id=t2.user_id) user_name
									      from tbl_sys_user_info t,
									            tbl_store_info t1,
									            tbl_store_user_rel t2
									    where t.user_type =4
									      and t.id = t1.manager_user_id
									      and t1.id = t2.store_id
									      and t2.type = 3
										  and t.id = #{ywjl_user_id,jdbcType=INTEGER}
										  <if test="md_id != null and md_id != ''">
											and t1.id = #{md_id,jdbcType=INTEGER}
										  </if>
										  <if test="public_user_type != null and public_user_type == 9">
										 	and t.organization_id in (
													  	select id from tbl_sys_organization_info where connect_by_isleaf=1
													  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
										              )
										  </if>
						                  group by t2.user_id) 
					                      or (exists (select 1 from tbl_sys_user_info where id = #{ywjl_user_id,jdbcType=INTEGER} and user_name = toi.ywjl_user_name) and toi.ywy_user_name is null)
					                      )
										</if>
										<if test="user_id != null and user_id != ''">
					                      and (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywy_user_name)
											 or (exists (select 1 from tbl_sys_user_info where id = #{user_id,jdbcType=INTEGER} and user_name = toi.ywjl_user_name) and toi.ywy_user_name is null))
					                     </if>
					                     <if test="public_user_type != null and public_user_type == 9">
											 and exists(select 1 
								                       from tbl_sys_user_info tsui1
								                      where tsui1.user_type = 4
								          				  and tsui1.organization_id in (
														  	select id from tbl_sys_organization_info where connect_by_isleaf=1
														  	start with parent_id = #{public_user_organization_id,jdbcType=INTEGER} connect by prior id = parent_id
											              )
											          and tsui1.user_name = toi.ywjl_user_name)
										 </if>) t1
				where a.product_sku = c.id and a.return_number = b.return_number and b.state = '8' and a.return_flag = 1
				and exists (select 1 from ${jdbc_user}.tbl_new_return_detail_code where return_number = a.return_number and order_number_platform=t1.order_number)
   </select>
	
	<!-- 销售指标完成情况统计总数 (按会员)-->
   <select id="querySaleTargetTotalHyCount" parameterType="java.util.Map" resultType="int">
   		select count(1)
          from tbl_user_info tui
          where market_supervision_user_id is not null
          	and market_supervision_user_id != 0
            <include refid="user_where_hy"/>
   	</select>
	<!-- 销售指标完成情况统计分页查询 (按会员) -->
	<select id="querySaleTargetTotalHyListForPage" parameterType="java.util.Map" resultType="java.util.Map">
	    select a.*,
			   nvl((select annual_target from tbl_sale_targets_hy where user_id = a.id
       		   and year = #{year,jdbcType=INTEGER}
       		   and approval_state = 2),0) annual_target,
       		   nvl((select sum(month_value) from tbl_sale_targets_hy_detail where 
			   sale_target_hy_id = (select id from tbl_sale_targets_hy
			   where user_id = a.id
			   and year = #{year,jdbcType=INTEGER}
			   and approval_state = 2)
			   and month_type in 
			   <foreach collection="month_types" item="item" open="(" separator="," close=")" >
			   		#{item}
			   </foreach>
			   ),0) sum_mouth_value
		from
        (select t.*,rownum rn
		  from (select tui.id,
        		tui.market_supervision_user_id as ywjl_user_id,
        		tui.market_supervision_user_realna as ywjl_user_realname,
                tui.store_name,
                case when tui.referee_user_id is not null then referee_user_realname||'(业务员)'
                     else tui.market_supervision_user_realna||'(业务经理)' end user_name,
                tui.login_name,
                tui.user_manage_name
          from tbl_user_info tui
          where market_supervision_user_id is not null
          	and market_supervision_user_id != 0
	        <include refid="user_where_hy"/>
            order by market_supervision_user_id,store_id,referee_user_id) t
				where rownum &lt;= #{end_rownum,jdbcType=INTEGER}) a
        where rn &gt; #{start_rownum,jdbcType=INTEGER}
	</select>
	<!-- 数据获取-完成量(按会员) -->
	<select id="queryHyPerformMoney" parameterType="java.util.Map" resultType="java.util.Map">
		select user_name,nvl(sum(payment_money),0) perform_money
          from tbl_order_info 
          where payment_state = 2
             and to_date(to_char(payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
             and to_date(to_char(payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
             and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)
             group by user_name
	</select>
	<!-- 数据获取-今天销售额和销售量(按会员) -->
	<select id="queryHyTodayMoneyAndCount" parameterType="java.util.Map" resultType="java.util.Map">
		select user_name,nvl(sum(payment_money),0) today_money,nvl(sum(product_count),0) today_count
          from tbl_order_info 
          where payment_state = 2
             and to_date(to_char(payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
             and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)
             group by user_name
	</select>
	<!-- 数据获取-退款订单(按会员) -->
	<select id="queryHyRefundList" parameterType="java.util.Map" resultType="java.util.Map">
	        select a.user_name,nvl(sum(a.return_total_money),0) refund_order_product_money,nvl(sum(a.product_count),0) refund_order_product_count 
	          from tbl_order_return_info a,(select order_number from tbl_order_info toi
            								where toi.payment_state = 2
	                                          and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
	                                          and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
	                                          and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)) t1
			where a.state = 2
			  and a.order_number = t1.order_number
			group by a.user_name
	</select>
	<!-- 数据获取-退货订单(按会员) -->
	<select id="queryHyReturnList" parameterType="java.util.Map" resultType="java.util.Map">
	      select user_name,nvl(sum(RETURN_MONEY),0) RETURNS_ORDER_PRODUCT_MONEY ,nvl(sum(RETURN_NUM),0) RETURNS_ORDER_PRODUCT_COUNT
	        from ${jdbc_user}.tbl_new_return_confirm a,${jdbc_user}.tbl_new_return_order b,tbl_product_sku c,
	        (select order_number from tbl_order_info toi
   								where toi.payment_state = 2
                                  and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
                                  and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
                                  and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)) t1
			where a.product_sku = c.id and a.return_number = b.return_number and b.state = '8' and a.return_flag = 1
			and exists (select 1 from ${jdbc_user}.tbl_new_return_detail_code where return_number = a.return_number and order_number_platform=t1.order_number)
			group by b.user_name
	</select>
	<!-- 数据获取-今天退款订单(按会员) -->
	<select id="queryHyTodayRefundList" parameterType="java.util.Map" resultType="java.util.Map">
	        select a.user_name,nvl(sum(a.return_total_money),0) refund_order_product_money,nvl(sum(a.product_count),0) refund_order_product_count 
	          from tbl_order_return_info a,(select order_number from tbl_order_info toi
            								where toi.payment_state = 2
	                                          and to_date(to_char(toi.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
	                                          and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)) t1
			where a.state = 2
			  and a.order_number = t1.order_number
			group by a.user_name
	</select>
	<!-- 数据获取-今天退货订单(按会员) -->
	<select id="queryHyTodayReturnList" parameterType="java.util.Map" resultType="java.util.Map">
	      select user_name,nvl(sum(return_money),0) returns_order_product_money ,nvl(sum(return_num),0) returns_order_product_count
	        from ${jdbc_user}.tbl_new_return_confirm a,${jdbc_user}.tbl_new_return_order b,tbl_product_sku c,
	        (select order_number from tbl_order_info toi
            					where toi.payment_state = 2
                                  and to_date(to_char(toi.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
                                  and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)) t1
			where a.product_sku = c.id and a.return_number = b.return_number and b.state = '8' and a.return_flag = 1
			and exists (select 1 from ${jdbc_user}.tbl_new_return_detail_code where return_number = a.return_number and order_number_platform=t1.order_number)
			group by b.user_name
	</select>
	
   	<!-- 销售指标完成情况统计汇总 (按会员) -->
	<select id="querySaleTargetTotalHySummary" parameterType="java.util.Map" resultType="java.util.Map">
		select nvl(sum(sum_mouth_value), 0) sum_mouth_value
			  from (
		select nvl((select sum(month_value) from tbl_sale_targets_hy_detail where 
			   sale_target_hy_id = (select id from tbl_sale_targets_hy
			   where user_id = a.id
			   and year = #{year,jdbcType=INTEGER}
			   and approval_state = 2)
			   and month_type in
			   <foreach collection="month_types" item="item" open="(" separator="," close=")" >
			   		#{item}
			   </foreach>
			   ),0) sum_mouth_value
		  from (select tui.id
          from tbl_user_info tui
          where market_supervision_user_id is not null
          	and market_supervision_user_id != 0
            <include refid="user_where_hy"/>
            order by market_supervision_user_id,store_id,referee_user_id) a)
	</select>
	<!-- 数据获取-完成量汇总(按会员) -->
	<select id="queryPerformMoneyHySummary" parameterType="java.util.Map" resultType="java.util.Map">
		select nvl(sum(payment_money),0) perform_money
          from tbl_order_info 
          where payment_state = 2
             and to_date(to_char(payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
             and to_date(to_char(payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
             and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)
	</select>
	<!-- 数据获取-今天销售额和销售量汇总(按会员)  -->
	<select id="queryTodayMoneyAndCountHySummary" parameterType="java.util.Map" resultType="java.util.Map">
		select nvl(sum(payment_money),0) today_money,nvl(sum(product_count),0) today_count
          from tbl_order_info 
          where payment_state = 2
             and to_date(to_char(payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
             and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)
	</select>
	<!-- 数据获取-退款订单汇总(按会员) -->
	<select id="queryRefundHySummary" parameterType="java.util.Map" resultType="java.util.Map">
		select nvl(sum(a.return_total_money),0) refund_order_product_money,nvl(sum(a.product_count),0) refund_order_product_count 
		  from tbl_order_return_info a,(select order_number from tbl_order_info toi
            								where toi.payment_state = 2
	                                          and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
	                                          and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
	                                          and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)) t1
			where a.state = 2
			  and a.order_number = t1.order_number
	</select>
	<!-- 数据获取-退货订单汇总(按会员) -->
	<select id="queryReturnHySummary" parameterType="java.util.Map" resultType="java.util.Map">
		select nvl(sum(RETURN_MONEY),0) RETURNS_ORDER_PRODUCT_MONEY ,nvl(sum(RETURN_NUM),0) RETURNS_ORDER_PRODUCT_COUNT
	        from ${jdbc_user}.tbl_new_return_confirm a,${jdbc_user}.tbl_new_return_order b,tbl_product_sku c,
	        (select order_number from tbl_order_info toi
   								where toi.payment_state = 2
                                  and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') >= to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm') 
                                  and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') &lt;= to_date (#{end_date,jdbcType=VARCHAR}, 'yyyy-mm')
                                  and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)) t1
			where a.product_sku = c.id and a.return_number = b.return_number and b.state = '8' and a.return_flag = 1
			and exists (select 1 from ${jdbc_user}.tbl_new_return_detail_code where return_number = a.return_number and order_number_platform=t1.order_number)
	</select>
	<!-- 数据获取-今天退款订单汇总(按会员) -->
	<select id="queryTodayRefundHySummary" parameterType="java.util.Map" resultType="java.util.Map">
		select nvl(sum(a.return_total_money),0) refund_order_product_money,nvl(sum(a.product_count),0) refund_order_product_count 
		  from tbl_order_return_info a,(select order_number from tbl_order_info toi
            								where toi.payment_state = 2
	                                          and to_date(to_char(toi.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
	                                          and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)) t1
			where a.state = 2
			  and a.order_number = t1.order_number
	</select>
	<!-- 数据获取-退货订单汇总(按会员) -->
	<select id="queryTodayReturnHySummary" parameterType="java.util.Map" resultType="java.util.Map">
		select nvl(sum(return_money),0) returns_order_product_money ,nvl(sum(return_num),0) returns_order_product_count
	        from ${jdbc_user}.tbl_new_return_confirm a,${jdbc_user}.tbl_new_return_order b,tbl_product_sku c,
	        (select order_number from tbl_order_info toi
            					where toi.payment_state = 2
                                  and to_date(to_char(toi.payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date (to_char(sysdate,'yyyy-mm-dd'), 'yyyy-mm-dd')
                                  and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)) t1
			where a.product_sku = c.id and a.return_number = b.return_number and b.state = '8' and a.return_flag = 1
			and exists (select 1 from ${jdbc_user}.tbl_new_return_detail_code where return_number = a.return_number and order_number_platform=t1.order_number)
	</select>
	<!-- 重点客户跟进表 (按会员) -->
	<select id="querySaleTargetTotalEmpHyListForPage" parameterType="java.util.Map" resultType="java.util.Map">
	    select a.*,
       		   nvl((select sum(month_value) from tbl_sale_targets_hy_detail where 
			   sale_target_hy_id = a.id
			   and month_type = #{month_type,jdbcType=INTEGER}
			   ),0) month_target
		from
        (select t.*,rownum rn
		  from (select t.id,
		  		 t.annual_target,
		         tui.market_supervision_user_id as ywjl_user_id,
                 tui.market_supervision_user_realna as ywjl_user_realname,
                 tui.store_name,
                 case when tui.referee_user_id is not null then referee_user_realname||'(业务员)'
                  else tui.market_supervision_user_realna||'(业务经理)' end user_name,
                 t.user_id,
                 tui.login_name,
                 tui.user_manage_name,
                 tui.user_state
           from tbl_sale_targets_hy t,tbl_user_info tui
          where t.approval_state = 2
            and t.year = #{year,jdbcType=INTEGER}
            and t.user_id = tui.id
            and (t.sys_user_id = tui.market_supervision_user_id or t.sys_user_id = tui.referee_user_id)
            <include refid="user_where_hy"/>
            order by t.user_id,tui.market_supervision_user_id,tui.store_id) t
				where rownum &lt;= #{end_rownum,jdbcType=INTEGER}) a
        where rn &gt; #{start_rownum,jdbcType=INTEGER}
	</select>
	<!-- 重点客户跟进表总数 (按会员)-->
   <select id="querySaleTargetTotalEmpHyCount" parameterType="java.util.Map" resultType="int">
   		select count(1)
           from tbl_sale_targets_hy t,tbl_user_info tui
          where t.approval_state = 2
            and t.year = #{year,jdbcType=INTEGER}
            and t.user_id = tui.id
            and (t.sys_user_id = tui.market_supervision_user_id or t.sys_user_id = tui.referee_user_id)
            <include refid="user_where_hy"/>
   	</select>
   	<!-- 查询年度完成量(按会员) -->
   	<select id="queryAnnualPerformMoney" parameterType="java.util.Map" resultType="java.util.Map">
   		select user_name,sum(payment_money) annual_perform_money
          from tbl_order_info 
          where payment_state = 2
             and to_number(to_char(payment_date,'yyyy')) = #{year,jdbcType=INTEGER}
             and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)
             group by user_name
   	</select>
   	<!-- 查询年度退款(按会员) -->
   	<select id="queryAnnualRefundList" parameterType="java.util.Map" resultType="java.util.Map">
   		select a.user_name,nvl(sum(a.return_total_money),0) refund_order_product_money 
   		  from tbl_order_return_info a,(select order_number from tbl_order_info toi
            								where toi.payment_state = 2
	                                          and to_number(to_char(toi.payment_date,'yyyy')) = #{year,jdbcType=INTEGER}
	                                          and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)) t1
			where a.state = 2
			  and a.order_number = t1.order_number
			group by a.user_name
   	</select>
   	<!-- 查询年度退货(按会员) -->
   	<select id="queryAnnualReturnList" parameterType="java.util.Map" resultType="java.util.Map">
   		select user_name,nvl(sum(RETURN_MONEY),0) RETURNS_ORDER_PRODUCT_MONEY
	        from ${jdbc_user}.tbl_new_return_confirm a,${jdbc_user}.tbl_new_return_order b,tbl_product_sku c,
	        (select order_number from tbl_order_info toi
   								where toi.payment_state = 2
                                  and to_number(to_char(toi.payment_date,'yyyy')) = #{year,jdbcType=INTEGER}
                                  and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)) t1
			where a.product_sku = c.id and a.return_number = b.return_number and b.state = '8' and a.return_flag = 1
			and exists (select 1 from ${jdbc_user}.tbl_new_return_detail_code where return_number = a.return_number and order_number_platform=t1.order_number)
			group by b.user_name
   	</select>
   	<!--查询月度完成量(按会员)  -->
   	<select id="queryMonthPerformMoney" parameterType="java.util.Map" resultType="java.util.Map">
   		select user_name,sum(payment_money) month_perform_money
          from tbl_order_info 
          where payment_state = 2
             and to_date(to_char(payment_date,'yyyy-mm'),'yyyy-mm') = to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm')
             and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)
             group by user_name
   	</select>
   	<!-- 查询月度退款(按会员) -->
   	<select id="queryMonthRefundList" parameterType="java.util.Map" resultType="java.util.Map">
   		select a.user_name,nvl(sum(a.return_total_money),0) refund_order_product_money 
   		  from tbl_order_return_info a,(select order_number
								          from tbl_order_info toi
								         where toi.payment_state = 2
								           and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') = to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm')
								           and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)) t1
			where a.state = 2
			  and a.order_number = t1.order_number
			group by a.user_name
   	</select>
   	<!-- 查询月度退货(按会员) -->
   	<select id="queryMonthReturnList" parameterType="java.util.Map" resultType="java.util.Map">
   		select user_name,nvl(sum(RETURN_MONEY),0) RETURNS_ORDER_PRODUCT_MONEY 
	        from ${jdbc_user}.tbl_new_return_confirm a,${jdbc_user}.tbl_new_return_order b,tbl_product_sku c,
	        (select order_number from tbl_order_info toi
					         where toi.payment_state = 2
					           and to_date(to_char(toi.payment_date,'yyyy-mm'),'yyyy-mm') = to_date (#{start_date,jdbcType=VARCHAR}, 'yyyy-mm')
					           and user_name in (select user_name from tbl_user_info tui where 1=1 <include refid="user_where_hy"/>)) t1
			where a.product_sku = c.id and a.return_number = b.return_number and b.state = '8' and a.return_flag = 1
			and exists (select 1 from ${jdbc_user}.tbl_new_return_detail_code where return_number = a.return_number and order_number_platform=t1.order_number)
			group by b.user_name
   	</select>
   	<!-- 获取销售额和销售量按时间分组 -->
   	<select id="querySaleMoneyAndCountToDate" parameterType="java.util.Map" resultType="java.util.Map">
   		select user_name,nvl(sum(payment_money),0) payment_money,nvl(sum(product_count),0) product_count,to_char(payment_date,'dd') time_date
               from tbl_order_info 
               where payment_state = 2
                  and to_char(payment_date,'yyyy-mm') = #{start_date,jdbcType=VARCHAR}
                  and user_name in
                  <foreach collection="list" item="item" open="(" close=")" separator="union all">
                  	select #{item.USER_ID,jdbcType=INTEGER} as user_id
                  	  from dual
                  </foreach>
                  group by user_name,to_char(payment_date,'dd')
                  order by to_char(payment_date,'dd')
   	</select>
   	<!-- 获取退款数据按时间分组(按会员) -->
	<select id="queryRefundMoneyAndCountToDate" parameterType="java.util.Map" resultType="java.util.Map">
	        select a.user_name,nvl(sum(a.return_total_money),0) refund_order_product_money,nvl(sum(a.product_count),0) refund_order_product_count,t1.time_date 
	        from tbl_order_return_info a,(select order_number,to_char(payment_date,'dd') time_date
							               from tbl_order_info 
							               where payment_state = 2
							                  and to_char(payment_date,'yyyy-mm') = #{start_date,jdbcType=VARCHAR}
							                  and user_name in
							                  <foreach collection="list" item="item" open="(" close=")" separator="union all">
							                  	select #{item.USER_ID,jdbcType=INTEGER} as user_id
							                  	  from dual
							                  </foreach>
							                  group by order_number,to_char(payment_date,'dd')) t1
			where a.state = 2
			  and a.order_number = t1.order_number
			group by a.user_name,t1.time_date
			order by t1.time_date
	</select>
	<!-- 获取退货数据按时间分组(按会员) -->
	<select id="queryReturnMoneyAndCountToDate" parameterType="java.util.Map" resultType="java.util.Map">
	      select user_name,nvl(sum(return_money),0) returns_order_product_money ,nvl(sum(return_num),0) returns_order_product_count,t1.time_date
	        from ${jdbc_user}.tbl_new_return_confirm a,${jdbc_user}.tbl_new_return_order b,tbl_product_sku c,
	        (select order_number,to_char(payment_date,'dd') time_date
							               from tbl_order_info 
							               where payment_state = 2
							                  and to_char(payment_date,'yyyy-mm') = #{start_date,jdbcType=VARCHAR}
							                  and user_name in
							                  <foreach collection="list" item="item" open="(" close=")" separator="union all">
							                  	select #{item.USER_ID,jdbcType=INTEGER} as user_id
							                  	  from dual
							                  </foreach>
							                  group by order_number,to_char(payment_date,'dd')) t1
			where a.product_sku = c.id and a.return_number = b.return_number and b.state = '8' and a.return_flag = 1
			and exists (select 1 from ${jdbc_user}.tbl_new_return_detail_code where return_number = a.return_number and order_number_platform=t1.order_number)
			group by b.user_name,t1.time_date
			order by t1.time_date
	</select>
	<!-- 单据列表 -->
	<select id="queryDocumentList" parameterType="java.util.Map" resultType="java.util.Map">
		select order_state,order_number as order_number, product_count as count, payment_money as money,
			to_char(payment_date,'yyyy-mm-dd hh24:mi:ss') time_date ,'订单' type
			  from tbl_order_info
			where user_name = #{user_name,jdbcType=VARCHAR}
			 and payment_state = 2
			 <if test="date_type == 'month'">
				and to_date(to_char(payment_date,'yyyy-mm'),'yyyy-mm') = to_date(#{query_date,jdbcType=VARCHAR},'yyyy-mm')
			 </if>
			 <if test="date_type == 'day'">
				and to_date(to_char(payment_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date(#{query_date,jdbcType=VARCHAR},'yyyy-mm-dd')
			 </if>
			union all
			select 0 order_state,return_number as order_number, product_count as count, return_total_money as money,
			    to_char(check_date,'yyyy-mm-dd hh24:mi:ss') time_date ,'退款单' type
			    from tbl_order_return_info
			    where user_name = #{user_name,jdbcType=VARCHAR}
			      and state = '2'
			      <if test="date_type == 'month'">
					and to_date(to_char(check_date,'yyyy-mm'),'yyyy-mm') = to_date(#{query_date,jdbcType=VARCHAR},'yyyy-mm')
				  </if>
				  <if test="date_type == 'day'">
					and to_date(to_char(check_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date(#{query_date,jdbcType=VARCHAR},'yyyy-mm-dd')
				  </if>
			union all
			select 0 order_state,b.return_number as order_number,nvl(sum(return_num),0) count,nvl(sum(return_money),0)  money,
			to_char(b.refund_date, 'yyyy-mm-dd hh24:mi:ss') time_date, '退货单' type
			from ${jdbc_user}.tbl_new_return_confirm a,${jdbc_user}.tbl_new_return_order b,tbl_product_sku c
			where a.product_sku = c.id
			and a.return_number = b.return_number 
			and b.state = '8'
			and a.return_flag = 1
			and b.user_name = #{user_name,jdbcType=VARCHAR}
			<if test="date_type == 'month'">
				and to_date(to_char(b.refund_date,'yyyy-mm'),'yyyy-mm') = to_date(#{query_date,jdbcType=VARCHAR},'yyyy-mm')
			</if>
			<if test="date_type == 'day'">
				and to_date(to_char(b.refund_date,'yyyy-mm-dd'),'yyyy-mm-dd') = to_date(#{query_date,jdbcType=VARCHAR},'yyyy-mm-dd')
			</if>
			group by b.return_number,b.refund_date
	</select>
</mapper>