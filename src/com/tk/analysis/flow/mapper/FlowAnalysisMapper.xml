<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tk.analysis.flow.dao.FlowAnalysisDao">
	<!-- DW:平台+商品+业务的权限条件 -->
	<sql id="dw_public_psy_where">
	   	and t1.product_key = dp.product_key
	   	and t1.member_key = dm.member_key
	   <!-- 童库平台 -->
	   <if test="public_user_platform_type ==1">
	   		and dp.product_type in (0,1)
	   		and dm.stationed_user_id = 1
	   		<if test="public_user_type != null and public_user_type == 2"><!-- 管理员 -->
	   			<!-- 业务权限 -->
	   			and dm.store_id in 
	   			<foreach collection="ids" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=INTEGER}
				</foreach>
	   	   		<!-- 商品分类 -->
	   	   		and dp.product_first_classify in 
	   	   		<foreach collection="typeIds" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=INTEGER}
				</foreach>
       		</if>
       		<if test="public_user_type != null and public_user_type == 3"><!-- 业务员 -->
			    and dm.ywy_user_id = #{public_user_id,jdbcType=INTEGER}
	        </if>
	        <if test="public_user_type != null and public_user_type == 4"><!-- 业务经理 -->
			    and dm.ywjl_user_id = #{public_user_id,jdbcType=INTEGER}
	        </if>
	        <if test="public_user_type != null and public_user_type == 5"><!-- 店长 -->
			    and dm.dz_user_id = #{public_user_id,jdbcType=INTEGER}
	        </if>
	        <if test="public_user_type != null and public_user_type == 6"><!-- 营业员 -->
	        	and dm.store_id in 
	        	<foreach collection="ids" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=INTEGER}
				</foreach>
	        </if>
	        <if test="public_user_type != null and public_user_type == 9"><!-- 销售管理 -->
	        	and dm.ywjl_user_id in 
	        	<foreach collection="ids" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=INTEGER}
				 </foreach>
	        </if>
	   </if>
	   <!-- 私有平台 -->
	   <if test="public_user_platform_type ==2">
	   		and dp.product_type = 3
	   		and dp.stationed_user_id = #{public_user_stationed_user_id,jdbcType=INTEGER}
			and dm.stationed_user_id = #{public_user_stationed_user_id,jdbcType=INTEGER}
	   </if>
	   <!-- 全部 -->
	   <if test="public_user_platform_type ==9">
	   		and dm.member_key > 0
	   		<if test="public_user_type != null and public_user_type == 2"><!-- 管理员 -->
	   			<!-- 业务权限 -->
	   			and dm.store_id in 
	   			<foreach collection="ids" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=INTEGER}
				</foreach>
	   	   		<!-- 商品分类 -->
	   	   		and dp.product_first_classify in 
	   	   		<foreach collection="typeIds" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=INTEGER}
				</foreach>
       		</if>
	   </if>
	</sql>
	<!-- DW:平台+业务的权限条件 -->
	<sql id="dw_public_py_where">
	   	and t1.member_key = dm.member_key
	   <!-- 童库平台 -->
	   <if test="public_user_platform_type ==1">
	   		and dm.stationed_user_id = 1
	   		<if test="public_user_type != null and public_user_type == 2"><!-- 管理员 -->
	   			<!-- 业务权限 -->
	   			and dm.store_id in 
	   			<foreach collection="ids" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=INTEGER}
				 </foreach>
       		</if>
       		<if test="public_user_type != null and public_user_type == 3"><!-- 业务员 -->
			    and dm.ywy_user_id = #{public_user_id,jdbcType=INTEGER}
	        </if>
	        <if test="public_user_type != null and public_user_type == 4"><!-- 业务经理 -->
			    and dm.ywjl_user_id = #{public_user_id,jdbcType=INTEGER}
	        </if>
	        <if test="public_user_type != null and public_user_type == 5"><!-- 店长 -->
			    and dm.dz_user_id = #{public_user_id,jdbcType=INTEGER}
	        </if>
	        <if test="public_user_type != null and public_user_type == 6"><!-- 营业员 -->
	        	and dm.store_id in 
	        	<foreach collection="ids" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=INTEGER}
				 </foreach>
	        </if>
	        <if test="public_user_type != null and public_user_type == 9"><!-- 销售管理 -->
	        	and dm.ywjl_user_id in 
	        	<foreach collection="ids" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=INTEGER}
				 </foreach>
	        </if>
	   </if>
	   <!-- 私有平台 -->
	   <if test="public_user_platform_type ==2">
			and dm.stationed_user_id = #{public_user_stationed_user_id,jdbcType=INTEGER}
	   </if>
	   <!-- 全部 -->
	   <if test="public_user_platform_type ==9">
	   		and dm.member_key > 0
	   		<if test="public_user_type != null and public_user_type == 2"><!-- 管理员 -->
	   			<!-- 业务权限 -->
	   			and dm.store_id in 
	   			<foreach collection="ids" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=INTEGER}
				 </foreach>
       		</if>
	   </if>
	</sql>
	<!-- DW:平台+商品的权限条件 -->
	<sql id="dw_public_ps_where">
	   <!-- 童库平台 -->
	   <if test="public_user_platform_type ==1">
	   		and t.product_type in (0,1)
	   		<if test="public_user_type != null and public_user_type == 2"><!-- 管理员 -->
	   	   		<!-- 商品分类 -->
	   	   		and t.product_first_classify in 
	   	   		<foreach collection="typeIds" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=INTEGER}
				</foreach>
       		</if>
	   </if>
	   <!-- 私有平台 -->
	   <if test="public_user_platform_type ==2">
	   		and t.product_type = 3
	   		and t.stationed_user_id = #{public_user_stationed_user_id,jdbcType=INTEGER}
	   </if>
	   <!-- 全部 -->
	   <if test="public_user_platform_type ==9">
	   		and t.product_key > 0
	   		<if test="public_user_type != null and public_user_type == 2"><!-- 管理员 -->
	   	   		<!-- 商品分类 -->
	   	   		and t.product_first_classify in 
	   	   		<foreach collection="typeIds" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=INTEGER}
				</foreach>
       		</if>
	   </if>
	</sql>
							<!-- #################        公用         ################ -->
	<!-- 折线图 全站访客数，全站浏览量<天> -->
	<select id="r_queryVisitorPvCountD_Chart" parameterType="java.util.Map" resultType="java.util.Map">
		select create_date,nvl(sum(visitor_count),0) visitor_count,nvl(sum(pv_count),0) pv_count
		  from
		(select dt.hours24_value as create_date,count(distinct a.member_key) visitor_count,count(*) pv_count
		  from
		(select t1.log_time_key,t1.access_terminal_key,t1.member_key
		  from fact_user_log t1,dim_date dt,dim_member dm
		 where t1.log_date_key = dt.date_key
           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   and t1.access_terminal_key > 0
		   <if test="channel_name != null and channel_name != ''">
		   and exists (select 1 from dim_platform_channel where channel_type_name = #{channel_name,jdbcType=VARCHAR} and channel_key = t1.channel_key)
		   </if>
		   <if test="access_terminal_id != null and access_terminal_id != ''">
		   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
		   </if>
		   <include refid="dw_public_py_where"/>) a, dim_time dt
           where a.log_time_key = dt.time_key
           group by dt.hours24_value,a.access_terminal_key)
           group by create_date
           order by create_date
	</select>
	<!-- 折线图 商品访客数，商品浏览量<天> -->
	<select id="r_queryProductVisitorPvCountD_Chart" parameterType="java.util.Map" resultType="java.util.Map">
		select create_date,nvl(sum(visitor_count),0) visitor_count,nvl(sum(pv_count),0) pv_count
		  from
		(select dt.hours24_value create_date,count(distinct a.member_key) visitor_count,count(*) pv_count
		  from
		(select t1.log_time_key,t1.access_terminal_key,t1.member_key
		  from fact_user_log_product t1,dim_date dt,dim_product dp,dim_member dm
		 where t1.log_date_key = dt.date_key
           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   and t1.access_terminal_key > 0
		   <if test="itemnumber != null and itemnumber != ''">
		   and t1.product_key = (select product_key from dim_product where itemnumber = #{itemnumber,jdbcType=VARCHAR})
		   </if>
		   <if test="access_terminal_id != null and access_terminal_id != ''">
		   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
		   </if>
		   <include refid="dw_public_psy_where"/>) a, dim_time dt
           where a.log_time_key = dt.time_key
           group by dt.hours24_value,a.access_terminal_key)
           group by create_date
           order by create_date
	</select>
	<!-- 折线图 下单买家数<天> -->
	<select id="r_queryPurchaseNumberD_Chart" parameterType="java.util.Map" resultType="java.util.Map">
		select create_date,nvl(sum(purchase_number),0) purchase_number
             from
           (select dt.hours24_value create_date, a.access_terminal_key,count(distinct a.member_key) purchase_number
            from (select t1.create_date_time_key,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
            from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
           where t1.create_date_key = dt.date_key
             and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		     and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   <if test="itemnumber != null and itemnumber != ''">
		   and t1.product_key = (select product_key from dim_product where itemnumber = #{itemnumber,jdbcType=VARCHAR})
		   </if>
		   <if test="access_terminal_id == 1">
		   and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 2">
		   and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 4">
		   and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 31">
		   and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 32">
		   and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
		   </if>
		   <include refid="dw_public_psy_where"/>) a,dim_time dt
		   where a.create_date_time_key = dt.time_key
		     and a.access_terminal_key > 0
           group by dt.hours24_value,a.access_terminal_key)
           group by create_date
           order by create_date
	</select>
	<!-- 折线图 支付买家数<天> -->
	<select id="r_queryPayPurchaseNumberD_Chart" parameterType="java.util.Map" resultType="java.util.Map">
		select create_date,nvl(sum(purchase_number),0) purchase_number
             from
           (select dt.hours24_value as create_date, a.access_terminal_key,count(distinct a.member_key) purchase_number
            from (select t1.payment_date_time_key,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
            from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
           where t1.payment_date_key = dt.date_key
             and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		     and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   <if test="itemnumber != null and itemnumber != ''">
		   and t1.product_key = (select product_key from dim_product where itemnumber = #{itemnumber,jdbcType=VARCHAR})
		   </if>
		   <if test="access_terminal_id == 1">
		   and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 2">
		   and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 4">
		   and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 31">
		   and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 32">
		   and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
		   </if>
		   <include refid="dw_public_psy_where"/>) a,dim_time dt
           where a.payment_date_time_key = dt.time_key
             and a.access_terminal_key > 0
           group by dt.hours24_value,a.access_terminal_key)
           group by create_date
           order by create_date
	</select>
	<!-- 折线图 全站访客数，全站浏览量 -->
	<select id="r_queryVisitorPvCount_Chart" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select create_date,nvl(sum(visitor_count),0) visitor_count,nvl(sum(pv_count),0) pv_count
				  from
				(select dt.date_values as create_date,t1.access_terminal_key,count(distinct t1.member_key) visitor_count,nvl(sum(t1.pv),0) pv_count
				  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   and t1.access_terminal_key > 0
				   <if test="channel_name != null and channel_name != ''">
				   and exists (select 1 from dim_platform_channel where channel_type_name = #{channel_name,jdbcType=VARCHAR} and channel_key = t1.channel_key)
				   </if>
				   <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
		           group by dt.date_values,t1.access_terminal_key)
		           group by create_date
			</when>
			<otherwise>
				select create_date,nvl(sum(visitor_count),0) visitor_count,nvl(sum(pv_count),0) pv_count
				  from
				(select dt.date_values as create_date,t1.access_terminal_key,count(distinct t1.member_key) visitor_count,count(*) pv_count
				  from fact_user_log t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   and t1.access_terminal_key > 0
				   <if test="channel_name != null and channel_name != ''">
				   and exists (select 1 from dim_platform_channel where channel_type_name = #{channel_name,jdbcType=VARCHAR} and channel_key = t1.channel_key)
				   </if>
				   <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
		           group by dt.date_values,t1.access_terminal_key)
		           group by create_date
			</otherwise>
		</choose>
	</select>
	<!-- 折线图 商品访客数，商品浏览量 -->
	<select id="r_queryProductVisitorPvCount_Chart" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select create_date,nvl(sum(visitor_count),0) visitor_count,nvl(sum(pv_count),0) pv_count
				  from
				(select dt.date_values as create_date,t1.access_terminal_key,count(distinct t1.member_key) visitor_count,nvl(sum(t1.pv),0) pv_count
				  from fact_user_log_product_pv_d t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   and t1.access_terminal_key > 0
				   <if test="itemnumber != null and itemnumber != ''">
				   and t1.product_key = (select product_key from dim_product where itemnumber = #{itemnumber,jdbcType=VARCHAR})
				   </if>
				   <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
		           group by dt.date_values,t1.access_terminal_key)
		           group by create_date
			</when>
			<otherwise>
				select create_date,nvl(sum(visitor_count),0) visitor_count,nvl(sum(pv_count),0) pv_count
				  from
				(select dt.date_values as create_date,t1.access_terminal_key,count(distinct t1.member_key) visitor_count,count(*) pv_count
				  from fact_user_log_product t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   and t1.access_terminal_key > 0
				   <if test="itemnumber != null and itemnumber != ''">
				   and t1.product_key = (select product_key from dim_product where itemnumber = #{itemnumber,jdbcType=VARCHAR})
				   </if>
				   <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
		           group by dt.date_values,t1.access_terminal_key)
		           group by create_date
			</otherwise>
		</choose>
	</select>
	<!-- 折线图 下单买家数 -->
	<select id="r_queryPurchaseNumber_Chart" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select create_date,nvl(sum(purchase_number),0) purchase_number
		          from (select dt.date_values as create_date,t1.access_terminal_key, count(distinct t1.member_key) purchase_number
			        from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
			       where t1.date_key = dt.date_key 
			         and dt.date_short >= #{start_date,jdbcType=VARCHAR}
					 and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
					 and t1.access_terminal_key > 0
			         and t1.order_count > 0
					 <if test="itemnumber != null and itemnumber != ''">
					 and t1.product_key = (select product_key from dim_product where itemnumber = #{itemnumber,jdbcType=VARCHAR})
					 </if>
					 <if test="access_terminal_id != null and access_terminal_id != ''">
				   	 and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				     </if>
			         <include refid="dw_public_psy_where"/>
			         group by dt.date_values,t1.access_terminal_key)
			         group by create_date
			</when>
			<otherwise>
				select create_date,nvl(sum(purchase_number),0) purchase_number
				  from (select a.create_date,count(distinct a.member_key) purchase_number
		          from (select dt.date_values as create_date,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key, t1.member_key
					from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
				   where t1.create_date_key = dt.date_key
			         and dt.date_short >= #{start_date,jdbcType=VARCHAR}
					 and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
					 <if test="itemnumber != null and itemnumber != ''">
					 and t1.product_key = (select product_key from dim_product where itemnumber = #{itemnumber,jdbcType=VARCHAR})
					 </if>
					 <if test="access_terminal_id == 1">
					 and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
					 </if>
					 <if test="access_terminal_id == 2">
					 and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
					 </if>
					 <if test="access_terminal_id == 4">
					 and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
					 </if>
					 <if test="access_terminal_id == 31">
					 and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
					 </if>
					 <if test="access_terminal_id == 32">
					 and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
					 </if>
					 <include refid="dw_public_psy_where"/>
			         group by dt.date_values) a 
			         group by a.create_date,a.access_terminal_key)
			         group by create_date
			</otherwise>
		</choose>
	</select>
	<!-- 折线图 支付买家数 -->
	<select id="r_queryPayPurchaseNumber_Chart" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select create_date,nvl(sum(purchase_number),0) purchase_number
		          from (select dt.date_values as create_date,t1.access_terminal_key, count(distinct t1.member_key) purchase_number
			        from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
			       where t1.date_key = dt.date_key 
			         and dt.date_short >= #{start_date,jdbcType=VARCHAR}
					 and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
					 and t1.access_terminal_key > 0
			         and t1.pay_money > 0
					 <if test="itemnumber != null and itemnumber != ''">
					 and t1.product_key = (select product_key from dim_product where itemnumber = #{itemnumber,jdbcType=VARCHAR})
					 </if>
					 <if test="access_terminal_id != null and access_terminal_id != ''">
				   	 and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				     </if>
			         <include refid="dw_public_psy_where"/>
			         group by dt.date_values,t1.access_terminal_key)
			         group by create_date
			</when>
			<otherwise>
				select create_date,nvl(sum(purchase_number),0) purchase_number
				  from (select a.create_date,count(distinct a.member_key) purchase_number
		          from (select dt.date_values as create_date,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key, t1.member_key
					from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
				   where t1.payment_date_key = dt.date_key
			         and dt.date_short >= #{start_date,jdbcType=VARCHAR}
					 and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
					 <if test="itemnumber != null and itemnumber != ''">
					 and t1.product_key = (select product_key from dim_product where itemnumber = #{itemnumber,jdbcType=VARCHAR})
					 </if>
					 <if test="access_terminal_id == 1">
					 and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
					 </if>
					 <if test="access_terminal_id == 2">
					 and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
					 </if>
					 <if test="access_terminal_id == 4">
				     and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
				     </if>
				     <if test="access_terminal_id == 31">
				     and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
				     </if>
					 <if test="access_terminal_id == 32">
					 and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
					 </if>
					 <include refid="dw_public_psy_where"/>
			         group by dt.date_values) a 
			         group by a.create_date,a.access_terminal_key)
			         group by create_date
			</otherwise>
		</choose>
	</select>
							<!-- #################        流量概况         ################ -->
	<!-- 流量总览-全站访客数 -->
	<select id="r_queryOverview_VisitorCount" parameterType="java.util.Map" resultType="java.lang.Float">
		<choose>
			<when test="query_type == 'other'">
				select nvl(sum(visitor_count),0)
				  from
				(select t1.access_terminal_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   and t1.access_terminal_key > 0
				   <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
				   group by t1.access_terminal_key)
			</when>
			<otherwise>
				select nvl(sum(visitor_count),0)
				  from
				(select t1.access_terminal_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   and t1.access_terminal_key > 0
				   <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
				   group by t1.access_terminal_key)
			</otherwise>
		</choose>
	</select>
	<!-- 流量总览-全站浏览量 -->
	<select id="r_queryOverview_PvCount" parameterType="java.util.Map" resultType="java.lang.Float">
		<choose>
			<when test="query_type == 'other'">
				select nvl(sum(t1.pv),0)
				  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   and t1.access_terminal_key > 0
				   <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
			</when>
			<otherwise>
				select count(*)
				  from fact_user_log t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   and t1.access_terminal_key > 0
				   <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
			</otherwise>
		</choose>
	</select>
	<!-- 流量来源列表 -->
	<select id="r_queryFlowSourceList" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select channel_type_name as channel_name, nvl(sum(t1.visitor_count),0) visitor_count,nvl(sum(t1.pv_count),0) pv_count
				 from dim_platform_channel t,(
				select t1.channel_key,count(distinct t1.member_key) visitor_count,nvl(sum(t1.pv),0) pv_count
				  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
		           group by t1.access_terminal_key,t1.channel_key) t1
		           where t.channel_key = t1.channel_key(+)
		           group by channel_type_name
		           order by visitor_count desc
			</when>
			<otherwise>
				select channel_type_name as channel_name, nvl(sum(t1.visitor_count),0) visitor_count,nvl(sum(t1.pv_count),0) pv_count
				 from dim_platform_channel t,(
				select t1.channel_key,count(distinct t1.member_key) visitor_count,count(*) pv_count
				  from fact_user_log t1,dim_date dt,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
		           group by t1.access_terminal_key,t1.channel_key) t1
		           where t.channel_key = t1.channel_key(+)
		           group by channel_type_name
		           order by visitor_count desc
			</otherwise>
		</choose>
	</select>
	<!-- 流量来源-引导下单买家数 -->
	<select id="r_queryFlowSource_PurchaseNumber" parameterType="java.util.Map" resultType="java.util.Map">
        <choose>
        	<when test="query_type == 'other'">
        		select channel_type_name as channel_name,
				  	   nvl(sum(purchase_number),0) purchase_number
		          from dim_platform_channel t,
		        (select t1.channel_key,count(distinct t1.member_key) purchase_number
				  from fact_user_log_pv_d t1,dim_date dt,(select t1.access_terminal_key,t1.member_key
											           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   										and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
													    and t1.access_terminal_key > 0
													    and t1.order_count > 0
											           <if test="access_terminal_id != null and access_terminal_id != ''">
													   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
													   </if>
													   <include refid="dw_public_psy_where"/>
													   group by t1.access_terminal_key,t1.member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
		           and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by t1.channel_key,t1.access_terminal_key) t1
		        where t.channel_key = t1.channel_key(+)
		       group by channel_type_name
        	</when>
        	<otherwise>
        		select channel_type_name as channel_name,
				  	   nvl(sum(purchase_number),0) purchase_number
		          from dim_platform_channel t,
		        (select t1.channel_key,count(distinct t1.member_key) purchase_number
				  from fact_user_log t1,dim_date dt,(select access_terminal_key,member_key
				  									   from (select (select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key, t1.member_key
											           from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.create_date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   										and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
											            <if test="access_terminal_id == 1">
														and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
														</if>
														<if test="access_terminal_id == 2">
														and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
														</if>
														<if test="access_terminal_id == 4">
													    and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
													    </if>
													    <if test="access_terminal_id == 31">
													    and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
													    </if>
														<if test="access_terminal_id == 32">
														and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
														</if>
													    <include refid="dw_public_psy_where"/>)
													    group by access_terminal_key,member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
		           and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by t1.channel_key,t1.access_terminal_key) t1
		        where t.channel_key = t1.channel_key(+)
		       group by channel_type_name
        	</otherwise>
        </choose>
	</select>
	<!-- 商品访客总数 -->
	<select id="r_queryProductVisitorCountTotal" parameterType="java.util.Map" resultType="long">
		<choose>
			<when test="query_type == 'other'">
				select nvl(sum(visitor_count),0)
		          from (
		        select t1.product_key,t1.access_terminal_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log_product_pv_d t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
		           group by t1.product_key,t1.access_terminal_key)
			</when>
			<otherwise>
				select nvl(sum(visitor_count),0)
		          from (
		        select t1.product_key,t1.access_terminal_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log_product t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
		           group by t1.product_key,t1.access_terminal_key)
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的商品排行-商品访客数 -->
	<select id="r_queryProductRank_ProductVisitorCount_Product" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select itemnumber
				  from (
				select t.itemnumber,nvl(t1.p_visitor_count,0) p_visitor_count
				  from dim_product t,
				 (select product_key,sum(p_visitor_count) p_visitor_count
				    from
				(select t1.product_key,count(distinct t1.member_key) p_visitor_count
				  from fact_user_log_product_pv_d t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
				   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by})
		           where rownum &lt;= #{num,jdbcType=INTEGER}
			</when>
			<otherwise>
				select itemnumber
				  from (
				select t.itemnumber,nvl(t1.p_visitor_count,0) p_visitor_count
				  from dim_product t,
				 (select product_key,sum(p_visitor_count) p_visitor_count
				    from
				(select t1.product_key,count(distinct t1.member_key) p_visitor_count
				  from fact_user_log_product t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
				   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by})
		           where rownum &lt;= #{num,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的商品排行-商品浏览量 -->
	<select id="r_queryProductRank_ProductPvCount_Product" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select itemnumber
				  from (
				select t.itemnumber,nvl(t1.p_pv_count,0) p_pv_count
				  from dim_product t,
				  (select product_key,sum(p_pv_count) p_pv_count
				  	from
				(select t1.product_key,t1.access_terminal_key,nvl(sum(t1.pv),0) p_pv_count
				  from fact_user_log_product_pv_d t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
				   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by})
		           where rownum &lt;= #{num,jdbcType=INTEGER}
			</when>
			<otherwise>
				select itemnumber
				  from (
				select t.itemnumber,nvl(t1.p_pv_count,0) p_pv_count
				  from dim_product t,
				  (select product_key,sum(p_pv_count) p_pv_count
				  	from
				(select t1.product_key,t1.access_terminal_key,count(*) p_pv_count
				  from fact_user_log_product t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
				   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by})
		           where rownum &lt;= #{num,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的商品排行-支付买家数 -->
	<select id="r_queryProductRank_PayPurchaseNumber_Product" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select itemnumber
				  from (
				select t.itemnumber,nvl(t1.p_purchase_number,0) p_purchase_number
				  from dim_product t,(select product_key,sum(p_purchase_number) p_purchase_number
				     					from
				  					 (select t1.product_key,t1.access_terminal_key,count(distinct t1.member_key) p_purchase_number
							           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
							          where t1.date_key = dt.date_key
							            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   						and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   						and t1.access_terminal_key > 0
				   						and t1.pay_money > 0
							            <if test="access_terminal_id != null and access_terminal_id != ''">
									   	 and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
									    </if>
									   <include refid="dw_public_psy_where"/>
									   group by t1.product_key,t1.access_terminal_key)
									   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by})
		           where rownum &lt;= #{num,jdbcType=INTEGER}
			</when>
			<otherwise>
				select itemnumber
				  from (
				select t.itemnumber,nvl(t1.p_purchase_number,0) p_purchase_number
				  from dim_product t,(select product_key,sum(p_purchase_number) p_purchase_number
				     					from
				  					 (select product_key,count(distinct member_key) p_purchase_number
				  					   from (select t1.product_key,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
							           from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
							          where t1.payment_date_key = dt.date_key
							            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   						and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
							            <if test="access_terminal_id == 1">
										and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
										</if>
										<if test="access_terminal_id == 2">
										and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
										</if>
										<if test="access_terminal_id == 4">
									    and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
									    </if>
									    <if test="access_terminal_id == 31">
									    and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
									    </if>
										<if test="access_terminal_id == 32">
										and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
										</if>
									   <include refid="dw_public_psy_where"/>)
									   group by product_key,access_terminal_key)
									   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by})
		           where rownum &lt;= #{num,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的商品排行-支付转化率 -->
	<select id="r_queryProductRank_PayZhl_Product" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select itemnumber
				  from (
				select t.itemnumber, case when nvl(t2.purchase_number,0) = 0 or nvl(t1.visitor_count,0) = 0  then 0
							else nvl(t2.purchase_number,0)/nvl(t1.visitor_count,0) end p_zhl
				from dim_product t,
				(select product_key,nvl(sum(visitor_count),0) visitor_count
				  from (
				select t1.product_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log_product_pv_d t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
		           group by product_key) t1,
		       (select product_key,nvl(sum(purchase_number),0) purchase_number
				  from (select t1.product_key,t1.access_terminal_key,count(distinct t1.member_key) purchase_number
			           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
			          where t1.date_key = dt.date_key
			            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   	    and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
			            and t1.access_terminal_key > 0
   						and t1.pay_money > 0
			            <if test="access_terminal_id != null and access_terminal_id != ''">
					   	 and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
					    </if>
					   <include refid="dw_public_psy_where"/>
					   group by t1.product_key,t1.access_terminal_key)
		           group by product_key) t2
		         where t.product_key = t1.product_key(+)
		           and t.product_key = t2.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by})
		           where rownum &lt;= #{num,jdbcType=INTEGER}
			</when>
			<otherwise>
				select itemnumber
				  from (
				select t.itemnumber, case when nvl(t2.purchase_number,0) = 0 or nvl(t1.visitor_count,0) = 0  then 0
							else nvl(t2.purchase_number,0)/nvl(t1.visitor_count,0) end p_zhl
				from dim_product t,
				(select product_key,nvl(sum(visitor_count),0) visitor_count
				  from (
				select t1.product_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log_product t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
		           group by product_key) t1,
		       (select product_key,nvl(sum(purchase_number),0) purchase_number
				  from (select product_key,count(distinct member_key) purchase_number
				  	from (select t1.product_key,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
			           from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
			          where t1.payment_date_key = dt.date_key
			            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   	    and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
			            <if test="access_terminal_id == 1">
						and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
						</if>
						<if test="access_terminal_id == 2">
						and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
						</if>
						<if test="access_terminal_id == 4">
					    and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
					    </if>
					    <if test="access_terminal_id == 31">
					    and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
					    </if>
						<if test="access_terminal_id == 32">
						and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
						</if>
					   <include refid="dw_public_psy_where"/>)
					   group by product_key,access_terminal_key)
		           group by product_key) t2
		         where t.product_key = t1.product_key(+)
		           and t.product_key = t2.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by})
		           where rownum &lt;= #{num,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 查询默认排序的商品排行 -->
	<select id="r_queryProductRankListBy_Default" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select itemnumber
				  from (
				select t.itemnumber,nvl(t1.p_pv_count,0) p_pv_count
				  from dim_product t,
				(select product_key,sum(p_pv_count) p_pv_count
				   from
				(select t1.product_key,t1.access_terminal_key,nvl(sum(t1.pv),0) p_pv_count
				  from fact_user_log_product_pv_d t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
				   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		            <include refid="dw_public_ps_where"/>
		           order by p_pv_count desc)
		           where rownum &lt;= #{num,jdbcType=INTEGER}
			</when>
			<otherwise>
				select itemnumber
				  from (
				select t.itemnumber,nvl(t1.p_pv_count,0) p_pv_count
				  from dim_product t,
				(select product_key,sum(p_pv_count) p_pv_count
				   from
				(select t1.product_key,t1.access_terminal_key,count(*) p_pv_count
				  from fact_user_log_product t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
				   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		            <include refid="dw_public_ps_where"/>
		           order by p_pv_count desc)
		           where rownum &lt;= #{num,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 查询排序后的商品信息列表 -->
	<select id="r_queryProductList" parameterType="java.util.Map" resultType="java.util.Map">
		select itemnumber,
			   product_name,
			   product_img_url
		  from dim_product t
		 where itemnumber in
		 <foreach collection="productList" item="item" open="(" close=")" separator=",">
		 	#{item,jdbcType=VARCHAR}
		 </foreach>
		 order by decode(t.itemnumber
		 <foreach collection="productList" item="item" index="_index" open="," close="" separator=",">
            #{item},${_index}
         </foreach>)
	</select>
	<!-- 商品-商品访客数和商品浏览量 -->
	<select id="r_queryProductVisitorPvCount" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select itemnumber,sum(visitor_count) visitor_count,sum(pv_count) pv_count
				  from 
				 (select dp.itemnumber,count(distinct t1.member_key) visitor_count,nvl(sum(t1.pv),0) pv_count
				  from fact_user_log_product_pv_d t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   and dp.itemnumber in
				   <foreach collection="productList" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=VARCHAR}
				   </foreach>
				   <include refid="dw_public_psy_where"/>
				   group by dp.itemnumber,t1.access_terminal_key)
				   group by itemnumber
			</when>
			<otherwise>
				select itemnumber,sum(visitor_count) visitor_count,sum(pv_count) pv_count
				  from 
				 (select dp.itemnumber,count(distinct t1.member_key) visitor_count,count(*) pv_count
				  from fact_user_log_product t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   and dp.itemnumber in
				   <foreach collection="productList" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=VARCHAR}
				   </foreach>
				   <include refid="dw_public_psy_where"/>
				   group by dp.itemnumber,t1.access_terminal_key)
				   group by itemnumber
			</otherwise>
		</choose>
	</select>
	<!-- 商品-下单买家数 -->
	<select id="r_queryProduct_PurchaseNumber" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
			     select itemnumber,sum(purchase_number) purchase_number
			  	   from
				 (select dp.itemnumber,count(distinct t1.member_key) purchase_number
		           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
		          where t1.date_key = dt.date_key
		            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
			   	    and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				    and t1.access_terminal_key > 0
				    and t1.order_count > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   and dp.itemnumber in
				   <foreach collection="productList" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=VARCHAR}
				   </foreach>
				   <include refid="dw_public_psy_where"/>
				   group by dp.itemnumber,t1.access_terminal_key)
				   group by itemnumber
			</when>
			<otherwise>
				 select itemnumber,sum(purchase_number) purchase_number
			  	   from
				 (select itemnumber,count(distinct member_key) purchase_number
				   from
				 (select dp.itemnumber,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
		           from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
		          where t1.create_date_key = dt.date_key
		            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
			   	    and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		            <if test="access_terminal_id == 1">
					and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
					</if>
					<if test="access_terminal_id == 2">
					and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
					</if>
					<if test="access_terminal_id == 4">
				    and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
				    </if>
				    <if test="access_terminal_id == 31">
				    and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
				    </if>
					<if test="access_terminal_id == 32">
					and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
					</if>
					and dp.itemnumber in
				   <foreach collection="productList" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=VARCHAR}
				   </foreach>
				    <include refid="dw_public_psy_where"/>)
				    group by itemnumber,access_terminal_key)
				    group by itemnumber
			</otherwise>
		</choose>
	</select>
	<!-- 商品-支付买家数 -->
	<select id="r_queryProduct_PayPurchaseNumber" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				 select itemnumber,sum(purchase_number) purchase_number
			  	   from
				 (select dp.itemnumber,count(distinct t1.member_key) purchase_number
		           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
		          where t1.date_key = dt.date_key
		            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
			   	    and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				    and t1.access_terminal_key > 0
				    and t1.pay_money > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   and dp.itemnumber in
				   <foreach collection="productList" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=VARCHAR}
				   </foreach>
				   <include refid="dw_public_psy_where"/>
				   group by dp.itemnumber,t1.access_terminal_key)
				   group by itemnumber
			</when>
			<otherwise>
				 select itemnumber,sum(purchase_number) purchase_number
			  	   from
				 (select itemnumber,count(distinct member_key) purchase_number
				   from
				 (select dp.itemnumber,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
		           from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
		          where t1.payment_date_key = dt.date_key
		            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
			   	    and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		            <if test="access_terminal_id == 1">
					and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
					</if>
					<if test="access_terminal_id == 2">
					and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
					</if>
					<if test="access_terminal_id == 4">
				    and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
				    </if>
				    <if test="access_terminal_id == 31">
				    and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
				    </if>
					<if test="access_terminal_id == 32">
					and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
					</if>
					and dp.itemnumber in
				   <foreach collection="productList" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=VARCHAR}
				   </foreach>
				    <include refid="dw_public_psy_where"/>)
				    group by itemnumber,access_terminal_key)
				    group by itemnumber
			</otherwise>
		</choose>
	</select>
	<!-- 流量分布-地区访客总数 -->
	<select id="r_queryAreaVisitorCountTotal" parameterType="java.util.Map" resultType="long">
		<choose>
			<when test="query_type == 'other'">
				select nvl(sum(visitor_count),0)
				  from (
				select dm.user_company_address_city as city_id, count(distinct t1.member_key) visitor_count
				  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
		           group by dm.user_company_address_city,t1.access_terminal_key)
			</when>
			<otherwise>
				select nvl(sum(visitor_count),0)
				  from (
				select dm.user_company_address_city as city_id, count(distinct t1.member_key) visitor_count
				  from fact_user_log t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
		           group by dm.user_company_address_city,t1.access_terminal_key)
			</otherwise>
		</choose>
	</select>
	<!-- 流量分布-城市全站访客数排行 -->
	<select id="r_queryVisitorCountCity_Rank" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select case when a.city_id = 0 then '其他'
					   else (select name from dim_dic_region where region_id = a.city_id) end city_name,visitor_count
				  from (
				select city_id,nvl(sum(visitor_count),0) visitor_count
				  from (
				select dm.user_company_address_city as city_id,count(distinct t1.member_key) visitor_count
				  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
		           group by dm.user_company_address_city,t1.access_terminal_key)
		           group by city_id
		           order by visitor_count desc) a
		           where rownum &lt;= #{num,jdbcType=INTEGER}
			</when>
			<otherwise>
				select case when a.city_id = 0 then '其他'
					   else (select name from dim_dic_region where region_id = a.city_id) end city_name,visitor_count
				  from (
				select city_id,nvl(sum(visitor_count),0) visitor_count
				  from (
				select dm.user_company_address_city as city_id,count(distinct t1.member_key) visitor_count
				  from fact_user_log t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
		           group by dm.user_company_address_city,t1.access_terminal_key)
		           group by city_id
		           order by visitor_count desc) a
		           where rownum &lt;= #{num,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 查询全站访客数排名前十的城市所属省份 -->
	<select id="r_queryFlowDistributionMap" parameterType="java.util.Map" resultMap="areaMap">
		<choose>
			<when test="query_type == 'other'">
				select id,
		               (select name from dim_dic_region where region_id = a.id) name,
		               value
		          from (
		        select t.region_id as id,
		        	   nvl(sum(t1.visitor_count),0) value
		          from dim_dic_region t,
		        (select (select parent_id from dim_dic_region where region_id = a.city_id) province_id,visitor_count
		          from (
		        select city_id,nvl(sum(visitor_count),0) visitor_count
				  from (
				select dm.user_company_address_city as city_id,count(distinct t1.member_key) visitor_count
				  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           and dm.user_company_address_province > 0
		           and dm.user_company_address_city > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
		           group by dm.user_company_address_city,t1.access_terminal_key)
		           group by city_id
		           order by visitor_count desc) a
		           where rownum &lt;= #{num,jdbcType=INTEGER}) t1
		           where t.parent_id in (select region_id from dim_dic_region where parent_id = 0)
		             and t.region_id = t1.province_id(+)
		           group by t.region_id) a
			</when>
			<otherwise>
				select id,
		               (select name from dim_dic_region where region_id = a.id) name,
		               value
		          from (
		        select t.region_id as id,
		        	   nvl(sum(t1.visitor_count),0) value
		          from dim_dic_region t,
		        (select (select parent_id from dim_dic_region where region_id = a.city_id) province_id,visitor_count
		          from (
		        select city_id,nvl(sum(visitor_count),0) visitor_count
				  from (
				select dm.user_company_address_city as city_id,count(distinct t1.member_key) visitor_count
				  from fact_user_log t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           and dm.user_company_address_province > 0
		           and dm.user_company_address_city > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
		           group by dm.user_company_address_city,t1.access_terminal_key)
		           group by city_id
		           order by visitor_count desc) a
		           where rownum &lt;= #{num,jdbcType=INTEGER}) t1
		           where t.parent_id in (select region_id from dim_dic_region where parent_id = 0)
		             and t.region_id = t1.province_id(+)
		           group by t.region_id) a
			</otherwise>
		</choose>
	</select>
							<!-- #################        页面分析         ################ -->
	<!-- 排序获取某一页的频道页-全站访客数 -->
	<select id="r_queryPage_VisitorCount_Page" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select channel_name
				  from (
				select channel_type_name as channel_name,
				  	   nvl(sum(visitor_count),0) visitor_count
		          from dim_platform_channel t,(
		        select channel_key,sum(visitor_count) visitor_count from
				(select t1.channel_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
				   group by t1.channel_key,t1.access_terminal_key)
				   group by channel_key) t1
				   where t.channel_key = t1.channel_key(+)
				   group by channel_type_name
				   order by ${sort} ${sort_by})
			</when>
			<otherwise>
				select channel_name
				  from (
				select channel_type_name as channel_name,
				  	   nvl(sum(visitor_count),0) visitor_count
		          from dim_platform_channel t,(
		        select channel_key,sum(visitor_count) visitor_count from
				(select t1.channel_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log t1,dim_date dt,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
				   group by t1.channel_key,t1.access_terminal_key)
				   group by channel_key) t1
				   where t.channel_key = t1.channel_key(+)
				   group by channel_type_name
				   order by ${sort} ${sort_by})
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的频道页-全站浏览量 -->
	<select id="r_queryPage_PvCount_Page" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select channel_name
				  from (
				select channel_type_name as channel_name,nvl(sum(pv_count),0) pv_count
		          from dim_platform_channel t,(
		        select channel_key,sum(pv_count) pv_count from
				(select t1.channel_key,nvl(sum(t1.pv),0) pv_count
				  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
				   group by t1.channel_key,t1.access_terminal_key)
				   group by channel_key) t1
				   where t.channel_key = t1.channel_key(+)
				   group by channel_type_name
				   order by ${sort} ${sort_by})
			</when>
			<otherwise>
				select channel_name
				  from (
				select channel_type_name as channel_name,
				  	   nvl(sum(pv_count),0) pv_count
		          from dim_platform_channel t,(
		        select channel_key,sum(pv_count) pv_count from
				(select t1.channel_key,count(*) pv_count
				  from fact_user_log t1,dim_date dt,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
				   group by t1.channel_key,t1.access_terminal_key)
				   group by channel_key) t1
				   where t.channel_key = t1.channel_key(+)
				   group by channel_type_name
				   order by ${sort} ${sort_by})
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的频道页-引导下单买家数 -->
	<select id="r_queryPage_PurchaseNumber_Page" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select channel_name
		          from (
		        select channel_type_name as channel_name,
				  	   nvl(sum(o_purchase_number),0) o_purchase_number
		          from dim_platform_channel t,
		        (select channel_key,sum(o_purchase_number) o_purchase_number from
		        (select t1.channel_key,count(distinct t1.member_key) o_purchase_number
				  from fact_user_log_pv_d t1,dim_date dt,(select t1.access_terminal_key,t1.member_key
											           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   										and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
													    and t1.access_terminal_key > 0
													    and t1.order_count > 0
											           <if test="access_terminal_id != null and access_terminal_id != ''">
													   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
													   </if>
													   <include refid="dw_public_psy_where"/>
													   group by t1.access_terminal_key,t1.member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
		           and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by t1.channel_key,t1.access_terminal_key)
		           group by channel_key) t1
		        where t.channel_key = t1.channel_key(+)
		        group by channel_type_name
		       order by ${sort} ${sort_by})
			</when>
			<otherwise>
				select channel_name
		          from (
		        select channel_type_name as channel_name,
				  	   nvl(sum(o_purchase_number),0) o_purchase_number
		          from dim_platform_channel t,
		        (select channel_key,sum(o_purchase_number) o_purchase_number from
		        (select t1.channel_key,count(distinct t1.member_key) o_purchase_number
				  from fact_user_log t1,dim_date dt,(select access_terminal_key,member_key
				  									   from (select (select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key, t1.member_key
											           from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.create_date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   										and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
											            <if test="access_terminal_id == 1">
														and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
														</if>
														<if test="access_terminal_id == 2">
														and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
														</if>
														<if test="access_terminal_id == 4">
													    and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
													    </if>
													    <if test="access_terminal_id == 31">
													    and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
													    </if>
														<if test="access_terminal_id == 32">
														and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
														</if>
													    <include refid="dw_public_psy_where"/>)
													    group by access_terminal_key,member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
		           and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by t1.channel_key,t1.access_terminal_key)
		           group by channel_key) t1
		        where t.channel_key = t1.channel_key(+)
		        group by channel_type_name
		       order by ${sort} ${sort_by})
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的频道页-引导下单转化率 -->
	<select id="r_queryPage_Zhl_Page" parameterType="java.util.Map" resultType="string">
        <choose>
        	<when test="query_type == 'other'">
        		select channel_name
		          from (
				select t.channel_type_name as channel_name, case when nvl(sum(t2.purchase_number),0) = 0 or nvl(sum(t1.visitor_count),0) = 0  then 0
							else nvl(sum(t2.purchase_number),0)/nvl(sum(t1.visitor_count),0) end o_zhl
				  from dim_platform_channel t,(
				  select channel_key,nvl(sum(visitor_count),0) visitor_count
			        from (
			      select t1.channel_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
				   group by t1.channel_key,t1.access_terminal_key)
			       group by channel_key) t1,
			   (select channel_key,nvl(sum(purchase_number),0) purchase_number
		          from (
		        select t1.channel_key,count(distinct t1.member_key) purchase_number
				  from fact_user_log t1,dim_date dt,(select t1.access_terminal_key,t1.member_key
											           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   										and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
													    and t1.access_terminal_key > 0
													    and t1.order_count > 0
											           <if test="access_terminal_id != null and access_terminal_id != ''">
													   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
													   </if>
													   <include refid="dw_public_psy_where"/>
													   group by t1.access_terminal_key,t1.member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
		           and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by t1.channel_key,t1.access_terminal_key)
		           group by channel_key) t2
		           where t.channel_key = t1.channel_key(+)
		             and t.channel_key = t2.channel_key(+)
		           group by channel_type_name
		           order by ${sort} ${sort_by})
        	</when>
        	<otherwise>
        		select channel_name
		          from (
				select t.channel_type_name as channel_name, case when nvl(sum(t2.purchase_number),0) = 0 or nvl(sum(t1.visitor_count),0) = 0  then 0
							else nvl(sum(t2.purchase_number),0)/nvl(sum(t1.visitor_count),0) end o_zhl
				  from dim_platform_channel t,(
				  select channel_key,nvl(sum(visitor_count),0) visitor_count
			        from (
			      select t1.channel_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log t1,dim_date dt,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
				   group by t1.channel_key,t1.access_terminal_key)
			       group by channel_key) t1,
			   (select channel_key,nvl(sum(purchase_number),0) purchase_number
		          from (
		        select t1.channel_key,count(distinct t1.member_key) purchase_number
				  from fact_user_log t1,dim_date dt,(select access_terminal_key,member_key
				  									   from (select (select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key, t1.member_key
											           from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.create_date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   										and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
											            <if test="access_terminal_id == 1">
														and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
														</if>
														<if test="access_terminal_id == 2">
														and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
														</if>
														<if test="access_terminal_id == 4">
													    and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
													    </if>
													    <if test="access_terminal_id == 31">
													    and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
													    </if>
														<if test="access_terminal_id == 32">
														and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
														</if>
													    <include refid="dw_public_psy_where"/>)
													    group by access_terminal_key,member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
		           and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by t1.channel_key,t1.access_terminal_key)
		           group by channel_key) t2
		           where t.channel_key = t1.channel_key(+)
		             and t.channel_key = t2.channel_key(+)
		           group by channel_type_name
		           order by ${sort} ${sort_by})
        	</otherwise>
        </choose>
	</select>
	<!-- 排序获取某一页的频道页-引导支付买家数 -->
	<select id="r_queryPage_PayPurchaseNumber_Page" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select channel_name
		          from (
		        select channel_type_name as channel_name,
				  	   nvl(sum(p_purchase_number),0) p_purchase_number
		          from dim_platform_channel t,
		        (select channel_key,sum(p_purchase_number) p_purchase_number from
		        (select t1.channel_key,count(distinct t1.member_key) p_purchase_number
				  from fact_user_log_pv_d t1,dim_date dt,(select t1.access_terminal_key,t1.member_key
											           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   										and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
													    and t1.access_terminal_key > 0
													    and t1.pay_money > 0
											           <if test="access_terminal_id != null and access_terminal_id != ''">
													   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
													   </if>
													   <include refid="dw_public_psy_where"/>
													   group by t1.access_terminal_key,t1.member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
		           and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by t1.channel_key,t1.access_terminal_key)
		           group by channel_key) t1
		        where t.channel_key = t1.channel_key(+)
		       group by channel_type_name
		       order by ${sort} ${sort_by})
			</when>
			<otherwise>
				select channel_name
		          from (
		        select channel_type_name as channel_name,
				  	   nvl(sum(p_purchase_number),0) p_purchase_number
		          from dim_platform_channel t,
		        (select channel_key,sum(p_purchase_number) p_purchase_number from
		        (select t1.channel_key,count(distinct t1.member_key) p_purchase_number
				  from fact_user_log t1,dim_date dt,(select access_terminal_key,member_key
				  									   from (select (select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key, t1.member_key
											           from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.payment_date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   										and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
											            <if test="access_terminal_id == 1">
														and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
														</if>
														<if test="access_terminal_id == 2">
														and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
														</if>
														<if test="access_terminal_id == 4">
													    and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
													    </if>
													    <if test="access_terminal_id == 31">
													    and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
													    </if>
														<if test="access_terminal_id == 32">
														and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
														</if>
													    <include refid="dw_public_psy_where"/>)
													    group by access_terminal_key,member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
		           and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by t1.channel_key,t1.access_terminal_key)
		           group by channel_key) t1
		        where t.channel_key = t1.channel_key(+)
		       group by channel_type_name
		       order by ${sort} ${sort_by})
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的频道页-引导支付转化率 -->
	<select id="r_queryPage_PayZhl_Page" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select channel_name
		          from (
				select t.channel_type_name as channel_name, case when nvl(sum(t2.purchase_number),0) = 0 or nvl(sum(t1.visitor_count),0) = 0  then 0
							else nvl(sum(t2.purchase_number),0)/nvl(sum(t1.visitor_count),0) end p_zhl
				  from dim_platform_channel t,(
				  select channel_key,nvl(sum(visitor_count),0) visitor_count
			        from (
			      select t1.channel_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
				   group by t1.channel_key,t1.access_terminal_key)
			       group by channel_key) t1,
			   (select channel_key,nvl(sum(purchase_number),0) purchase_number
		          from (
		        select t1.channel_key,count(distinct t1.member_key) purchase_number
				  from fact_user_log t1,dim_date dt,(select t1.access_terminal_key,t1.member_key
											           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   									    and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
													    and t1.access_terminal_key > 0
													    and t1.pay_money > 0
											           <if test="access_terminal_id != null and access_terminal_id != ''">
													   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
													   </if>
													   <include refid="dw_public_psy_where"/>
													   group by t1.access_terminal_key,t1.member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
		           and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by t1.channel_key,t1.access_terminal_key)
		           group by channel_key) t2
		           where t.channel_key = t1.channel_key(+)
		             and t.channel_key = t2.channel_key(+)
		           group by channel_type_name
		           order by ${sort} ${sort_by})
			</when>
			<otherwise>
				select channel_name
		          from (
				select t.channel_type_name as channel_name, case when nvl(sum(t2.purchase_number),0) = 0 or nvl(sum(t1.visitor_count),0) = 0  then 0
							else nvl(sum(t2.purchase_number),0)/nvl(sum(t1.visitor_count),0) end p_zhl
				  from dim_platform_channel t,(
				  select channel_key,nvl(sum(visitor_count),0) visitor_count
			        from (
			      select t1.channel_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log t1,dim_date dt,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
				   group by t1.channel_key,t1.access_terminal_key)
			       group by channel_key) t1,
			   (select channel_key,nvl(sum(purchase_number),0) purchase_number
		          from (
		        select t1.channel_key,count(distinct t1.member_key) purchase_number
				  from fact_user_log t1,dim_date dt,(select access_terminal_key,member_key
				  									   from (select (select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key, t1.member_key
											           from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.payment_date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   										and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
											            <if test="access_terminal_id == 1">
														and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
														</if>
														<if test="access_terminal_id == 2">
														and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
														</if>
														<if test="access_terminal_id == 4">
													    and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
													    </if>
													    <if test="access_terminal_id == 31">
													    and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
													    </if>
														<if test="access_terminal_id == 32">
														and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
														</if>
													    <include refid="dw_public_psy_where"/>)
													    group by access_terminal_key,member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
		           and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by t1.channel_key,t1.access_terminal_key)
		           group by channel_key) t2
		           where t.channel_key = t1.channel_key(+)
		             and t.channel_key = t2.channel_key(+)
		           group by channel_type_name
		           order by ${sort} ${sort_by})
			</otherwise>
		</choose>
	</select>
	<!-- 查询默认排序的频道页 -->
	<select id="r_queryPageListBy_Default" parameterType="java.util.Map" resultType="string">
		select channel_type_name as channel_name
		  from dim_platform_channel
		 group by channel_type_name,channel_type
		 order by channel_type
	</select>
	<!-- 查询系统页和自定义页列表 -->
	<select id="r_queryPageList" parameterType="java.util.Map" resultType="java.util.Map">
		select channel_name
		  from 
		(select channel_type_name as channel_name
		  from dim_platform_channel
		  group by channel_type_name) t
        where channel_name in 
         <foreach collection="pageList" item="item" open="(" close=")" separator=",">
		 	#{item,jdbcType=VARCHAR}
		 </foreach>
		 order by decode(t.channel_name
		 <foreach collection="pageList" item="item" index="_index" open="," close="" separator=",">
            #{item,jdbcType=VARCHAR},${_index}
         </foreach>)
	</select>
	<!-- 页面列表-全站访客数，全站浏览量 -->
	<select id="r_queryPage_VisitorPvCount" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select channel_type_name as channel_name,nvl(sum(visitor_count),0) visitor_count,nvl(sum(pv_count),0) pv_count
				  from dim_platform_channel t,(
				  select channel_key,sum(visitor_count) visitor_count,sum(pv_count) pv_count from
				  (select t1.channel_key,count(distinct t1.member_key) visitor_count,nvl(sum(t1.pv),0) pv_count
				  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
				   group by t1.channel_key,t1.access_terminal_key)
				   group by channel_key) t1
				   where t.channel_key = t1.channel_key(+)
		             and t.channel_type_name in 
		         <foreach collection="pageList" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=VARCHAR}
				 </foreach>
				 group by channel_type_name
			</when>
			<otherwise>
				select channel_type_name as channel_name,nvl(sum(visitor_count),0) visitor_count,nvl(sum(pv_count),0) pv_count
				  from dim_platform_channel t,(
				  select channel_key,sum(visitor_count) visitor_count,sum(pv_count) pv_count from
				  (select t1.channel_key,count(distinct t1.member_key) visitor_count,count(*) pv_count
				  from fact_user_log t1,dim_date dt,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
				   group by t1.channel_key,t1.access_terminal_key)
				   group by channel_key) t1
				   where t.channel_key = t1.channel_key(+)
		             and t.channel_type_name in 
		         <foreach collection="pageList" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=VARCHAR}
				 </foreach>
				 group by channel_type_name
			</otherwise>
		</choose>
	</select>
	<!-- 页面列表-引导下单买家数 -->
	<select id="r_queryPage_PurchaseNumber" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select channel_type_name as channel_name,nvl(sum(purchase_number),0) purchase_number
		          from dim_platform_channel t,(
		        select channel_key,sum(purchase_number) purchase_number from
		        (select t1.channel_key,count(distinct t1.member_key) purchase_number
				  from fact_user_log_pv_d t1,dim_date dt,(select t1.access_terminal_key,t1.member_key
											           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
						   								and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
													    and t1.access_terminal_key > 0
													    and t1.order_count > 0
											           <if test="access_terminal_id != null and access_terminal_id != ''">
													   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
													   </if>
													   <include refid="dw_public_psy_where"/>
													   group by t1.access_terminal_key,t1.member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
		           and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by t1.channel_key,t1.access_terminal_key)
		           group by channel_key) t1
		           where t.channel_key = t1.channel_key(+)
		             and t.channel_type_name in 
		         <foreach collection="pageList" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=VARCHAR}
				 </foreach>
				 group by channel_type_name
			</when>
			<otherwise>
				select channel_type_name as channel_name,nvl(sum(purchase_number),0) purchase_number
		          from dim_platform_channel t,(
		        select channel_key,sum(purchase_number) purchase_number from
		        (select t1.channel_key,count(distinct t1.member_key) purchase_number
				  from fact_user_log t1,dim_date dt,(select access_terminal_key,member_key
				  									   from (select (select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key, t1.member_key
											           from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.create_date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   										and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
											            <if test="access_terminal_id == 1">
														and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
														</if>
														<if test="access_terminal_id == 2">
														and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
														</if>
														<if test="access_terminal_id == 4">
													    and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
													    </if>
													    <if test="access_terminal_id == 31">
													    and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
													    </if>
														<if test="access_terminal_id == 32">
														and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
														</if>
													    <include refid="dw_public_psy_where"/>)
													    group by access_terminal_key,member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
		           and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by t1.channel_key,t1.access_terminal_key)
		           group by channel_key) t1
		           where t.channel_key = t1.channel_key(+)
		             and t.channel_type_name in 
		         <foreach collection="pageList" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=VARCHAR}
				 </foreach>
				 group by channel_type_name
			</otherwise>
		</choose>
	</select>
	<!-- 页面列表-引导支付买家数 -->
	<select id="r_queryPage_PayPurchaseNumber" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select channel_type_name as channel_name,nvl(sum(purchase_number),0) purchase_number
		          from dim_platform_channel t,(
		        select channel_key,sum(purchase_number) purchase_number from
		        (select t1.channel_key,count(distinct t1.member_key) purchase_number
				  from fact_user_log_pv_d t1,dim_date dt,(select t1.access_terminal_key,t1.member_key
											           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
						   								and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
													    and t1.access_terminal_key > 0
													    and t1.pay_money > 0
											           <if test="access_terminal_id != null and access_terminal_id != ''">
													   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
													   </if>
													   <include refid="dw_public_psy_where"/>
													   group by t1.access_terminal_key,t1.member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
		           and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by t1.channel_key,t1.access_terminal_key)
		           group by channel_key) t1
		           where t.channel_key = t1.channel_key(+)
		             and t.channel_type_name in 
		         <foreach collection="pageList" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=VARCHAR}
				 </foreach>
				 group by channel_type_name
			</when>
			<otherwise>
				select channel_type_name as channel_name,nvl(sum(purchase_number),0) purchase_number
		          from dim_platform_channel t,(
		        select channel_key,sum(purchase_number) purchase_number from
		        (select t1.channel_key,count(distinct t1.member_key) purchase_number
				  from fact_user_log t1,dim_date dt,(select access_terminal_key,member_key
				  									   from (select (select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key, t1.member_key
											           from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.payment_date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   										and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
											            <if test="access_terminal_id == 1">
														and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
														</if>
														<if test="access_terminal_id == 2">
														and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
														</if>
														<if test="access_terminal_id == 4">
													    and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
													    </if>
													    <if test="access_terminal_id == 31">
													    and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
													    </if>
														<if test="access_terminal_id == 32">
														and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
														</if>
													    <include refid="dw_public_psy_where"/>)
													    group by access_terminal_key,member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
		           and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by t1.channel_key,t1.access_terminal_key)
		           group by channel_key) t1
		           where t.channel_key = t1.channel_key(+)
		             and t.channel_type_name in 
		         <foreach collection="pageList" item="item" open="(" close=")" separator=",">
				 	#{item,jdbcType=VARCHAR}
				 </foreach>
				 group by channel_type_name
			</otherwise>
		</choose>
	</select>
	<!-- 趋势分析 折线图 引导下单买家数<天> -->
	<select id="r_queryPageTrend_PurchaseNumberD_Chart" parameterType="java.util.Map" resultType="java.util.Map">
		<!-- 当天订单下单时间的会员和订单所属终端，比较当天日志表访问的会员和日志所属终端，最后以下单时间按小时分组每个终端的下单买家数，并按小时合计下单买家数 -->
		select create_date,nvl(sum(purchase_number),0) purchase_number
             from
           (select dt.hours24_value as create_date, a.access_terminal_key,count(distinct a.member_key) purchase_number
            from (select t1.create_date_time_key,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
            from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
           where t1.create_date_key = dt.date_key
           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   <if test="access_terminal_id == 1">
		   and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 2">
		   and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 4">
		   and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 31">
		   and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 32">
		   and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
		   </if>
		   <include refid="dw_public_psy_where"/>) a,
           (select t1.log_time_key,t1.access_terminal_key,t1.member_key
              from fact_user_log t1,dim_date dt,dim_member dm
              where t1.log_date_key = dt.date_key
               and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		       and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
               and t1.access_terminal_key > 0
               and exists (select 1 from dim_platform_channel where channel_type_name = #{channel_name,jdbcType=VARCHAR} and channel_key = t1.channel_key)
               <if test="access_terminal_id != null and access_terminal_id != ''">
			   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
			   </if>
			   <include refid="dw_public_py_where"/>
               group by t1.log_time_key,t1.access_terminal_key,t1.member_key) b,dim_time dt
           where a.access_terminal_key = b.access_terminal_key
             and a.member_key = b.member_key
             and a.create_date_time_key = dt.time_key
             and a.create_date_time_key = b.log_time_key
           group by dt.hours24_value,a.access_terminal_key)
           group by create_date
           order by create_date
	</select>
	<!-- 趋势分析 折线图 引导支付买家数<天> -->
	<select id="r_queryPageTrend_PayPurchaseNumberD_Chart" parameterType="java.util.Map" resultType="java.util.Map">
		<!-- 当天订单支付时间的会员和订单所属终端，比较当天日志表访问的会员和日志所属终端，最后以支付时间按小时分组每个终端的支付买家数，并按小时合计支付买家数 -->
		select create_date,nvl(sum(purchase_number),0) purchase_number
             from
           (select dt.hours24_value as create_date, a.access_terminal_key,count(distinct a.member_key) purchase_number
            from (select t1.payment_date_time_key,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
            from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
           where t1.payment_date_key = dt.date_key
           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   <if test="access_terminal_id == 1">
		   and exists (select 1 from dim_order where payment_state = 2 and order_source in (2,3) and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 2">
		   and exists (select 1 from dim_order where payment_state = 2 and order_source = 1 and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 4">
		   and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 31">
		   and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
		   </if>
		   <if test="access_terminal_id == 32">
		   and exists (select 1 from dim_order where payment_state = 2 and order_source = 4 and order_key = t1.order_key)
		   </if>
		   <include refid="dw_public_psy_where"/>) a,
           (select t1.log_time_key,t1.access_terminal_key,t1.member_key
              from fact_user_log t1,dim_date dt,dim_member dm
              where t1.log_date_key = dt.date_key
               and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		       and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
               and t1.access_terminal_key > 0
               and exists (select 1 from dim_platform_channel where channel_type_name = #{channel_name,jdbcType=VARCHAR} and channel_key = t1.channel_key)
               <if test="access_terminal_id != null and access_terminal_id != ''">
			   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
			   </if>
			   <include refid="dw_public_py_where"/>
               group by t1.log_time_key,t1.access_terminal_key,t1.member_key) b,dim_time dt
           where a.access_terminal_key = b.access_terminal_key
             and a.member_key = b.member_key
             and a.payment_date_time_key = dt.time_key
             and a.payment_date_time_key = b.log_time_key
           group by dt.hours24_value,a.access_terminal_key)
           group by create_date
           order by create_date
	</select>
	<!-- 趋势分析 折线图 引导下单买家数 -->
	<select id="r_queryPageTrend_PurchaseNumber_Chart" parameterType="java.util.Map" resultType="java.util.Map">
	<!-- 根据订单下单时间区间的会员和订单所属终端，比较日志表访问的会员和日志所属终端，最后以下单时间按天分组每个终端的下单买家数，并按天合计下单买家数 -->
		<choose>
			<when test="query_type == 'other'">
				select create_date,nvl(sum(purchase_number),0) purchase_number
	             from
	           (select dt.date_values as create_date,count(distinct t1.member_key) purchase_number
				  from fact_user_log_pv_d t1,dim_date dt,(select t1.date_key,t1.access_terminal_key,t1.member_key
											           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   										and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
													    and t1.access_terminal_key > 0
													    and t1.order_count > 0
											           <if test="access_terminal_id != null and access_terminal_id != ''">
													   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
													   </if>
													   <include refid="dw_public_psy_where"/>
													   group by t1.date_key,t1.access_terminal_key,t1.member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           and exists (select 1 from dim_platform_channel where channel_type_name = #{channel_name,jdbcType=VARCHAR} and channel_key = t1.channel_key)
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   and t1.log_date_key = t2.date_key and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by dt.date_values,t1.access_terminal_key)
		           group by create_date
	           	   order by create_date
			</when>
			<otherwise>
				select create_date,nvl(sum(purchase_number),0) purchase_number
	             from
	           (select a.create_date, a.access_terminal_key,count(distinct a.member_key) purchase_number
	            from 
	           (select dt.date_values as create_date,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
	            from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
	           where t1.create_date_key = dt.date_key
	           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
			   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
			   <if test="access_terminal_id == 1">
			   and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
			   </if>
			   <if test="access_terminal_id == 2">
			   and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
			   </if>
			   <if test="access_terminal_id == 4">
			   and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
			   </if>
			   <if test="access_terminal_id == 31">
			   and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
			   </if>
			   <if test="access_terminal_id == 32">
			   and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
			   </if>
			   <include refid="dw_public_psy_where"/>) a,
	           (select dt.date_values as create_date,t1.access_terminal_key,t1.member_key
	              from fact_user_log t1,dim_date dt,dim_member dm
	              where t1.log_date_key = dt.date_key
	               and dt.date_short >= #{start_date,jdbcType=VARCHAR}
			   	   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
	               and t1.access_terminal_key > 0
	               and exists (select 1 from dim_platform_channel where channel_type_name = #{channel_name,jdbcType=VARCHAR} and channel_key = t1.channel_key)
	               <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
	               group by dt.date_values,t1.access_terminal_key,t1.member_key) b
	           where a.create_date = b.create_date
	             and a.access_terminal_key = b.access_terminal_key
	             and a.member_key = b.member_key
	           group by a.create_date,a.access_terminal_key)
	           group by create_date
	           order by create_date
			</otherwise>
		</choose>
	</select>
	<!-- 趋势分析 折线图 引导支付买家数 -->
	<select id="r_queryPageTrend_PayPurchaseNumber_Chart" parameterType="java.util.Map" resultType="java.util.Map">
		<!-- 根据订单支付时间区间的会员和订单所属终端，比较日志表访问的会员和日志所属终端，最后以支付时间按天分组每个终端的支付买家数，并按天合计支付买家数 -->
		<choose>
			<when test="query_type == 'other'">
				select create_date,nvl(sum(purchase_number),0) purchase_number
	             from
	           (select dt.date_values as create_date,count(distinct t1.member_key) purchase_number
				  from fact_user_log_pv_d t1,dim_date dt,(select t1.date_key,t1.access_terminal_key,t1.member_key
											           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
											          where t1.date_key = dt.date_key
											            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   										and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
													    and t1.access_terminal_key > 0
													    and t1.pay_money > 0
											           <if test="access_terminal_id != null and access_terminal_id != ''">
													   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
													   </if>
													   <include refid="dw_public_psy_where"/>
													   group by t1.date_key,t1.access_terminal_key,t1.member_key) t2,dim_member dm
				  where t1.log_date_key = dt.date_key
				   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_terminal_key > 0
		           and exists (select 1 from dim_platform_channel where channel_type_name = #{channel_name,jdbcType=VARCHAR} and channel_key = t1.channel_key)
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   and t1.log_date_key = t2.date_key and t1.access_terminal_key = t2.access_terminal_key and t1.member_key = t2.member_key
		           <include refid="dw_public_py_where"/>
		           group by dt.date_values,t1.access_terminal_key)
		           group by create_date
	           	   order by create_date
			</when>
			<otherwise>
				select create_date,nvl(sum(purchase_number),0) purchase_number
	             from
	           (select a.create_date, a.access_terminal_key,count(distinct a.member_key) purchase_number
	            from 
	           (select dt.date_values as create_date,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
	            from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
	           where t1.payment_date_key = dt.date_key
	           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
			   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
			   <if test="access_terminal_id == 1">
			   and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
			   </if>
			   <if test="access_terminal_id == 2">
			   and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
			   </if>
			   <if test="access_terminal_id == 4">
			   and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
			   </if>
			   <if test="access_terminal_id == 31">
			   and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
			   </if>
			   <if test="access_terminal_id == 32">
			   and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
			   </if>
			   <include refid="dw_public_psy_where"/>) a,
	           (select dt.date_values as create_date,t1.access_terminal_key,t1.member_key
	              from fact_user_log t1,dim_date dt,dim_member dm
	              where t1.log_date_key = dt.date_key
	               and dt.date_short >= #{start_date,jdbcType=VARCHAR}
			   	   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
	               and t1.access_terminal_key > 0
	               and exists (select 1 from dim_platform_channel where channel_type_name = #{channel_name,jdbcType=VARCHAR} and channel_key = t1.channel_key)
	               <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
	               group by dt.date_values,t1.access_terminal_key,t1.member_key) b
	           where a.create_date = b.create_date
	             and a.access_terminal_key = b.access_terminal_key
	             and a.member_key = b.member_key
	           group by a.create_date,a.access_terminal_key)
	           group by create_date
	           order by create_date
			</otherwise>
		</choose>
	</select>
	<!-- 查询商品总数 -->
	<select id="r_queryProductCount" parameterType="java.util.Map" resultType="int">
		select count(1)
		  from dim_product t
		 <where>
		 	<include refid="dw_public_ps_where"/>
		 </where>
	</select>
	<!-- 排序获取某一页的商品信息-商品访客数 -->
	<select id="r_queryProductVisitorCount_Product" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select itemnumber
				  from (
				select a.*,rownum rn
				  from (
				select t.itemnumber,nvl(p_visitor_count,0) p_visitor_count
				  from dim_product t,(
				select product_key,sum(p_visitor_count) p_visitor_count from
				(select t1.product_key,count(distinct t1.member_key) p_visitor_count
				  from fact_user_log_product_pv_d t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
				   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by}) a)
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</when>
			<otherwise>
				select itemnumber
				  from (
				select a.*,rownum rn
				  from (
				select t.itemnumber,nvl(p_visitor_count,0) p_visitor_count
				  from dim_product t,(
				select product_key,sum(p_visitor_count) p_visitor_count from
				(select t1.product_key,count(distinct t1.member_key) p_visitor_count
				  from fact_user_log_product t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
				   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by}) a)
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的商品信息-商品浏览量 -->
	<select id="r_queryProductPvCount_Product" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select itemnumber
				  from (
				select a.*,rownum rn
				  from (
				select t.itemnumber,nvl(t1.p_pv_count,0) p_pv_count
				  from dim_product t,(
				select product_key,sum(p_pv_count) p_pv_count from
				(select t1.product_key,t1.access_terminal_key,nvl(sum(t1.pv),0) p_pv_count
				  from fact_user_log_product_pv_d t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
				   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by}) a )
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</when>
			<otherwise>
				select itemnumber
				  from (
				select a.*,rownum rn
				  from (
				select t.itemnumber,nvl(t1.p_pv_count,0) p_pv_count
				  from dim_product t,(
				select product_key,sum(p_pv_count) p_pv_count from
				(select t1.product_key,t1.access_terminal_key,count(*) p_pv_count
				  from fact_user_log_product t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
				   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by}) a )
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的商品信息-下单买家数 -->
	<select id="r_queryProduct_PurchaseNumber_Product" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select itemnumber
				  from (
				select a.*,rownum rn
				  from (
				select itemnumber,nvl(o_purchase_number,0) o_purchase_number
				  from dim_product t,(select product_key,sum(o_purchase_number) o_purchase_number 
				  					   from 
				  					(select t1.product_key,count(distinct t1.member_key) o_purchase_number
							           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
							          where t1.date_key = dt.date_key
							            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		   								and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
									    and t1.access_terminal_key > 0
									    and t1.order_count > 0
							           <if test="access_terminal_id != null and access_terminal_id != ''">
									   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
									   </if>
									   <include refid="dw_public_psy_where"/>
									   group by t1.product_key,t1.access_terminal_key)
									   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by}) a)
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</when>
			<otherwise>
				select itemnumber
				  from (
				select a.*,rownum rn
				  from (
				select itemnumber,nvl(o_purchase_number,0) o_purchase_number
				  from dim_product t,(select product_key,sum(o_purchase_number) o_purchase_number from
				  					(select product_key,count(distinct member_key) o_purchase_number
				  					from (select t1.product_key,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
							           from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
							          where t1.create_date_key = dt.date_key
							            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		   								and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
							            <if test="access_terminal_id == 1">
									   and exists (select 1 from dim_order where payment_state = 2 and order_source in (2,3) and order_key = t1.order_key)
									   </if>
									   <if test="access_terminal_id == 2">
									   and exists (select 1 from dim_order where payment_state = 2 and order_source = 1 and order_key = t1.order_key)
									   </if>
									   <if test="access_terminal_id == 4">
									   and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
									   </if>
									   <if test="access_terminal_id == 31">
									   and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
									   </if>
									   <if test="access_terminal_id == 32">
									   and exists (select 1 from dim_order where payment_state = 2 and order_source = 4 and order_key = t1.order_key)
									   </if>
									   <include refid="dw_public_psy_where"/>)
									   group by product_key,access_terminal_key)
									   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by}) a)
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的商品信息-下单转化率 -->
	<select id="r_queryProduct_Zhl_Product" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select itemnumber
				  from (
				select a.*,rownum rn
				  from (
				select t.itemnumber, case when nvl(t2.purchase_number,0) = 0 or nvl(t1.visitor_count,0) = 0  then 0
							else nvl(t2.purchase_number,0)/nvl(t1.visitor_count,0) end o_zhl
				from dim_product t,
				(select product_key,nvl(sum(visitor_count),0) visitor_count
				  from (
				select t1.product_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log_product_pv_d t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
		           group by product_key) t1,
		       (select product_key,nvl(sum(purchase_number),0) purchase_number
				  from (
				select t1.product_key,count(distinct t1.member_key) purchase_number
		           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
		          where t1.date_key = dt.date_key
		            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				    and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				    and t1.access_terminal_key > 0
				    and t1.order_count > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
		           group by product_key) t2
		         where t.product_key = t1.product_key(+)
		           and t.product_key = t2.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by}) a)
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</when>
			<otherwise>
				select itemnumber
				  from (
				select a.*,rownum rn
				  from (
				select t.itemnumber, case when nvl(t2.purchase_number,0) = 0 or nvl(t1.visitor_count,0) = 0  then 0
							else nvl(t2.purchase_number,0)/nvl(t1.visitor_count,0) end o_zhl
				from dim_product t,
				(select product_key,nvl(sum(visitor_count),0) visitor_count
				  from (
				select t1.product_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log_product t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
		           group by product_key) t1,
		       (select product_key,nvl(sum(purchase_number),0) purchase_number
				  from (select product_key,count(distinct member_key) purchase_number
				  from (select t1.product_key,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
		           from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
		          where t1.create_date_key = dt.date_key
		            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				    and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		            <if test="access_terminal_id == 1">
				   and exists (select 1 from dim_order where payment_state = 2 and order_source in (2,3) and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 2">
				   and exists (select 1 from dim_order where payment_state = 2 and order_source = 1 and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 4">
				   and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 31">
				   and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 32">
				   and exists (select 1 from dim_order where payment_state = 2 and order_source = 4 and order_key = t1.order_key)
				   </if>
				   <include refid="dw_public_psy_where"/>)
				   group by product_key,access_terminal_key)
		           group by product_key) t2
		         where t.product_key = t1.product_key(+)
		           and t.product_key = t2.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by}) a)
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的商品信息-支付买家数 -->
	<select id="r_queryProduct_PayPurchaseNumber_Product" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select itemnumber
				  from (
				select a.*,rownum rn
				  from (
				select itemnumber,nvl(p_purchase_number,0) p_purchase_number
				  from dim_product t,(select product_key,sum(p_purchase_number) p_purchase_number from
				  					(select t1.product_key,count(distinct t1.member_key) p_purchase_number
							           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
							          where t1.date_key = dt.date_key
							            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		   								and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
									    and t1.access_terminal_key > 0
									    and t1.pay_money > 0
							           <if test="access_terminal_id != null and access_terminal_id != ''">
									   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
									   </if>
									   <include refid="dw_public_psy_where"/>
									   group by t1.product_key,t1.access_terminal_key)
									   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by}) a)
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</when>
			<otherwise>
				select itemnumber
				  from (
				select a.*,rownum rn
				  from (
				select itemnumber,nvl(p_purchase_number,0) p_purchase_number
				  from dim_product t,(select product_key,sum(p_purchase_number) p_purchase_number from
				  					(select product_key,count(distinct member_key) p_purchase_number
				  					from (select t1.product_key,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
							           from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
							          where t1.payment_date_key = dt.date_key
							            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		   								and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
							            <if test="access_terminal_id == 1">
									   and exists (select 1 from dim_order where payment_state = 2 and order_source in (2,3) and order_key = t1.order_key)
									   </if>
									   <if test="access_terminal_id == 2">
									   and exists (select 1 from dim_order where payment_state = 2 and order_source = 1 and order_key = t1.order_key)
									   </if>
									   <if test="access_terminal_id == 4">
									   and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
									   </if>
									   <if test="access_terminal_id == 31">
									   and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
									   </if>
									   <if test="access_terminal_id == 32">
									   and exists (select 1 from dim_order where payment_state = 2 and order_source = 4 and order_key = t1.order_key)
									   </if>
									   <include refid="dw_public_psy_where"/>)
									   group by product_key,access_terminal_key)
									   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by}) a)
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的商品信息-支付转化率 -->
	<select id="r_queryProduct_PayZhl_Product" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select itemnumber
				  from (
				select a.*,rownum rn
				  from (
				select t.itemnumber, case when nvl(t2.purchase_number,0) = 0 or nvl(t1.visitor_count,0) = 0  then 0
							else nvl(t2.purchase_number,0)/nvl(t1.visitor_count,0) end p_zhl
				from dim_product t,
				(select product_key,nvl(sum(visitor_count),0) visitor_count
				  from (
				select t1.product_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log_product_pv_d t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
		           group by product_key) t1,
		       (select product_key,nvl(sum(purchase_number),0) purchase_number
				  from (
				select t1.product_key,count(distinct t1.member_key) purchase_number
		           from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
		          where t1.date_key = dt.date_key
		            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				    and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				    and t1.access_terminal_key > 0
				    and t1.pay_money > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
		           group by product_key) t2
		         where t.product_key = t1.product_key(+)
		           and t.product_key = t2.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by}) a)
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</when>
			<otherwise>
				select itemnumber
				  from (
				select a.*,rownum rn
				  from (
				select t.itemnumber, case when nvl(t2.purchase_number,0) = 0 or nvl(t1.visitor_count,0) = 0  then 0
							else nvl(t2.purchase_number,0)/nvl(t1.visitor_count,0) end p_zhl
				from dim_product t,
				(select product_key,nvl(sum(visitor_count),0) visitor_count
				  from (
				select t1.product_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log_product t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
		           group by product_key) t1,
		       (select product_key,nvl(sum(purchase_number),0) purchase_number
				  from (select product_key,count(distinct member_key) purchase_number
				  from (select t1.product_key,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
		           from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
		          where t1.payment_date_key = dt.date_key
		            and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				    and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		            <if test="access_terminal_id == 1">
				   and exists (select 1 from dim_order where payment_state = 2 and order_source in (2,3) and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 2">
				   and exists (select 1 from dim_order where payment_state = 2 and order_source = 1 and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 4">
				   and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 31">
				   and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 32">
				   and exists (select 1 from dim_order where payment_state = 2 and order_source = 4 and order_key = t1.order_key)
				   </if>
				   <include refid="dw_public_psy_where"/>)
				   group by product_key,access_terminal_key)
		           group by product_key) t2
		         where t.product_key = t1.product_key(+)
		           and t.product_key = t2.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by ${sort} ${sort_by}) a)
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 查询默认排序的商品信息 -->
	<select id="r_queryProductListBy_Default" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select itemnumber
				  from (
				select a.*,rownum rn
				  from (
				select t.itemnumber,nvl(t1.p_pv_count,0) p_pv_count
				  from dim_product t,(
				select product_key,sum(p_pv_count) p_pv_count from
				(select t1.product_key,t1.access_terminal_key,nvl(sum(t1.pv),0) p_pv_count
				  from fact_user_log_product_pv_d t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
				   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by p_pv_count desc) a )
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</when>
			<otherwise>
				select itemnumber
				  from (
				select a.*,rownum rn
				  from (
				select t.itemnumber,nvl(t1.p_pv_count,0) p_pv_count
				  from dim_product t,(
				select product_key,sum(p_pv_count) p_pv_count from
				(select t1.product_key,t1.access_terminal_key,count(*) p_pv_count
				  from fact_user_log_product t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by t1.product_key,t1.access_terminal_key)
				   group by product_key) t1
				 where t.product_key = t1.product_key(+)
		           <include refid="dw_public_ps_where"/>
		           order by p_pv_count desc) a )
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
							<!-- #################        访客分析         ################ -->
	<!-- 下单买家总数 -->
	<select id="r_queryPurchaseNumberTotal" parameterType="java.util.Map" resultType="long">
		<choose>
			<when test="query_type == 'other'">
				select nvl(sum(purchase_number),0)
				  from (
		     	select dm.user_company_address_province as province_id,t1.access_terminal_key,count(distinct t1.member_key) purchase_number
				  from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
		 		 where t1.date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
			   	   and t1.access_terminal_key > 0
				   and t1.order_count > 0
		   		   <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
				   group by dm.user_company_address_province,t1.access_terminal_key)
			</when>
			<otherwise>
				select nvl(sum(purchase_number),0)
				  from (
				select province_id,count(distinct member_key) purchase_number from
		     	(select dm.user_company_address_province as province_id,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
				  from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
		 		 where t1.create_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   <if test="access_terminal_id == 1">
				   and exists (select 1 from dim_order where payment_state = 2 and order_source in (2,3) and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 2">
				   and exists (select 1 from dim_order where payment_state = 2 and order_source = 1 and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 4">
				   and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 31">
				   and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 32">
				   and exists (select 1 from dim_order where payment_state = 2 and order_source = 4 and order_key = t1.order_key)
				   </if>
				   <include refid="dw_public_psy_where"/>)
				   group by province_id,access_terminal_key)
			</otherwise>
		</choose>
  	</select>
  	<!-- 省份 下单买家数 排行榜 -->
	<select id="r_queryPurchaseNumberProvince_Rank" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select case when a.province_id = 0 then '其他'
					   else (select name from dim_dic_region where region_id = a.province_id) end province_name,purchase_number
		  		  from (
		  		select province_id,nvl(sum(purchase_number),0) purchase_number
				  from (
				select dm.user_company_address_province as province_id,t1.access_terminal_key,count(distinct t1.member_key) purchase_number
				  from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
			   	   and t1.access_terminal_key > 0
				   and t1.order_count > 0
				   <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
					group by dm.user_company_address_province,t1.access_terminal_key)
				 group by province_id
				 order by purchase_number desc) a
				 where rownum &lt;=#{num,jdbcType=INTEGER}
			</when>
			<otherwise>
				select case when a.province_id = 0 then '其他'
					   else (select name from dim_dic_region where region_id = a.province_id) end province_name,purchase_number
		  		  from (
		  		select province_id,nvl(sum(purchase_number),0) purchase_number
				  from (
				select province_id,count(distinct member_key) purchase_number from
		     	(select dm.user_company_address_province as province_id,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
				  from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.create_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   <if test="access_terminal_id == 1">
				   and exists (select 1 from dim_order where payment_state = 2 and order_source in (2,3) and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 2">
				   and exists (select 1 from dim_order where payment_state = 2 and order_source = 1 and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 4">
				   and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 31">
				   and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 32">
				   and exists (select 1 from dim_order where payment_state = 2 and order_source = 4 and order_key = t1.order_key)
				   </if>
				   <include refid="dw_public_psy_where"/>)
					group by province_id,access_terminal_key)
				 group by province_id
				 order by purchase_number desc) a
				 where rownum &lt;=#{num,jdbcType=INTEGER}
			</otherwise>
		</choose>
  	</select>
  	<!-- 城市 下单买家数 排行榜 -->
  	<select id="r_queryPurchaseNumberCity_Rank" parameterType="java.util.Map" resultType="java.util.Map">
  		<choose>
  			<when test="query_type == 'other'">
  				select case when a.city_id = 0 then '其他'
  					   else (select name from dim_dic_region where region_id = a.city_id) end city_name,purchase_number
		  		  from (
		  		select city_id,nvl(sum(purchase_number),0) purchase_number
				  from (
				select dm.user_company_address_city as city_id,t1.access_terminal_key,count(distinct t1.member_key) purchase_number
				  from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
			   	   and t1.access_terminal_key > 0
				   and t1.order_count > 0
				   <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_psy_where"/>
					group by dm.user_company_address_city,t1.access_terminal_key)
				 group by city_id
				 order by purchase_number desc) a
				 where rownum &lt;=#{num,jdbcType=INTEGER}
  			</when>
  			<otherwise>
  				select case when a.city_id = 0 then '其他'
  					   else (select name from dim_dic_region where region_id = a.city_id) end city_name,purchase_number
		  		  from (
		  		select city_id,nvl(sum(purchase_number),0) purchase_number
				  from (
				select city_id,count(distinct member_key) purchase_number from
		     	(select dm.user_company_address_city as city_id,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
				  from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
				 where t1.create_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
				   <if test="access_terminal_id == 1">
				   and exists (select 1 from dim_order where payment_state = 2 and order_source in (2,3) and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 2">
				   and exists (select 1 from dim_order where payment_state = 2 and order_source = 1 and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 4">
				   and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 31">
				   and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
				   </if>
				   <if test="access_terminal_id == 32">
				   and exists (select 1 from dim_order where payment_state = 2 and order_source = 4 and order_key = t1.order_key)
				   </if>
				   <include refid="dw_public_psy_where"/>)
					group by city_id,access_terminal_key)
				 group by city_id
				 order by purchase_number desc) a
				 where rownum &lt;=#{num,jdbcType=INTEGER}
  			</otherwise>
  		</choose>
  	</select>
  	<!-- 全站访客总数 -->
	<select id="r_queryVisitorCountTotal" parameterType="java.util.Map" resultType="java.lang.Float">
		<choose>
			<when test="query_type == 'other'">
				select nvl(sum(visitor_count),0) visitor_count
				  from (
				select province_id,count(distinct member_key) visitor_count
				  from (
				select dm.user_company_address_province as province_id,t1.access_terminal_key,t1.member_key 
				  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>)
				   group by province_id,access_terminal_key)
			</when>
			<otherwise>
				select nvl(sum(visitor_count),0) visitor_count
				  from (
				select province_id,count(distinct member_key) visitor_count
				  from (
				select dm.user_company_address_province as province_id,t1.access_terminal_key,t1.member_key 
				  from fact_user_log t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>)
				   group by province_id,access_terminal_key)
			</otherwise>
		</choose>
  	</select>
  	<!-- 省份 全站访客数 排行榜 -->
	<select id="r_queryVisitorCountProvince_Rank" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select case when a.province_id = 0 then '其他' 
				 	   else (select name from dim_dic_region where region_id = a.province_id) end province_name,visitor_count
				  from (
				select province_id,nvl(sum(visitor_count),0) visitor_count
				  from (
				select dm.user_company_address_province as province_id,t1.access_terminal_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
				   group by dm.user_company_address_province,t1.access_terminal_key)
		           group by province_id
		           order by visitor_count desc) a
		           where rownum &lt;= #{num,jdbcType=INTEGER}
			</when>
			<otherwise>
				select case when a.province_id = 0 then '其他' 
				 	   else (select name from dim_dic_region where region_id = a.province_id) end province_name,visitor_count
				  from (
				select province_id,nvl(sum(visitor_count),0) visitor_count
				  from (
				select dm.user_company_address_province as province_id,t1.access_terminal_key,count(distinct t1.member_key) visitor_count
				  from fact_user_log t1,dim_date dt,dim_member dm
				 where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		   		   and t1.access_terminal_key > 0
		           <if test="access_terminal_id != null and access_terminal_id != ''">
				   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
				   </if>
				   <include refid="dw_public_py_where"/>
				   group by dm.user_company_address_province,t1.access_terminal_key)
		           group by province_id
		           order by visitor_count desc) a
		           where rownum &lt;= #{num,jdbcType=INTEGER}
			</otherwise>
		</choose>
  	</select>
  	<!-- 其他 区域分布明细 -->
  	<select id="r_queryAreaDetail" parameterType="java.util.Map" resultType="java.util.Map">
  		<if test="type == 1">
  			<choose>
  				<when test="query_type == 'other'">
  					select city_name,nvl(sum(visitor_count),0) visitor_count
					  from (
					select city_name,count(distinct member_key) visitor_count
					  from (
					select (select name from dim_dic_region where region_id = dm.user_company_address_city) as city_name,t1.access_terminal_key,t1.member_key 
					  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
					 where t1.log_date_key = dt.date_key
			           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				  	   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
			   		   and t1.access_terminal_key > 0
			           and dm.user_company_address_province = #{province_id,jdbcType=INTEGER}
			           and dm.user_company_address_city > 0
			           <if test="access_terminal_id != null and access_terminal_id != ''">
					   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
					   </if>
					   <include refid="dw_public_py_where"/>)
					   group by city_name,access_terminal_key)
			           group by city_name
  				</when>
  				<otherwise>
  					select city_name,nvl(sum(visitor_count),0) visitor_count
					  from (
					select city_name,count(distinct member_key) visitor_count
					  from (
					select (select name from dim_dic_region where region_id = dm.user_company_address_city) as city_name,t1.access_terminal_key,t1.member_key 
					  from fact_user_log t1,dim_date dt,dim_member dm
					 where t1.log_date_key = dt.date_key
			           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				  	   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
			   		   and t1.access_terminal_key > 0
			           and dm.user_company_address_province = #{province_id,jdbcType=INTEGER}
			           and dm.user_company_address_city > 0
			           <if test="access_terminal_id != null and access_terminal_id != ''">
					   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
					   </if>
					   <include refid="dw_public_py_where"/>)
					   group by city_name,access_terminal_key)
			           group by city_name
  				</otherwise>
  			</choose>
  		</if>
  		<if test="type == 2">
  			<choose>
  				<when test="query_type == 'other'">
  					select city_name,nvl(sum(purchase_number),0) purchase_number
					  from (
					select city_name,count(distinct member_key) purchase_number
					  from (
					select (select name from dim_dic_region where region_id = dm.user_company_address_city) as city_name,t1.access_terminal_key,t1.member_key
					  from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
					 where t1.date_key = dt.date_key
					   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   	   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
					   and dm.user_company_address_province = #{province_id,jdbcType=INTEGER}
					   and dm.user_company_address_city > 0
					   and t1.access_terminal_key > 0
					   and t1.order_count > 0
					   <include refid="dw_public_psy_where"/>)
					 group by city_name,access_terminal_key)
					 group by city_name
  				</when>
  				<otherwise>
  					select city_name,nvl(sum(purchase_number),0) purchase_number
					  from (
					select city_name,count(distinct member_key) purchase_number
					  from (
					select (select name from dim_dic_region where region_id = dm.user_company_address_city) as city_name,
						   (select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
					  from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
					 where t1.create_date_key = dt.date_key
					   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   	   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
					   and dm.user_company_address_province = #{province_id,jdbcType=INTEGER}
					   and dm.user_company_address_city > 0
					   <if test="access_terminal_id == 1">
					   and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
					   </if>
					   <if test="access_terminal_id == 2">
					   and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
					   </if>
					   <if test="access_terminal_id == 4">
					   and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
					   </if>
					   <if test="access_terminal_id == 31">
					   and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
					   </if>
					   <if test="access_terminal_id == 32">
					   and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
					   </if>
					   <include refid="dw_public_psy_where"/>)
					 group by city_name,access_terminal_key)
					 group by city_name
  				</otherwise>
  			</choose>
  		</if>
  	</select>
  	<resultMap type="java.util.Map" id="areaMap">
  		<result column="id" property="id"/>
  		<result column="name" property="name"/>
  		<result column="value" property="value"/>
  	</resultMap>
  	<!-- 其他 区域分布地图 -->
  	<select id="r_queryAreaMap" parameterType="java.util.Map" resultMap="areaMap">
  		<if test="type == 1">
	  		<choose>
	  			<when test="query_type == 'other'">
	  				select t.region_id as id,
			  			   t.name,
			  			   nvl(t1.visitor_count,0) as value
			  		  from dim_dic_region t,(select province_id,nvl(sum(visitor_count),0) visitor_count
											  from (
											select province_id,count(distinct member_key) visitor_count
											  from (
											select dm.user_company_address_province as province_id,t1.access_terminal_key,t1.member_key 
											  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
											 where t1.log_date_key = dt.date_key
									           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   	   						   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
									           and dm.user_company_address_province > 0
									           and dm.user_company_address_city > 0
									           and t1.access_terminal_key > 0
									           <if test="access_terminal_id != null and access_terminal_id != ''">
											   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
											   </if>
											   <include refid="dw_public_py_where"/>)
											   group by province_id,access_terminal_key)
									           group by province_id) t1
				      where t.parent_id in (select region_id from dim_dic_region where parent_id = 0)
					    and t.region_id = t1.province_id(+)
	  			</when>
	  			<otherwise>
	  				select t.region_id as id,
			  			   t.name,
			  			   nvl(t1.visitor_count,0) as value
			  		  from dim_dic_region t,(select province_id,nvl(sum(visitor_count),0) visitor_count
											  from (
											select province_id,count(distinct member_key) visitor_count
											  from (
											select dm.user_company_address_province as province_id,t1.access_terminal_key,t1.member_key 
											  from fact_user_log t1,dim_date dt,dim_member dm
											 where t1.log_date_key = dt.date_key
									           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   	   						   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
									   		   and t1.access_terminal_key > 0
									           and dm.user_company_address_province > 0
									           and dm.user_company_address_city > 0
									           <if test="access_terminal_id != null and access_terminal_id != ''">
											   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
											   </if>
											   <include refid="dw_public_py_where"/>)
											   group by province_id,access_terminal_key)
									           group by province_id) t1
				      where t.parent_id in (select region_id from dim_dic_region where parent_id = 0)
					    and t.region_id = t1.province_id(+)
	  			</otherwise>
	  		</choose>
  		</if>
  		<if test="type == 2">
  			<choose>
  				<when test="query_type == 'other'">
  					select t.region_id as id,
		  			   	   t.name,
		  			  	   nvl(t1.purchase_number,0) as value
			  		  from dim_dic_region t,(select province_id,nvl(sum(purchase_number),0) purchase_number
											  from (
											select province_id,count(distinct member_key) purchase_number from
											(select dm.user_company_address_province as province_id,t1.access_terminal_key,t1.member_key
											  from fact_product_sale_d t1,dim_date dt,dim_product dp,dim_member dm
											 where t1.date_key = dt.date_key
									           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   	   						   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
											   and dm.user_company_address_province > 0
											   and dm.user_company_address_city > 0
											   and t1.access_terminal_key > 0
											   and t1.order_count > 0
											   <if test="access_terminal_id != null and access_terminal_id != ''">
											   	and exists (select 1 from dim_access_terminal where access_terminal_id = #{access_terminal_id,jdbcType=INTEGER} and access_terminal_key = t1.access_terminal_key)
											   </if>
											   <include refid="dw_public_psy_where"/>)
												group by province_id,access_terminal_key)
											 group by province_id) t1
				      where t.parent_id in (select region_id from dim_dic_region where parent_id = 0)
					    and t.region_id = t1.province_id(+)
  				</when>
  				<otherwise>
  					select t.region_id as id,
		  			   	   t.name,
		  			  	   nvl(t1.purchase_number,0) as value
			  		  from dim_dic_region t,(select province_id,nvl(sum(purchase_number),0) purchase_number
											  from (
											select province_id,count(distinct member_key) purchase_number from
											(select dm.user_company_address_province as province_id,(select decode (order_source,1,2,2,1,3,1,4,4,5,3,6,5) from dim_order where order_key = t1.order_key) access_terminal_key,t1.member_key
											  from fact_order_product_sku t1,dim_date dt,dim_product dp,dim_member dm
											 where t1.create_date_key = dt.date_key
									           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   	   						   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
											   and dm.user_company_address_province > 0
											   and dm.user_company_address_city > 0
											   <if test="access_terminal_id == 1">
											   and exists (select 1 from dim_order where order_source in (2,3) and order_key = t1.order_key)
											   </if>
											   <if test="access_terminal_id == 2">
											   and exists (select 1 from dim_order where order_source = 1 and order_key = t1.order_key)
											   </if>
											   <if test="access_terminal_id == 4">
											   and exists (select 1 from dim_order where order_source = 6 and order_key = t1.order_key)
											   </if>
											   <if test="access_terminal_id == 31">
											   and exists (select 1 from dim_order where order_source = 5 and order_key = t1.order_key)
											   </if>
											   <if test="access_terminal_id == 32">
											   and exists (select 1 from dim_order where order_source = 4 and order_key = t1.order_key)
											   </if>
											   <include refid="dw_public_psy_where"/>)
												group by province_id,access_terminal_key)
											 group by province_id) t1
				      where t.parent_id in (select region_id from dim_dic_region where parent_id = 0)
					    and t.region_id = t1.province_id(+)
  				</otherwise>
  			</choose>
  		</if>
  	</select>
  							<!-- #################        流量来源         ################ -->
  	<!-- 访问设备 -->
	<select id="r_queryFacility_Chart" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select page_name,nvl(sum(cnt),0) cnt
				  from (
				select decode(t.access_terminal_id,1,'PC',2,'手机',31,'手机',32,'手机',4,'PDA') as page_name,
		  			   nvl(t1.visitor_count,0) as cnt
		  		  from dim_access_terminal t,(select t1.access_terminal_key,count(distinct t1.member_key) visitor_count
											  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
											 where t1.log_date_key = dt.date_key
									           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   	   						   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
									   		   and t1.access_terminal_key > 0
									   		   <include refid="dw_public_py_where"/>
											   group by t1.access_terminal_key) t1
			     where t.access_terminal_key = t1.access_terminal_key(+))
			     group by page_name
			</when>
			<otherwise>
				select page_name,nvl(sum(cnt),0) cnt
				  from (
				select decode(t.access_terminal_id,1,'PC',2,'手机',31,'手机',32,'手机',4,'PDA') as page_name,
		  			   nvl(t1.visitor_count,0) as cnt
		  		  from dim_access_terminal t,(select t1.access_terminal_key,count(distinct t1.member_key) visitor_count
											  from fact_user_log t1,dim_date dt,dim_member dm
											 where t1.log_date_key = dt.date_key
									           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   	   						   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
									   		   and t1.access_terminal_key > 0
									   		   <include refid="dw_public_py_where"/>
											   group by t1.access_terminal_key) t1
			     where t.access_terminal_key = t1.access_terminal_key(+))
			     group by page_name
			</otherwise>
		</choose>
	</select>
	<!-- 移动端分布 -->
	<select id="r_queryMobileTerminalChart" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select page_name,nvl(sum(cnt),0) cnt
				  from (
				select decode(t.access_terminal_id,2,'微信',31,'ANDROID',32,'IOS',4,'PDA') as page_name,
		  			   nvl(t1.visitor_count,0) as cnt
		  		  from dim_access_terminal t,(select t1.access_terminal_key,count(distinct t1.member_key) visitor_count
											  from fact_user_log_pv_d t1,dim_date dt,dim_member dm
											 where t1.log_date_key = dt.date_key
									           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   	   						   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
									   		   and t1.access_terminal_key > 0
									   		   <include refid="dw_public_py_where"/>
											   group by t1.access_terminal_key) t1
			     where t.access_terminal_key = t1.access_terminal_key(+)
			       and t.access_terminal_id != 1)
			     group by page_name
			</when>
			<otherwise>
				select page_name,nvl(sum(cnt),0) cnt
				  from (
				select decode(t.access_terminal_id,2,'微信',31,'ANDROID',32,'IOS',4,'PDA') as page_name,
		  			   nvl(t1.visitor_count,0) as cnt
		  		  from dim_access_terminal t,(select t1.access_terminal_key,count(distinct t1.member_key) visitor_count
											  from fact_user_log t1,dim_date dt,dim_member dm
											 where t1.log_date_key = dt.date_key
									           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   	   						   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
									   		   and t1.access_terminal_key > 0
									   		   <include refid="dw_public_py_where"/>
											   group by t1.access_terminal_key) t1
			     where t.access_terminal_key = t1.access_terminal_key(+)
			       and t.access_terminal_id != 1)
			     group by page_name
			</otherwise>
		</choose>
	</select>
	<!-- 手机品牌 折线 -->
	<select id="r_queryMobileBrandChart" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select dd.access_device_brand_name as page_name,nvl(t1.visitor_count,0) cnt
		          from (select access_device_brand,access_device_brand_name
		                  from dim_access_device
		                 where access_type in ('ANDROID','IOS')
		                 group by access_device_brand,access_device_brand_name) dd,
					   (select dd.access_device_brand, count(distinct t1.member_key) visitor_count
						  from fact_user_log_pv_d t1,dim_date dt,dim_access_device dd,dim_member dm
						where t1.log_date_key = dt.date_key
						   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
						   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
						   and t1.access_device_key = dd.access_device_key
						   and dd.access_type in ('ANDROID','IOS')
						   <include refid="dw_public_py_where"/>
						   group by dd.access_device_brand) t1
						where dd.access_device_brand = t1.access_device_brand(+)
			</when>
			<otherwise>
			 	select dd.access_device_brand_name as page_name,nvl(t1.visitor_count,0) cnt
		          from (select access_device_brand,access_device_brand_name
		                  from dim_access_device
		                 where access_type in ('ANDROID','IOS')
		                 group by access_device_brand,access_device_brand_name) dd,
					   (select dd.access_device_brand, count(distinct t1.member_key) visitor_count
						  from fact_user_log t1,dim_date dt,dim_access_device dd,dim_member dm
						where t1.log_date_key = dt.date_key
						   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
						   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
						   and t1.access_device_key = dd.access_device_key
						   and dd.access_type in ('ANDROID','IOS')
						   <include refid="dw_public_py_where"/>
						   group by dd.access_device_brand) t1
						where dd.access_device_brand = t1.access_device_brand(+)
			</otherwise>
		</choose>
	</select>
	<!-- 手机品牌总数 -->
	<select id="r_queryMobileBrandCount" parameterType="java.util.Map" resultType="int">
		select count(distinct access_device_brand)
		  from dim_access_device
		 where access_type in ('ANDROID','IOS')
	</select>
	<!-- 查询默认排序的手机品牌 -->
	<select id="r_queryMobileBrandListBy_Default" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select access_device_brand
				  from (
				select a.*,rownum rn
	         	  from (
	         	select dd.access_device_brand,nvl(t1.visitor_count,0) visitor_count
		          from (select access_device_brand
		                  from dim_access_device
		                 where access_type in ('ANDROID','IOS')
		                 group by access_device_brand) dd,
		               (select dd.access_device_brand, count(distinct t1.member_key) visitor_count
		                  from fact_user_log_pv_d t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_type in ('ANDROID','IOS')
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_brand) t1
		          where dd.access_device_brand = t1.access_device_brand(+)
		            order by visitor_count desc) a )
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</when>
			<otherwise>
				select access_device_brand
				  from (
				select a.*,rownum rn
	         	  from (
	         	select dd.access_device_brand,nvl(t1.visitor_count,0) visitor_count
		          from (select access_device_brand
		                  from dim_access_device
		                 where access_type in ('ANDROID','IOS')
		                 group by access_device_brand) dd,
		               (select dd.access_device_brand, count(distinct t1.member_key) visitor_count
		                  from fact_user_log t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_type in ('ANDROID','IOS')
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_brand) t1
		          where dd.access_device_brand = t1.access_device_brand(+)
		            order by visitor_count desc) a )
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 手机品牌列表 -->
	<select id="r_queryMobileBrandList" parameterType="java.util.Map" resultType="java.util.Map">
		select access_device_brand,access_device_brand_name
		 from (select access_device_brand,access_device_brand_name
                 from dim_access_device
                where access_type in ('ANDROID','IOS')
                group by access_device_brand,access_device_brand_name) dd
		 where dd.access_device_brand in 
		 <foreach collection="mobileBrandList" item="item" open="(" close=")" separator=",">
            #{item,jdbcType=VARCHAR}
         </foreach>
		 order by decode(dd.access_device_brand
		 <foreach collection="mobileBrandList" item="item" index="_index" open="," close="" separator=",">
            #{item},${_index}
         </foreach>)
	</select>
	<!-- 排序获取某一页的手机品牌列表-访问人数 -->
	<select id="r_queryMobileBrand_VisitorCount" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select access_device_brand
				  from (
				select a.*,rownum rn
	         	  from (
	         	select dd.access_device_brand,nvl(t1.visitor_count,0) visitor_count
		          from (select access_device_brand
		                  from dim_access_device
		                 where access_type in ('ANDROID','IOS')
		                 group by access_device_brand) dd,
		               (select dd.access_device_brand, count(distinct t1.member_key) visitor_count
		                  from fact_user_log_pv_d t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_type in ('ANDROID','IOS')
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_brand) t1
		          where dd.access_device_brand = t1.access_device_brand(+)
		            order by ${sort} ${sort_by}) a )
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</when>
			<otherwise>
				select access_device_brand
				  from (
				select a.*,rownum rn
	         	  from (
	         	select dd.access_device_brand,nvl(t1.visitor_count,0) visitor_count
		          from (select access_device_brand
		                  from dim_access_device
		                 where access_type in ('ANDROID','IOS')
		                 group by access_device_brand) dd,
		               (select dd.access_device_brand, count(distinct t1.member_key) visitor_count
		                  from fact_user_log t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_type in ('ANDROID','IOS')
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_brand) t1
		          where dd.access_device_brand = t1.access_device_brand(+)
		            order by ${sort} ${sort_by}) a )
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的手机品牌列表-访问次数 -->
	<select id="r_queryMobileBrand_PvCount" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select access_device_brand
				  from (
				select a.*,rownum rn
	         	  from (
	         	select dd.access_device_brand,nvl(t1.pv_count,0) pv_count
		          from (select access_device_brand
		                  from dim_access_device
		                 where access_type in ('ANDROID','IOS')
		                 group by access_device_brand) dd,
		               (select dd.access_device_brand, nvl(sum(t1.pv),0) pv_count
		                  from fact_user_log_pv_d t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_type in ('ANDROID','IOS')
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_brand) t1
		          where dd.access_device_brand = t1.access_device_brand(+)
		            order by ${sort} ${sort_by}) a )
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</when>
			<otherwise>
				select access_device_brand
				  from (
				select a.*,rownum rn
	         	  from (
	         	select dd.access_device_brand,nvl(t1.pv_count,0) pv_count
		          from (select access_device_brand
		                  from dim_access_device
		                 where access_type in ('ANDROID','IOS')
		                 group by access_device_brand) dd,
		               (select dd.access_device_brand, count(*) pv_count
		                  from fact_user_log t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_type in ('ANDROID','IOS')
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_brand) t1
		          where dd.access_device_brand = t1.access_device_brand(+)
		            order by ${sort} ${sort_by}) a )
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的手机品牌列表-每次平均停留时长 -->
	<select id="r_queryMobileBrand_TimeAvg" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select access_device_brand
				  from (
				select a.*,rownum rn
	         	  from (
	         	select dd.access_device_brand, case when nvl(t1.time_on_page,0) = 0 or nvl(t1.pv_count,0) = 0 then 0 else nvl(t1.time_on_page,0)/nvl(t1.pv_count,0) end time_avg
		          from (select access_device_brand
		                  from dim_access_device
		                 where access_type in ('ANDROID','IOS')
		                 group by access_device_brand) dd,
		               (select dd.access_device_brand, nvl(sum(t1.pv),0) pv_count,nvl(sum(t1.time_on_page),0) time_on_page
		                  from fact_user_log_pv_d t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_type in ('ANDROID','IOS')
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_brand) t1
		          where dd.access_device_brand = t1.access_device_brand(+)
		            order by ${sort} ${sort_by}) a )
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</when>
			<otherwise>
				select access_device_brand
				  from (
				select a.*,rownum rn
	         	  from (
	         	select dd.access_device_brand,case when nvl(t1.time_on_page,0) = 0 or nvl(t1.pv_count,0) = 0 then 0 else nvl(t1.time_on_page,0)/nvl(t1.pv_count,0) end time_avg
		          from (select access_device_brand
		                  from dim_access_device
		                 where access_type in ('ANDROID','IOS')
		                 group by access_device_brand) dd,
		               (select dd.access_device_brand, count(*) pv_count,nvl(sum(t1.time_on_page),0) time_on_page
		                  from fact_user_log t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_type in ('ANDROID','IOS')
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_brand) t1
		          where dd.access_device_brand = t1.access_device_brand(+)
		            order by ${sort} ${sort_by}) a )
				where rn &lt;= #{end_rownum,jdbcType=INTEGER} and rn &gt;#{start_rownum,jdbcType=INTEGER}
			</otherwise>
		</choose>
	</select>
	<!-- 查询手机品牌日志信息 -->
	<select id="r_queryMobileBrand_LogInfo" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select dd.access_device_brand, count(distinct t1.member_key) visitor_count,nvl(sum(t1.pv),0) pv_count,nvl(sum(t1.time_on_page),0) time_on_page
		          from fact_user_log_pv_d t1,dim_date dt,dim_access_device dd,dim_member dm
		         where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		  		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_device_key = dd.access_device_key
		           and dd.access_type in ('ANDROID','IOS')
		           and dd.access_device_brand in
		           <foreach collection="mobileBrandList" item="item" open="(" close=")" separator=",">
		            #{item,jdbcType=VARCHAR}
		           </foreach>
		           <include refid="dw_public_py_where"/>
		           group by dd.access_device_brand
			</when>
			<otherwise>
				select dd.access_device_brand, count(distinct t1.member_key) visitor_count,count(*) pv_count,nvl(sum(t1.time_on_page),0) time_on_page
		          from fact_user_log t1,dim_date dt,dim_access_device dd,dim_member dm
		         where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		  		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_device_key = dd.access_device_key
		           and dd.access_type in ('ANDROID','IOS')
		           and dd.access_device_brand in
		           <foreach collection="mobileBrandList" item="item" open="(" close=")" separator=",">
		            #{item,jdbcType=VARCHAR}
		           </foreach>
		           <include refid="dw_public_py_where"/>
		           group by dd.access_device_brand
			</otherwise>
		</choose>
	</select>
	<!-- 查询默认排序的手机型号 -->
	<select id="r_queryMobileModelListBy_Default" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select access_device_model
	         	  from (
	         	select dd.access_device_model,nvl(t1.visitor_count,0) visitor_count
		          from (select access_device_model
		                  from dim_access_device
		                 where access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                 group by access_device_model) dd,
		               (select dd.access_device_model, count(distinct t1.member_key) visitor_count
		                  from fact_user_log_pv_d t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_model) t1
		          where dd.access_device_model = t1.access_device_model(+)
		            order by visitor_count desc)
			</when>
			<otherwise>
				select access_device_model
	         	  from (
	         	select dd.access_device_model,nvl(t1.visitor_count,0) visitor_count
		          from (select access_device_model
		                  from dim_access_device
		                 where access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                 group by access_device_model) dd,
		               (select dd.access_device_model, count(distinct t1.member_key) visitor_count
		                  from fact_user_log t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_model) t1
		          where dd.access_device_model = t1.access_device_model(+)
		            order by visitor_count desc) 
			</otherwise>
		</choose>
	</select>
	<!-- 手机型号列表 -->
	<select id="r_queryMobileModelList" parameterType="java.util.Map" resultType="java.util.Map">
		select dd.access_device_model
		 from (select access_device_model
                 from dim_access_device
                where access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
                group by access_device_model) dd
		 where dd.access_device_model in 
		 <foreach collection="mobileModelList" item="item" open="(" close=")" separator=",">
            #{item,jdbcType=VARCHAR}
         </foreach>
		 order by decode(dd.access_device_model
		 <foreach collection="mobileModelList" item="item" index="_index" open="," close="" separator=",">
            #{item},${_index}
         </foreach>)
	</select>
	<!-- 排序获取某一页的手机型号列表-访问人数 -->
	<select id="r_queryMobileModel_VisitorCount" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select access_device_model
				  from (
	         	select dd.access_device_model,nvl(t1.visitor_count,0) visitor_count
		          from (select access_device_model
		                  from dim_access_device
		                 where access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                 group by access_device_model) dd,
		               (select dd.access_device_model, count(distinct t1.member_key) visitor_count
		                  from fact_user_log_pv_d t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_model) t1
		          where dd.access_device_model = t1.access_device_model(+)
		            order by ${sort} ${sort_by})
			</when>
			<otherwise>
				select access_device_model
				  from (
	         	select dd.access_device_model,nvl(t1.visitor_count,0) visitor_count
		          from (select access_device_model
		                  from dim_access_device
		                 where access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                 group by access_device_model) dd,
		               (select dd.access_device_model, count(distinct t1.member_key) visitor_count
		                  from fact_user_log t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_model) t1
		          where dd.access_device_model = t1.access_device_model(+)
		            order by ${sort} ${sort_by})
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的手机型号列表-访问次数 -->
	<select id="r_queryMobileModel_PvCount" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select access_device_model
				  from (
	         	select dd.access_device_model,nvl(t1.pv_count,0) pv_count
		          from (select access_device_model
		                  from dim_access_device
		                 where access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                 group by access_device_model) dd,
		               (select dd.access_device_model, nvl(sum(t1.pv),0) pv_count
		                  from fact_user_log_pv_d t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_model) t1
		          where dd.access_device_model = t1.access_device_model(+)
		            order by ${sort} ${sort_by}) 
			</when>
			<otherwise>
				select access_device_model
				  from (
	         	select dd.access_device_model,nvl(t1.pv_count,0) pv_count
		          from (select access_device_model
		                  from dim_access_device
		                 where access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                 group by access_device_model) dd,
		               (select dd.access_device_model, count(*) pv_count
		                  from fact_user_log t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_model) t1
		          where dd.access_device_model = t1.access_device_model(+)
		            order by ${sort} ${sort_by})
			</otherwise>
		</choose>
	</select>
	<!-- 排序获取某一页的手机型号列表-每次平均停留时长 -->
	<select id="r_queryMobileModel_TimeAvg" parameterType="java.util.Map" resultType="string">
		<choose>
			<when test="query_type == 'other'">
				select access_device_model
				  from (
	         	select dd.access_device_model,case when nvl(t1.time_on_page,0) = 0 or nvl(t1.pv_count,0) = 0 then 0 else nvl(t1.time_on_page,0)/nvl(t1.pv_count,0) end time_avg
		          from (select access_device_model
		                  from dim_access_device
		                 where access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                 group by access_device_model) dd,
		               (select dd.access_device_model, nvl(sum(t1.pv),0) pv_count,nvl(sum(t1.time_on_page),0) time_on_page
		                  from fact_user_log_pv_d t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_model) t1
		          where dd.access_device_model = t1.access_device_model(+)
		            order by ${sort} ${sort_by}) 
			</when>
			<otherwise>
				select access_device_model
				  from (
	         	select dd.access_device_model,case when nvl(t1.time_on_page,0) = 0 or nvl(t1.pv_count,0) = 0 then 0 else nvl(t1.time_on_page,0)/nvl(t1.pv_count,0) end time_avg
		          from (select access_device_model
		                  from dim_access_device
		                 where access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                 group by access_device_model) dd,
		               (select dd.access_device_model, count(*) pv_count,nvl(sum(t1.time_on_page),0) time_on_page
		                  from fact_user_log t1,dim_date dt,dim_access_device dd,dim_member dm
		                 where t1.log_date_key = dt.date_key
		                   and dt.date_short >= #{start_date,jdbcType=VARCHAR}
				   		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		                   and t1.access_device_key = dd.access_device_key
		                   and dd.access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		                   <include refid="dw_public_py_where"/>
		                   group by dd.access_device_model) t1
		          where dd.access_device_model = t1.access_device_model(+)
		            order by ${sort} ${sort_by}) 
			</otherwise>
		</choose>
	</select>
	<!-- 查询手机型号日志信息 -->
	<select id="r_queryMobileModel_LogInfo" parameterType="java.util.Map" resultType="java.util.Map">
		<choose>
			<when test="query_type == 'other'">
				select dd.access_device_model, count(distinct t1.member_key) visitor_count,nvl(sum(t1.pv),0) pv_count,nvl(sum(t1.time_on_page),0) time_on_page
		          from fact_user_log_pv_d t1,dim_date dt,dim_access_device dd,dim_member dm
		         where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		  		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_device_key = dd.access_device_key
		           and dd.access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		           and dd.access_device_model in
		           <foreach collection="mobileModelList" item="item" open="(" close=")" separator=",">
		            #{item,jdbcType=VARCHAR}
		           </foreach>
		           <include refid="dw_public_py_where"/>
		           group by dd.access_device_model
			</when>
			<otherwise>
				select dd.access_device_model, count(distinct t1.member_key) visitor_count,count(*) pv_count,nvl(sum(t1.time_on_page),0) time_on_page
		          from fact_user_log t1,dim_date dt,dim_access_device dd,dim_member dm
		         where t1.log_date_key = dt.date_key
		           and dt.date_short >= #{start_date,jdbcType=VARCHAR}
		  		   and dt.date_short &lt;= #{end_date,jdbcType=VARCHAR}
		           and t1.access_device_key = dd.access_device_key
		           and dd.access_device_brand = #{access_device_brand,jdbcType=VARCHAR}
		           and dd.access_device_model in
		           <foreach collection="mobileModelList" item="item" open="(" close=")" separator=",">
		            #{item,jdbcType=VARCHAR}
		           </foreach>
		           <include refid="dw_public_py_where"/>
		           group by dd.access_device_model
			</otherwise>
		</choose>
	</select>
</mapper>